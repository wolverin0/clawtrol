<div data-controller="factory" class="p-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-content">üè≠ Factory</h1>
      <p class="text-sm text-content-secondary">Perpetual agent loops and cycle metrics.</p>
    </div>
    <button class="px-3 py-2 rounded-md bg-bg-elevated text-content-secondary hover:text-content" data-action="click->factory#openModal">+ Create Loop</button>
  </div>

  <div class="flex items-center gap-6 text-sm">
    <div>Selected: <span data-factory-target="count">0</span></div>
    <div>Playing: <span data-factory-target="playing">0</span></div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
    <% @loops.each do |loop| %>
      <div class="rounded-lg border border-border bg-bg-surface p-4 cursor-pointer hover:border-content-muted" data-action="click->factory#toggle" data-factory-target="card" data-loop-id="<%= loop.id %>" data-status="<%= loop.status %>">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-lg font-medium text-content"><%= loop.icon.presence || "üè≠" %> <%= loop.name %></div>
            <div class="text-xs text-content-secondary"><%= loop.slug %></div>
          </div>
          <span class="text-xs px-2 py-1 rounded bg-bg-elevated" data-factory-status><%= loop.status %></span>
        </div>

        <p class="text-sm text-content-secondary mt-2 min-h-[40px]"><%= loop.description %></p>

        <div class="grid grid-cols-3 gap-2 mt-3 text-xs">
          <div class="rounded bg-bg-elevated p-2">Cycles<br><span class="text-content" data-factory-cycles><%= loop.total_cycles || 0 %></span></div>
          <div class="rounded bg-bg-elevated p-2">Errors<br><span class="text-content" data-factory-errors><%= loop.total_errors || 0 %></span></div>
          <div class="rounded bg-bg-elevated p-2">Avg ms<br><span class="text-content" data-factory-avg><%= loop.avg_cycle_duration_ms || 0 %></span></div>
        </div>

        <div class="flex items-center gap-2 mt-4" data-action="click->factory#overlayClose">
          <button class="px-2 py-1 text-xs rounded border border-border hover:border-content-muted" data-loop-id="<%= loop.id %>" data-action="click->factory#play">‚ñ∂ Play</button>
          <button class="px-2 py-1 text-xs rounded border border-border hover:border-content-muted" data-loop-id="<%= loop.id %>" data-action="click->factory#pause">‚è∏ Pause</button>
          <button class="px-2 py-1 text-xs rounded border border-border hover:border-content-muted" data-loop-id="<%= loop.id %>" data-action="click->factory#stop">‚èπ Stop</button>
        </div>
      </div>
    <% end %>
  </div>

  <div class="hidden fixed inset-0 bg-black/70 z-50 items-center justify-center" data-factory-target="modal" data-action="click->factory#overlayClose">
    <div class="w-full max-w-xl rounded-lg border border-border bg-bg-surface p-6" data-action="click->factory#stopPropagation">
      <h2 class="text-lg font-semibold text-content mb-4">Create Factory Loop</h2>
      <%= form_with url: factory_loops_path, method: :post, local: true, class: "space-y-3" do |f| %>
        <div>
          <label class="block text-xs text-content-secondary mb-1">Name</label>
          <%= f.text_field :name, name: "factory_loop[name]", class: "w-full rounded border border-border bg-bg-base px-3 py-2" %>
        </div>
        <div>
          <label class="block text-xs text-content-secondary mb-1">Slug</label>
          <%= f.text_field :slug, name: "factory_loop[slug]", class: "w-full rounded border border-border bg-bg-base px-3 py-2" %>
        </div>
        <div>
          <label class="block text-xs text-content-secondary mb-1">Description</label>
          <%= f.text_area :description, name: "factory_loop[description]", class: "w-full rounded border border-border bg-bg-base px-3 py-2" %>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-content-secondary mb-1">Interval (ms)</label>
            <%= f.number_field :interval_ms, name: "factory_loop[interval_ms]", value: 900000, class: "w-full rounded border border-border bg-bg-base px-3 py-2" %>
          </div>
          <div>
            <label class="block text-xs text-content-secondary mb-1">Model</label>
            <%= f.text_field :model, name: "factory_loop[model]", value: "anthropic/claude-opus-4-6", class: "w-full rounded border border-border bg-bg-base px-3 py-2" %>
          </div>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="px-3 py-2 rounded border border-border" data-action="click->factory#closeModal">Cancel</button>
          <button type="submit" class="px-3 py-2 rounded bg-bg-elevated">Create</button>
        </div>
      <% end %>
    </div>
  </div>
</div>
