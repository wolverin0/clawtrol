<% content_for :title, "Link Inbox - clawdeck" %>
<% content_for :breadcrumb_standalone, "üì• Link Inbox" %>

<div class="py-6 space-y-6">
  <%# Save Link Form %>
  <div class="bg-bg-elevated border border-border rounded-xl p-5">
    <%= form_with model: SavedLink.new, url: saved_links_path, class: "flex flex-col sm:flex-row gap-3" do |f| %>
      <div class="flex-1">
        <%= f.url_field :url, placeholder: "Paste a URL ‚Äî article, YouTube, X/Twitter, Reddit‚Ä¶",
            class: "w-full bg-bg-base border border-border rounded-lg px-4 py-3 text-content placeholder-content-muted focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition-colors",
            required: true, autofocus: true %>
      </div>
      <div class="flex gap-2 items-center">
        <%= f.text_field :note, placeholder: "Why is this interesting? (optional)",
            class: "bg-bg-base border border-border rounded-lg px-4 py-3 text-content placeholder-content-muted focus:outline-none focus:border-accent w-full sm:w-48" %>
        <div class="flex items-center gap-1 whitespace-nowrap">
          <%= f.check_box :audio_summary, class: "rounded border-border text-accent focus:ring-accent" %>
          <%= f.label :audio_summary, "üîä Audio", class: "text-sm text-content-muted" %>
        </div>
        <%= f.submit "Save Link", class: "bg-accent hover:bg-accent/80 text-white font-medium px-6 py-3 rounded-lg cursor-pointer transition-colors whitespace-nowrap" %>
      </div>
    <% end %>
  </div>

  <%# Stats %>
  <div class="flex gap-4 text-sm text-content-muted">
    <span><%= @saved_links.count %> links</span>
    <span>¬∑</span>
    <span><%= @saved_links.count(&:pending?) %> pending</span>
    <span>¬∑</span>
    <span><%= @saved_links.count(&:done?) %> processed</span>
  </div>

  <%# Process All Button %>
  <% pending_count = @saved_links.count(&:pending?) %>
  <% if pending_count > 0 %>
    <%= button_to "ü§ñ Process with Gemini", process_all_saved_links_path, method: :post,
        class: "bg-green-600 hover:bg-green-700 text-white font-medium px-4 py-2 rounded-lg transition-colors" %>
  <% end %>

  <%# Links List %>
  <% if @saved_links.any? %>
    <div class="space-y-3">
      <% @saved_links.each do |link| %>
        <div class="bg-bg-elevated border border-border rounded-xl p-4 hover:border-accent/30 transition-colors group">
          <div class="flex items-start gap-3">
            <%# Favicon %>
            <div class="flex-shrink-0 mt-1">
              <img src="https://www.google.com/s2/favicons?domain=<%= URI.parse(link.url).host rescue 'unknown' %>&sz=32"
                   alt="" class="w-6 h-6 rounded" loading="lazy"
                   onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 32 32%22><rect fill=%22%23333%22 width=%2232%22 height=%2232%22 rx=%224%22/><text x=%2216%22 y=%2222%22 text-anchor=%22middle%22 fill=%22%23888%22 font-size=%2218%22>üîó</text></svg>'">
            </div>

            <%# Content %>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <%# Source badge %>
                <% badge = case link.source_type
                     when "youtube" then "üé¨ YouTube"
                     when "x" then "üê¶ X"
                     when "reddit" then "ü§ñ Reddit"
                     else "üìÑ Article"
                   end %>
                <span class="text-xs px-2 py-0.5 rounded-full bg-bg-base border border-border text-content-muted"><%= badge %></span>

                <%# Status %>
                <% status_style = case link.status
                     when "pending" then "text-yellow-400"
                     when "processing" then "text-blue-400 animate-pulse"
                     when "done" then "text-green-400"
                     when "failed" then "text-red-400"
                   end %>
                <span class="text-xs <%= status_style %>">‚óè <%= link.status.capitalize %></span>

                <span class="text-xs text-content-muted"><%= time_ago_in_words(link.created_at) %> ago</span>
              </div>

              <div class="flex items-center gap-2 mt-1" id="note-display-<%= link.id %>">
                <a href="<%= link.url %>" target="_blank" rel="noopener" class="text-content hover:text-accent transition-colors truncate">
                  <%= link.note.present? ? link.note : link.url %>
                </a>
                <button onclick="document.getElementById('note-display-<%= link.id %>').classList.add('hidden'); document.getElementById('note-edit-<%= link.id %>').classList.remove('hidden'); document.getElementById('note-input-<%= link.id %>').focus();"
                        class="flex-shrink-0 text-content-muted hover:text-accent transition-colors p-0.5 opacity-0 group-hover:opacity-100" title="Edit note">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                  </svg>
                </button>
              </div>
              <%= form_with model: link, url: saved_link_path(link), method: :patch, class: "hidden mt-1 flex gap-2 items-center", id: "note-edit-#{link.id}" do |f| %>
                <%= f.text_field :note, value: link.note, placeholder: "Why is this interesting?",
                    id: "note-input-#{link.id}",
                    class: "flex-1 bg-bg-base border border-accent rounded-lg px-3 py-1.5 text-sm text-content placeholder-content-muted focus:outline-none focus:ring-1 focus:ring-accent" %>
                <div class="flex items-center gap-1 whitespace-nowrap">
                  <%= f.check_box :audio_summary, class: "rounded border-border text-accent focus:ring-accent" %>
                  <%= f.label :audio_summary, "üîä", class: "text-xs text-content-muted" %>
                </div>
                <%= f.submit "Save", class: "bg-accent hover:bg-accent/80 text-white text-xs font-medium px-3 py-1.5 rounded-lg cursor-pointer transition-colors" %>
                <button type="button" onclick="document.getElementById('note-edit-<%= link.id %>').classList.add('hidden'); document.getElementById('note-display-<%= link.id %>').classList.remove('hidden');"
                        class="text-content-muted hover:text-content text-xs px-2 py-1.5 transition-colors">Cancel</button>
              <% end %>
              <% if link.note.present? %>
                <div class="text-xs text-content-muted truncate mt-0.5"><%= link.url %></div>
              <% end %>

              <%# Expandable summary %>
              <% if link.done? && link.summary.present? %>
                <details class="mt-2">
                  <summary class="text-xs text-accent cursor-pointer hover:underline">View Summary</summary>
                  <div class="mt-2 text-sm text-content-muted bg-bg-base rounded-lg p-3 border border-border">
                    <%= simple_format(link.summary) %>
                  </div>
                </details>
              <% end %>

              <% if link.done? && link.audio_file_path.present? %>
                <a href="https://dash.puntofutura.com.ar/view?file=audio-summaries/<%= File.basename(link.audio_file_path) %>" target="_blank" rel="noopener" class="inline-flex items-center gap-1 text-xs text-accent hover:underline mt-1">
                  üîä Play Audio Summary
                </a>
              <% end %>

              <% if link.failed? && link.error_message.present? %>
                <div class="mt-1 text-xs text-red-400"><%= link.error_message %></div>
              <% end %>
            </div>

            <%# Delete %>
            <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
              <%= button_to saved_link_path(link), method: :delete, class: "text-content-muted hover:text-red-400 transition-colors p-1", data: { turbo_confirm: "Remove this link?" } do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="bg-bg-elevated border border-border rounded-xl p-12 text-center">
      <div class="text-4xl mb-3">üì•</div>
      <div class="text-content-muted">No saved links yet. Paste a URL above to get started.</div>
    </div>
  <% end %>
</div>
