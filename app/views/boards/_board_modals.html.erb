<%# New Board Modal %>
<div id="new-board-modal" 
     class="hidden fixed inset-0 z-50 flex items-center justify-center"
     data-controller="board-modal"
     data-board-modal-target="modal">
  <div class="absolute inset-0 bg-black/60" data-action="click->board-modal#close"></div>
  <div class="relative bg-bg-surface border border-border rounded-xl shadow-2xl w-full max-w-sm mx-4 overflow-hidden">
    <div class="px-5 py-4 border-b border-border flex items-center justify-between">
      <span class="text-sm font-semibold text-content font-display">New Board</span>
      <button type="button"
              data-action="click->board-modal#close"
              class="p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <%= form_with model: Board.new, url: boards_path, class: "p-5 space-y-4" do |form| %>
      <div>
        <label class="block text-sm font-medium text-content-secondary mb-2">Board Name</label>
        <%= form.text_field :name,
            required: true,
            placeholder: "e.g., Work, Personal, Side Project",
            class: "w-full px-3 py-2 text-sm bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent text-content placeholder-content-muted" %>
      </div>

      <div data-controller="icon-selector">
        <label class="block text-sm font-medium text-content-secondary mb-2">Icon</label>
        <div class="flex flex-wrap gap-2">
          <% available_icons = Board::DEFAULT_ICONS.dup %>
          <% if current_user.agent_last_active_at.present? && current_user.agent_emoji.present? && !available_icons.include?(current_user.agent_emoji) %>
            <% available_icons << current_user.agent_emoji %>
          <% end %>
          <% available_icons.each do |icon| %>
            <button type="button"
                    data-action="click->icon-selector#select"
                    data-icon-selector-target="button"
                    data-icon="<%= icon %>"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-bg-elevated hover:bg-bg-hover transition-colors text-xl cursor-pointer <%= icon == 'ðŸ“‹' ? 'ring-2 ring-accent' : '' %>">
              <%= icon %>
            </button>
          <% end %>
        </div>
        <%= form.hidden_field :icon, value: "ðŸ“‹", data: { icon_selector_target: "field" } %>
      </div>

      <div class="flex items-center justify-end gap-3 pt-2">
        <button type="button"
                data-action="click->board-modal#close"
                class="px-4 py-2 text-sm rounded-md bg-bg-elevated hover:bg-bg-hover text-content-secondary transition-colors cursor-pointer">
          Cancel
        </button>
        <%= form.submit "Create Board", class: "px-4 py-2 text-sm rounded-md bg-accent text-content hover:bg-accent-hover transition-colors cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>

<%# Board Settings Modal %>
<div id="board-settings-modal" 
     class="hidden fixed inset-0 z-50 flex items-center justify-center"
     data-controller="board-modal"
     data-board-modal-target="modal">
  <div class="absolute inset-0 bg-black/60" data-action="click->board-modal#close"></div>
  <div class="relative bg-bg-surface border border-border rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
    <div class="px-5 py-4 border-b border-border flex items-center justify-between sticky top-0 bg-bg-surface z-10">
      <span class="text-sm font-semibold text-content font-display">Board Settings</span>
      <button type="button"
              data-action="click->board-modal#close"
              class="p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors cursor-pointer">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <%= form_with model: @board, url: board_path(@board), method: :patch, class: "p-5 space-y-4" do |form| %>
      <div>
        <label class="block text-sm font-medium text-content-secondary mb-2">Board Name</label>
        <%= form.text_field :name,
            required: true,
            placeholder: "e.g., Work, Personal, Side Project",
            class: "w-full px-3 py-2 text-sm bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent text-content placeholder-content-muted" %>
      </div>

      <div data-controller="icon-selector">
        <label class="block text-sm font-medium text-content-secondary mb-2">Icon</label>
        <div class="flex flex-wrap gap-2">
          <% edit_icons = Board::DEFAULT_ICONS.dup %>
          <% if current_user.agent_last_active_at.present? && current_user.agent_emoji.present? && !edit_icons.include?(current_user.agent_emoji) %>
            <% edit_icons << current_user.agent_emoji %>
          <% end %>
          <% if @board.icon.present? && !edit_icons.include?(@board.icon) %>
            <% edit_icons << @board.icon %>
          <% end %>
          <% edit_icons.each do |icon| %>
            <button type="button"
                    data-action="click->icon-selector#select"
                    data-icon-selector-target="button"
                    data-icon="<%= icon %>"
                    class="w-10 h-10 flex items-center justify-center rounded-lg bg-bg-elevated hover:bg-bg-hover transition-colors text-xl cursor-pointer <%= icon == @board.icon ? 'ring-2 ring-accent' : '' %>">
              <%= icon %>
            </button>
          <% end %>
        </div>
        <%= form.hidden_field :icon, value: @board.icon, data: { icon_selector_target: "field" } %>
      </div>

      <%# Auto-Claim Section %>
      <div class="border-t border-border pt-4 mt-4" data-controller="auto-claim-tags">
        <div class="flex items-center justify-between mb-3">
          <div>
            <label class="block text-sm font-medium text-content">ðŸ¤– Auto-Claim</label>
            <span class="text-xs text-content-muted">Automatically assign matching tasks to agent</span>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <%= form.check_box :auto_claim_enabled,
                class: "sr-only peer",
                data: { action: "change->auto-claim-tags#toggle" } %>
            <div class="w-11 h-6 bg-bg-elevated rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
          </label>
        </div>

        <div data-auto-claim-tags-target="options" class="<%= @board.auto_claim_enabled ? '' : 'hidden' %> space-y-3 pl-4 border-l-2 border-accent/30">
          <div>
            <label class="block text-xs font-medium text-content-secondary mb-1">Name Prefix (optional)</label>
            <%= form.text_field :auto_claim_prefix,
                placeholder: "e.g., [Agent], AUTO:",
                class: "w-full px-3 py-2 text-sm bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent text-content placeholder-content-muted" %>
            <span class="text-xs text-content-muted mt-1">Claim tasks whose name starts with this prefix</span>
          </div>

          <div>
            <label class="block text-xs font-medium text-content-secondary mb-1">Tags (optional)</label>
            <div data-auto-claim-tags-target="container" class="flex flex-wrap gap-1 mb-2">
              <% (@board.auto_claim_tags || []).each do |tag| %>
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-accent/20 text-accent auto-claim-tag" data-tag="<%= tag %>">
                  <%= tag %>
                  <button type="button" data-action="click->auto-claim-tags#remove" class="hover:text-accent-hover cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-3 h-3">
                      <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                    </svg>
                  </button>
                </span>
              <% end %>
            </div>
            <div class="flex gap-2">
              <input type="text" 
                     data-auto-claim-tags-target="input"
                     data-action="keydown->auto-claim-tags#addOnEnter"
                     placeholder="Add tag..." 
                     class="flex-1 px-3 py-1.5 text-sm bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent text-content placeholder-content-muted">
              <button type="button" 
                      data-action="click->auto-claim-tags#add"
                      class="px-3 py-1.5 text-sm rounded-md bg-bg-elevated hover:bg-bg-hover text-content-secondary transition-colors cursor-pointer">
                Add
              </button>
            </div>
            <span class="text-xs text-content-muted mt-1">Claim tasks that have any of these tags</span>
            <div data-auto-claim-tags-target="hidden">
              <% (@board.auto_claim_tags || []).each do |tag| %>
                <input type="hidden" name="board[auto_claim_tags][]" value="<%= tag %>">
              <% end %>
            </div>
          </div>

          <div class="text-xs text-content-muted bg-bg-elevated/50 rounded-lg p-2">
            ðŸ’¡ <strong>Tip:</strong> If both prefix and tags are empty, all new inbox tasks will be auto-claimed.
            <% if @board.last_auto_claim_at.present? %>
              <br>Last auto-claim: <%= time_ago_in_words(@board.last_auto_claim_at) %> ago
            <% end %>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between pt-2">
        <% if @boards.count > 1 %>
          <%= link_to board_path(@board),
              method: :delete,
              data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this board? All tasks will be permanently deleted." },
              class: "text-sm text-status-error hover:text-status-error/80 transition-colors cursor-pointer" do %>
            Delete board
          <% end %>
        <% else %>
          <span></span>
        <% end %>

        <div class="flex items-center gap-3">
          <button type="button"
                  data-action="click->board-modal#close"
                  class="px-4 py-2 text-sm rounded-md bg-bg-elevated hover:bg-bg-hover text-content-secondary transition-colors cursor-pointer">
            Cancel
          </button>
          <%= form.submit "Save Changes", class: "px-4 py-2 text-sm rounded-md bg-accent text-content hover:bg-accent-hover transition-colors cursor-pointer" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
