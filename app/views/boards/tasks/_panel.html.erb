<%# Task edit panel - slide-in on mobile, full-screen modal on desktop %>
<%
  status_labels = {
    "inbox" => "Inbox",
    "up_next" => "Up Next",
    "in_progress" => "In Progress",
    "in_review" => "In Review",
    "done" => "Done"
  }
  missing_output_warning = task.in_review? && task.missing_agent_output?
  has_output_files = task.output_files.present? && task.output_files.any?
%>

<div data-controller="task-modal file-viewer"
     data-task-modal-task-id-value="<%= task.id %>">
  <!-- Backdrop -->
  <div data-task-modal-target="backdrop"
       data-action="click->task-modal#close"
    class="hidden opacity-0 fixed inset-0 bg-black/60 transition-opacity duration-300 ease-out z-[60]">
  </div>

  <!-- Modal / Panel Container -->
  <!-- Mobile: slide-in from right. Desktop (lg+): centered overlay modal -->
  <div data-task-modal-target="modal"
       class="hidden fixed z-[70] transition-all duration-300 ease-out
              inset-y-0 right-0 w-full max-w-md md:max-w-lg translate-x-full p-4
              lg:inset-0 lg:translate-x-0 lg:opacity-0 lg:scale-95 lg:p-6 lg:max-w-none lg:flex lg:items-center lg:justify-center">
    <div class="h-full bg-bg-surface border border-border shadow-2xl flex flex-col rounded-xl overflow-hidden
                lg:w-[90vw] lg:max-w-7xl lg:h-[90vh] lg:max-h-[90vh]">

      <!-- Header: status, id, actions (supports right-click + long-press context menu) -->
      <div class="px-5 py-4 border-b border-border flex-shrink-0"
           data-controller="dropdown delete-confirm context-menu"
           data-action="contextmenu->dropdown#openAtCursor"
           data-delete-confirm-item-name-value="<%= h(task.name.to_s.truncate(40)) %>">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <!-- Column/Status badge -->
            <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-bg-elevated text-content-secondary">
              <%= status_labels[task.status] %>
            </span>
            <!-- Nightly badge (if applicable) -->
            <% if task.nightly? %>
              <span class="nightly-badge inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium" 
                    title="Nightbeat task - overnight automated audit">
                üåô Nightbeat
              </span>
            <% end %>
            <!-- Task ID -->
            <span class="text-[10px] font-mono text-content-muted">#<%= task.id %></span>
            <!-- Copy URL button -->
            <button type="button"
                    data-controller="copy-url"
                    data-copy-url-url-value="<%= "#{request.base_url}/boards/#{task.board_id}/tasks/#{task.id}" rescue "/boards/#{task.board_id}/tasks/#{task.id}" %>"
                    data-action="click->copy-url#copy"
                    class="p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors cursor-pointer"
                    title="Copy task URL">
              üìã
            </button>
          </div>

          <div class="flex items-center gap-1">
            <!-- Menu (tap) -->
            <button type="button"
                    data-dropdown-target="button"
                    data-action="click->dropdown#toggle"
                    class="cursor-pointer p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                    aria-expanded="false"
                    title="Task menu">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
              </svg>
            </button>

            <!-- Close button -->
            <button type="button"
                    data-action="click->task-modal#close"
                    class="cursor-pointer p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Context menu -->
        <div data-dropdown-target="menu" role="menu" class="hidden fixed z-[10000] min-w-[180px] bg-bg-elevated border border-border rounded-lg shadow-lg py-1">
          <%= link_to "Open task", board_task_path(task.board, task), class: "block w-full px-3 py-2 text-sm text-content-secondary hover:bg-bg-hover transition-colors", data: { action: "click->dropdown#close", turbo_frame: "_top" } %>

          <div class="border-t border-border my-1"></div>

          <% [
            ["inbox", "üì• Inbox"],
            ["up_next", "‚è≥ Up Next"],
            ["in_progress", "üîÑ In Progress"],
            ["in_review", "üëÄ In Review"],
            ["done", "‚úÖ Done"],
            ["archived", "üì¶ Archived"]
          ].each do |status, label| %>
            <%= button_to move_board_task_path(task.board, task),
                method: :patch,
                params: { status: status },
                data: { action: "click->dropdown#close" },
                class: "w-full flex items-center justify-between gap-3 px-3 py-2 text-sm text-content-secondary hover:bg-bg-hover transition-colors #{task.status == status ? 'bg-bg-hover' : ''}" do %>
              <span><%= label %></span>
              <% if task.status == status %>
                <span class="text-accent">‚úì</span>
              <% end %>
            <% end %>
          <% end %>

          <div class="border-t border-border my-1"></div>

          <button type="button"
                  data-action="click->delete-confirm#open click->dropdown#close"
                  class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-300 hover:bg-bg-hover transition-colors">
            üóëÔ∏è Delete
          </button>
        </div>

        <%# Delete Confirmation Modal (outside dropdown) %>
        <%= render "application/delete_modal", url: board_task_path(task.board, task) %>
      </div>

      <!-- Content: Single column on mobile, two columns on desktop -->
      <div class="flex-1 min-h-0 flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden overflow-x-hidden">

        <!-- Left Column: Task Details (scrollable on desktop, natural flow on mobile) -->
        <div class="flex-none lg:flex-[3] lg:overflow-y-auto overflow-visible px-5 py-6 lg:border-r lg:border-border min-w-0">
          <% if missing_output_warning %>
            <div class="mb-4 rounded-lg border border-orange-500/50 bg-orange-500/10 px-3 py-2 text-sm text-orange-200 space-y-2">
              <div>‚ö†Ô∏è Missing Agent Output ‚Äî add ## Agent Output section before moving to Done</div>
              <div class="flex flex-wrap gap-2">
                <button type="button"
                        data-action="click->task-modal#recoverOutput"
                        data-recover-url="<%= recover_output_api_v1_task_path(task) %>"
                        class="cursor-pointer inline-flex items-center rounded-md border border-orange-400/40 bg-orange-500/20 px-2.5 py-1.5 text-xs font-medium text-orange-100 hover:bg-orange-500/30 transition-colors">
                  üìÑ Recuperar del Transcript
                </button>
                <button type="button"
                        data-action="click->task-modal#focusDescription"
                        class="cursor-pointer inline-flex items-center rounded-md border border-orange-400/40 bg-orange-500/20 px-2.5 py-1.5 text-xs font-medium text-orange-100 hover:bg-orange-500/30 transition-colors">
                  ‚úèÔ∏è Escribir manualmente
                </button>
              </div>
            </div>
          <% end %>

          <%# Pipeline progress stepper + log viewer (in-modal) %>
          <%= render "boards/tasks/pipeline_stepper", task: task %>
          <%= render "boards/tasks/pipeline_log_panel", task: task %>

          <%= form_with model: task, url: board_task_path(@board, task), method: :patch, data: { task_modal_target: "form" }, class: "space-y-6" do |form| %>
            <%= form.hidden_field :priority, value: task.priority, data: { task_modal_target: "priorityField" } %>

            <!-- Title -->
            <div>
              <%= form.text_field :name,
                  placeholder: "Task title",
                  class: "w-full text-xl font-semibold tracking-tight bg-transparent border-none focus:outline-none focus:ring-0 text-content placeholder-content-muted p-0 font-display",
                  data: { task_modal_target: "nameField", action: "input->task-modal#scheduleAutoSave" } %>
            </div>

            <!-- Notes -->
            <div>
              <%= form.text_area :description,
                  placeholder: "Add notes...",
                  rows: 1,
                  class: "w-full text-sm leading-snug tracking-tight bg-bg-elevated border-none focus:outline-none focus:ring-0 text-content-secondary placeholder-content-muted resize-none rounded-lg px-3 py-3 overflow-y-auto max-h-48",
                  data: { task_modal_target: "descriptionField", action: "input->task-modal#scheduleAutoSave" } %>
            </div>

            <!-- Details Divider -->
            <div class="border-t border-border pt-4">
              <h3 class="text-sm font-semibold text-content mb-4 font-display">Details</h3>

              <!-- Properties: 2-column grid on desktop modal, stacks on mobile slide-in -->
              <div class="grid grid-cols-2 gap-x-6 gap-y-3">

                <!-- Row 1, Col 1: Model Selection -->
                <div class="flex items-center justify-between">
                  <span class="text-sm text-content-muted">Model</span>
                  <%= form.select :model,
                      options_for_select([["Default", ""], ["Opus", "opus"], ["Codex", "codex"], ["Gemini", "gemini"], ["GLM", "glm"], ["Sonnet", "sonnet"]], task.model),
                      {},
                      class: "bg-bg-elevated border-none rounded-md text-sm text-content-secondary px-2 py-1.5 focus:ring-0 focus:outline-none",
                      data: { action: "change->task-modal#scheduleAutoSave" } %>
                </div>

                <!-- Row 1, Col 2: Priority -->
                <div class="flex items-center justify-between">
                  <span class="text-sm text-content-muted">Priority</span>
                  <div class="flex gap-1.5" data-task-modal-target="priorityGroup">
                    <button type="button" aria-pressed="false" data-action="click->task-modal#selectPriority" data-priority-value="none" data-task-modal-target="priorityButton" class="cursor-pointer inline-flex items-center justify-center px-2 py-1.5 rounded-md bg-bg-elevated hover:bg-bg-hover transition-colors duration-200 aria-pressed:bg-bg-hover">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-content-muted">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0 1 12 21 8.25 8.25 0 0 1 6.038 7.047 8.287 8.287 0 0 0 9 9.601a8.983 8.983 0 0 1 3.361-6.867 8.21 8.21 0 0 0 3 2.48Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 0 0 .495-7.468 5.99 5.99 0 0 0-1.925 3.547 5.975 5.975 0 0 1-2.133-1.001A3.75 3.75 0 0 0 12 18Z" />
                      </svg>
                    </button>
                    <button type="button" aria-pressed="false" data-action="click->task-modal#selectPriority" data-priority-value="low" data-task-modal-target="priorityButton" class="cursor-pointer inline-flex items-center justify-center px-2 py-1.5 rounded-md bg-bg-elevated hover:bg-bg-hover transition-colors duration-200 aria-pressed:bg-bg-hover">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-yellow-500">
                        <path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" />
                      </svg>
                    </button>
                    <button type="button" aria-pressed="false" data-action="click->task-modal#selectPriority" data-priority-value="medium" data-task-modal-target="priorityButton" class="cursor-pointer inline-flex items-center justify-center px-2 py-1.5 rounded-md bg-bg-elevated hover:bg-bg-hover transition-colors duration-200 aria-pressed:bg-bg-hover">
                      <div class="flex -space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-orange-500" style="position: relative; z-index: 2;"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-orange-500" style="position: relative; z-index: 1;"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" /></svg>
                      </div>
                    </button>
                    <button type="button" aria-pressed="false" data-action="click->task-modal#selectPriority" data-priority-value="high" data-task-modal-target="priorityButton" class="cursor-pointer inline-flex items-center justify-center px-2 py-1.5 rounded-md bg-bg-elevated hover:bg-bg-hover transition-colors duration-200 aria-pressed:bg-bg-hover">
                      <div class="flex -space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-accent" style="position: relative; z-index: 3;"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-accent" style="position: relative; z-index: 2;"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" /></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-accent" style="position: relative; z-index: 1;"><path fill-rule="evenodd" d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.176 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248ZM15.75 14.25a3.75 3.75 0 1 1-7.313-1.172c.628.465 1.35.81 2.133 1a5.99 5.99 0 0 1 1.925-3.546 3.75 3.75 0 0 1 3.255 3.718Z" clip-rule="evenodd" /></svg>
                      </div>
                    </button>
                  </div>
                </div>

                

                <!-- Agent Persona (full width) -->
                <div class="col-span-2 flex items-center justify-between gap-3">
                  <span class="text-sm text-content-muted">Agent Persona</span>
                  <div class="flex items-center gap-2 min-w-0">
                    <span data-task-modal-target="personaPill"
                          class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-accent/15 text-accent border border-accent/20 <%= 'hidden' unless task.agent_persona.present? %>"
                          title="<%= task.agent_persona.present? ? "#{task.agent_persona.emoji || 'ü§ñ'} #{task.agent_persona.name}" : '' %>">
                      <% if task.agent_persona.present? %>
                        <%= "#{task.agent_persona.emoji || 'ü§ñ'} #{task.agent_persona.name}" %>
                      <% end %>
                    </span>
                    <button type="button"
                            data-task-modal-target="personaClear"
                            data-action="click->task-modal#clearPersona:stop"
                            class="relative z-20 pointer-events-auto cursor-pointer p-1.5 rounded-md bg-bg-elevated hover:bg-bg-hover text-content-muted hover:text-red-400 transition-colors <%= 'hidden' unless task.agent_persona.present? %>"
                            title="Unassign persona">‚úï</button>

                    <%= form.select :agent_persona_id,
                        options_for_select([["Unassigned", ""]] + (@agent_personas || []).map { |p| ["#{p.emoji || 'ü§ñ'} #{p.name} (#{p.model_chain})", p.id] }, task.agent_persona_id),
                        {},
                        class: "bg-bg-elevated border-none rounded-md text-sm text-content-secondary px-2 py-1.5 focus:ring-0 focus:outline-none max-w-[360px]",
                        data: { task_modal_target: "personaSelect", action: "change->task-modal#onPersonaChange" } %>
                  </div>
                </div>
<!-- Row 2, Col 1: Recurring -->
                <div>
                  <% if task.recurring_instance? %>
                    <div class="flex items-center gap-2 text-xs text-content-muted">
                      <span>üîÑ</span>
                      <span>Instance of recurring task</span>
                    </div>
                  <% elsif task.followup_task? %>
                    <div class="flex items-center gap-2 text-xs text-content-muted">
                      <span>‚Ü™Ô∏è</span>
                      <span>Follow-up of: <%= task.parent_task&.name&.truncate(30) %></span>
                    </div>
                  <% else %>
                    <div class="space-y-2">
                      <div class="flex items-center justify-between">
                        <span class="text-sm text-content-muted">Recurring</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                          <%= form.check_box :recurring, class: "sr-only peer", data: { task_modal_target: "recurringCheckbox", action: "change->task-modal#toggleRecurring change->task-modal#scheduleAutoSave" } %>
                          <div class="w-9 h-5 bg-bg-elevated rounded-full peer peer-checked:bg-accent after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                        </label>
                      </div>
                      <div data-task-modal-target="recurringOptions" class="<%= task.recurring? ? '' : 'hidden' %> space-y-2 pl-4 border-l-2 border-border">
                        <div class="flex items-center justify-between">
                          <span class="text-xs text-content-muted">Repeat</span>
                          <%= form.select :recurrence_rule,
                              options_for_select([["Daily", "daily"], ["Weekly", "weekly"], ["Monthly", "monthly"]], task.recurrence_rule || "daily"),
                              {},
                              class: "bg-bg-elevated border-none rounded-md text-xs text-content-secondary px-2 py-1 focus:ring-0 focus:outline-none",
                              data: { action: "change->task-modal#scheduleAutoSave" } %>
                        </div>
                        <div class="flex items-center justify-between">
                          <span class="text-xs text-content-muted">At time</span>
                          <%= form.time_field :recurrence_time,
                              value: task.recurrence_time&.strftime("%H:%M") || "09:00",
                              class: "bg-bg-elevated border-none rounded-md text-xs text-content-secondary px-2 py-1 focus:ring-0 focus:outline-none",
                              data: { action: "change->task-modal#scheduleAutoSave" } %>
                        </div>
                        <% if task.next_recurrence_at.present? %>
                          <div class="text-xs text-content-muted">
                            Next: <%= task.next_recurrence_at.strftime("%b %d, %Y at %H:%M") %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>

                <!-- Row 2, Col 2: Nightly Task -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-content-muted">Nightly Task</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <%= form.check_box :nightly, class: "sr-only peer", data: { task_modal_target: "nightlyCheckbox", action: "change->task-modal#toggleNightly change->task-modal#scheduleAutoSave" } %>
                      <div class="w-9 h-5 bg-bg-elevated rounded-full peer peer-checked:bg-purple-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                  </div>
                  <div data-task-modal-target="nightlyOptions" class="<%= task.nightly? ? '' : 'hidden' %> space-y-2 pl-4 border-l-2 border-border">
                    <div class="flex items-center justify-between">
                      <span class="text-xs text-content-muted">Delay (hours)</span>
                      <%= form.number_field :nightly_delay_hours,
                          value: task.nightly_delay_hours || 0,
                          min: 0,
                          max: 24,
                          class: "w-16 bg-bg-elevated border-none rounded-md text-xs text-content-secondary px-2 py-1 focus:ring-0 focus:outline-none",
                          data: { action: "change->task-modal#scheduleAutoSave" } %>
                    </div>
                    <p class="text-[10px] text-content-muted">Hours after midnight to trigger</p>
                  </div>
                </div>

                <!-- Row 2, Col 3: Deep Research -->
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-content-muted">üß† Deep Research</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <%= form.check_box :deep_research, class: "sr-only peer", data: { action: "change->task-modal#scheduleAutoSave" } %>
                      <div class="w-9 h-5 bg-bg-elevated rounded-full peer peer-checked:bg-blue-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                  </div>
                  <p class="text-[10px] text-content-muted">4 parallel agents analyze from different angles</p>
                </div>

                <!-- Row 3: Validation Command (full width) -->
                <div class="col-span-2 space-y-2">
                  <div class="flex items-center justify-between">
                    <span class="text-sm text-content-muted">Validation Command</span>
                    <% if task.validation_status.present? %>
                      <% validation_badge_class = case task.validation_status
                        when "passed" then "bg-green-500/20 text-green-400"
                        when "failed" then "bg-red-500/20 text-red-400"
                        when "pending" then "bg-yellow-500/20 text-yellow-400"
                        else "bg-gray-500/20 text-gray-400"
                      end %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium <%= validation_badge_class %>">
                        <%= task.validation_status&.capitalize %>
                      </span>
                    <% end %>
                  </div>
                  <%= form.text_field :validation_command,
                      placeholder: "e.g., bin/rails test or npm test",
                      class: "w-full text-xs bg-bg-elevated border-none focus:outline-none focus:ring-0 text-content-secondary placeholder-content-muted rounded-lg px-3 py-2 font-mono",
                      data: { action: "input->task-modal#scheduleAutoSave" } %>
                  <p class="text-[10px] text-content-muted">Runs after agent completes. Exit 0 = pass, else = fail</p>
                  <% if task.validation_command.present? %>
                    <div class="flex items-center gap-2">
                      <%= button_to revalidate_board_task_path(@board, task),
                          method: :post,
                          class: "text-[10px] px-2 py-1 bg-bg-elevated hover:bg-bg-hover text-content-muted rounded transition-colors" do %>
                        üîÑ Re-run Validation
                      <% end %>
                      <% if task.validation_output.present? %>
                        <%= link_to validation_output_modal_board_task_path(@board, task),
                            data: { turbo_frame: "validation_output_modal" },
                            class: "text-[10px] px-2 py-1 bg-bg-elevated hover:bg-bg-hover text-content-muted rounded transition-colors" do %>
                          üìã View Output
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>

              </div>
            </div>

            <!-- Hidden submit button (triggered programmatically) -->
            <%= form.submit "Save", class: "hidden", data: { task_modal_target: "submitButton" } %>
          <% end %>

          <!-- Agent Assignment (outside form to avoid nested forms) -->
          <%= render "boards/tasks/agent_assignment", task: task, board: @board %>

          <!-- Dependencies Section -->
          <%= render "boards/tasks/dependencies", task: task, board: @board %>

          <!-- Agent Chat History -->
          <%= render "boards/tasks/agent_chat_history", task: task %>

          <!-- Activity Section -->
          <div class="border-t border-border pt-4">
            <h3 class="text-sm font-semibold text-content mb-4 font-display">Activity</h3>
            <%= render "shared/task_activities", task: task %>
          </div>

          <!-- Task Timestamps Footer -->
          <div class="mt-4 pt-3 border-t border-border text-xs text-content-muted">
            Created <%= time_ago_in_words(task.created_at) %> ago
            <% if task.completed_at.present? %>
              ‚Ä¢ Completed <%= time_ago_in_words(task.completed_at) %> ago
            <% end %>
          </div>
        </div>

        <!-- Right Column: Evidence (Transcript / Artifacts / Events) -->
        <div class="hidden lg:flex lg:flex-[2] flex-col min-h-0 overflow-hidden" data-controller="evidence-tabs">
          <div class="px-5 py-3 border-b border-border bg-bg-surface/40 flex items-center justify-between gap-3 flex-shrink-0">
            <div class="flex items-center gap-2">
              <button type="button" data-evidence-tabs-target="tab" data-key="transcript" data-action="click->evidence-tabs#select"
                      class="px-2 py-1 rounded-md text-xs font-semibold bg-accent/20 text-accent">
                Transcript
              </button>
              <button type="button" data-evidence-tabs-target="tab" data-key="artifacts" data-action="click->evidence-tabs#select"
                      class="px-2 py-1 rounded-md text-xs font-semibold bg-bg-elevated text-content-muted">
                Artifacts
              </button>
              <button type="button" data-evidence-tabs-target="tab" data-key="events" data-action="click->evidence-tabs#select"
                      class="px-2 py-1 rounded-md text-xs font-semibold bg-bg-elevated text-content-muted">
                Events
              </button>
            </div>

            <% if task.runner_lease_active? %>
              <div class="text-[10px] text-content-muted whitespace-nowrap" title="Runner Lease">
                RUNNING ¬∑ hb <%= time_ago_in_words(task.runner_last_heartbeat_at) %>
              </div>
            <% end %>
          </div>

          <div class="flex-1 min-h-0 overflow-hidden">
            <%# === Transcript panel === %>
            <div data-evidence-tabs-target="panel" data-key="transcript" class="h-full">
              <% has_agent_activity = task.show_agent_activity? %>
              <% if has_agent_activity %>
                <div class="h-full overflow-hidden flex flex-col px-5 py-4"
                     data-controller="agent-activity"
                     data-agent-activity-task-id-value="<%= task.id %>"
                     data-agent-activity-session-id-value="<%= task.agent_session_id %>"
                     data-agent-activity-task-status-value="<%= task.status %>"
                     data-agent-activity-compact-mode-value="true">
                  
                  <%# Header with title, status, and controls %>
                  <div class="flex items-center justify-between mb-2 flex-shrink-0">
                    <div class="flex items-center gap-2">
                      <h3 class="text-sm font-semibold text-content font-display">Agent Activity</h3>
                      <span data-agent-activity-target="statusBadge"
                            class="text-[10px] font-medium px-1.5 py-0.5 rounded <%= task.status == 'in_progress' ? 'bg-accent/20 text-accent' : 'bg-bg-elevated text-content-muted' %>">
                        <%= task.status == 'in_progress' ? 'Live' : task.status.humanize %>
                      </span>
                    </div>
                    <div class="flex items-center gap-1">
                      <button type="button"
                              data-agent-activity-target="filterToggle"
                              data-action="click->agent-activity#toggleCompactMode"
                              class="cursor-pointer px-2 py-1 rounded text-[10px] font-medium text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                              title="Toggle compact/expanded view">
                        üìã Compact
                      </button>
                      <button type="button"
                              data-action="click->agent-activity#toggleSearch"
                              class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                              title="Search (Ctrl+F)">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                      </button>
                      <button type="button"
                              data-action="click->agent-activity#refresh"
                              class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                              title="Refresh">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  <%# Activity timeline summary (works even without session_id) %>
                  <div class="mb-3 rounded-lg border border-border bg-bg-elevated/40 p-3">
                    <ol class="space-y-1.5 text-xs text-content-secondary">
                      <% if task.assigned_at.present? %>
                        <li>üß∑ Assigned to agent <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.assigned_at) %> ago</span></li>
                      <% end %>
                      <% if task.agent_claimed_at.present? %>
                        <li>ü§ù Agent claimed task <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.agent_claimed_at) %> ago</span></li>
                      <% end %>
                      <% if task.runner_lease_active? %>
                        <li>üè∑Ô∏è Lease heartbeat <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.runner_last_heartbeat_at) %> ago</span></li>
                      <% end %>
                      <% if task.agent_output_posted_at.present? %>
                        <li>üìù Output posted <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.agent_output_posted_at) %> ago</span></li>
                      <% end %>
                      <li>üìå Current status: <span class="font-medium text-content"><%= task.status.humanize %></span></li>
                    </ol>

                    <% if task.transcript_exists? %>
                      <div class="mt-2 pt-2 border-t border-border">
                        <%= link_to "View Transcript", agent_log_api_v1_task_path(task), target: "_blank", rel: "noopener", class: "text-xs text-accent hover:underline" %>
                      </div>
                    <% end %>
                  </div>

                  <div data-agent-activity-target="searchContainer" class="hidden mb-2 flex-shrink-0">
                    <div class="flex items-center gap-2 bg-bg-elevated rounded-lg px-3 py-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-content-muted flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                      </svg>
                      <input type="text"
                             data-agent-activity-target="searchInput"
                             data-action="input->agent-activity#performSearch"
                             placeholder="Search in terminal..."
                             class="flex-1 bg-transparent text-sm text-content placeholder-content-muted focus:outline-none">
                      <span data-agent-activity-target="searchCount" class="text-[10px] text-content-muted"></span>
                      <div class="flex items-center gap-1 border-l border-border pl-2">
                        <button type="button" data-action="click->agent-activity#prevMatch" class="p-1 hover:bg-bg-surface rounded" title="Previous (Shift+Enter)">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 text-content-muted">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />
                          </svg>
                        </button>
                        <button type="button" data-action="click->agent-activity#nextMatch" class="p-1 hover:bg-bg-surface rounded" title="Next (Enter)">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 text-content-muted">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                          </svg>
                        </button>
                        <button type="button" data-action="click->agent-activity#closeSearch" class="p-1 hover:bg-bg-surface rounded" title="Close (Esc)">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 text-content-muted">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div data-agent-activity-target="timelineContainer" class="hidden mb-3 flex-shrink-0">
                    <div data-agent-activity-target="timeline" class="flex items-center gap-1 overflow-x-auto scrollbar-hide py-1 px-1 bg-bg-elevated/50 rounded-lg"></div>
                  </div>

                  <div data-agent-activity-target="loadingState" class="flex items-center justify-center py-8">
                    <div class="flex items-center gap-2 text-content-muted">
                      <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      <span class="text-sm">Loading activity...</span>
                    </div>
                  </div>

                  <div data-agent-activity-target="emptyState" class="hidden text-center py-8">
                    <div class="text-content-muted">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mx-auto mb-2 opacity-50">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                      </svg>
                      <p class="text-sm empty-message">No agent activity</p>
                    </div>
                  </div>

                  <div data-agent-activity-target="log" class="hidden flex-1 space-y-2 overflow-y-auto overflow-x-hidden pr-1 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent"></div>
                </div>
              <% else %>
                <div class="h-full flex items-center justify-center text-content-muted px-5">
                  <div class="text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto mb-3 opacity-30">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                    </svg>
                    <p class="text-sm">No agent activity yet</p>
                    <p class="text-xs mt-1">Agent activity will appear here when a session connects</p>
                  </div>
                </div>
              <% end %>
            </div>

            <%# === Artifacts panel === %>
            <%
              has_diffs = task.task_diffs.any?
            %>
            <div data-evidence-tabs-target="panel" data-key="artifacts" class="hidden h-full flex flex-col"
                 data-controller="diff-viewer" data-diff-viewer-task-id-value="<%= task.id %>">
              <% if has_output_files || has_diffs %>
                <div class="px-5 py-4 border-b border-border flex-shrink-0">
                  <%# Sub-tabs for Files vs Changes %>
                  <% if has_diffs %>
                    <div class="flex items-center gap-2 mb-3" data-controller="artifacts-tabs">
                      <button type="button" data-artifacts-tabs-target="tab" data-key="files" data-action="click->artifacts-tabs#select"
                              class="px-2 py-1 rounded-md text-xs font-semibold bg-accent/20 text-accent">
                        üìÅ Files (<%= task.output_files&.count || 0 %>)
                      </button>
                      <button type="button" data-artifacts-tabs-target="tab" data-key="changes" data-action="click->artifacts-tabs#select"
                              class="px-2 py-1 rounded-md text-xs font-semibold bg-bg-elevated text-content-muted">
                        üìä Changes (<%= task.task_diffs.count %>)
                      </button>
                    </div>

                    <%# Files sub-panel %>
                    <div data-artifacts-tabs-target="panel" data-key="files">
                  <% end %>

                  <% if has_output_files %>
                    <h3 class="text-sm font-semibold text-content mb-3 font-display <%= 'hidden' if has_diffs %>">üìÅ Output Files</h3>
                    <div class="space-y-1.5">
                      <% task.output_files.each do |file_path| %>
                        <%
                          has_file_diff = task.task_diffs.exists?(file_path: file_path)
                          ext = File.extname(file_path.to_s).delete(".")
                          icon = case ext
                            when "md", "markdown" then "üìù"
                            when "rb", "py", "js", "ts" then "üíª"
                            when "json", "yml", "yaml" then "üìã"
                            when "log", "txt" then "üìÑ"
                            else "üìÑ"
                          end
                        %>
                        <div class="group flex items-center gap-2">
                          <span class="text-xs text-content-muted flex-shrink-0"><%= icon %></span>
                          <%= link_to view_file_board_task_path(@board, task, path: file_path),
                              data: { action: "click->file-viewer#open" },
                              class: "text-xs text-accent hover:underline truncate" do %>
                            <%= File.basename(file_path.to_s) %>
                          <% end %>
                          <span class="text-[10px] text-content-muted font-mono hidden group-hover:inline"><%= ext.upcase %></span>
                          <% if has_file_diff %>
                            <button type="button"
                                    data-action="click->diff-viewer#loadDiff"
                                    data-file-path="<%= file_path %>"
                                    data-diff-url="<%= diff_file_board_task_path(@board, task, path: file_path) %>"
                                    class="cursor-pointer text-[10px] px-1.5 py-0.5 rounded bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 transition-colors hidden group-hover:inline-flex items-center gap-1">
                              ‚ö° Diff
                            </button>
                          <% end %>
                          <%= link_to diff_file_board_task_path(@board, task, path: file_path),
                              data: { action: "click->file-viewer#open" },
                              class: "hidden group-hover:inline-flex items-center text-[10px] text-yellow-500 hover:text-yellow-400 gap-0.5" do %>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                            </svg>
                            Git
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% else %>
                    <p class="text-sm text-content-muted">No output files.</p>
                  <% end %>

                  <% if has_diffs %>
                    </div>

                    <%# Changes sub-panel %>
                    <div data-artifacts-tabs-target="panel" data-key="changes" class="hidden">
                      <div class="space-y-3">
                        <% task.task_diffs.each do |diff| %>
                          <%
                            stats = diff.stats
                            diff_type_color = case diff.diff_type
                              when "added" then "text-green-400"
                              when "deleted" then "text-red-400"
                              else "text-yellow-400"
                            end
                          %>
                          <div class="group flex items-center justify-between p-2 rounded-lg bg-bg-elevated/50 hover:bg-bg-elevated transition-colors">
                            <div class="flex items-center gap-2 min-w-0">
                              <span class="<%= diff_type_color %> text-xs">
                                <%= diff.diff_type == "added" ? "+" : diff.diff_type == "deleted" ? "‚àí" : "¬±" %>
                              </span>
                              <span class="text-xs text-content truncate" title="<%= diff.file_path %>">
                                <%= File.basename(diff.file_path) %>
                              </span>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                              <span class="text-[10px] text-green-400">+<%= stats[:additions] %></span>
                              <span class="text-[10px] text-red-400">-<%= stats[:deletions] %></span>
                              <button type="button"
                                      data-action="click->diff-viewer#loadDiff"
                                      data-file-path="<%= diff.file_path %>"
                                      data-diff-url="<%= diff_file_board_task_path(@board, task, path: diff.file_path) %>"
                                      class="cursor-pointer text-[10px] px-2 py-1 rounded bg-accent/20 text-accent hover:bg-accent/30 transition-colors">
                                View
                              </button>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="px-5 py-6 text-sm text-content-muted">No artifacts yet.</div>
              <% end %>

              <div data-file-viewer-target="panel" class="hidden flex-1 min-h-0 overflow-hidden border-b border-border">
                <turbo-frame id="file_viewer" class="h-full flex flex-col"></turbo-frame>
              </div>

              <div data-file-viewer-target="fullscreenModal"
                   class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4"
                   data-action="keydown.esc->file-viewer#collapse">
                <div class="absolute inset-0 bg-black/70" data-action="click->file-viewer#collapse"></div>
                <div class="relative w-[95vw] max-w-6xl h-[95vh] bg-bg-surface border border-border rounded-xl shadow-2xl flex flex-col overflow-hidden">
                  <div class="flex items-center justify-between px-6 py-4 border-b border-border flex-shrink-0">
                    <div class="flex items-center gap-2 min-w-0">
                      <span class="text-sm">üìÑ</span>
                      <span data-file-viewer-target="fullscreenFileName" class="text-sm font-medium text-content truncate"></span>
                    </div>
                    <button type="button" data-action="click->file-viewer#collapse" class="cursor-pointer p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors flex-shrink-0" title="Close expanded view">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div data-file-viewer-target="fullscreenContent" class="flex-1 overflow-y-auto px-6 py-6">
                    <div class="max-w-4xl mx-auto markdown-content"></div>
                  </div>
                </div>
              </div>

              <%# Diff viewer panel %>
              <div data-diff-viewer-target="diffPanel" class="hidden flex-1 min-h-0 overflow-hidden border-t border-border">
                <div class="h-full flex flex-col">
                  <div class="flex items-center justify-between px-4 py-2 bg-bg-elevated/50 border-b border-border flex-shrink-0">
                    <div class="flex items-center gap-2 min-w-0">
                      <span class="text-sm">üìä</span>
                      <span data-diff-viewer-target="fileName" class="text-xs font-medium text-content truncate"></span>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                      <button type="button" data-action="click->diff-viewer#expand" class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors" title="Expand">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                        </svg>
                      </button>
                      <button type="button" data-action="click->diff-viewer#close" class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors" title="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div data-diff-viewer-target="diffContent" class="flex-1 overflow-y-auto p-4"></div>
                </div>
              </div>

              <%# Diff fullscreen modal %>
              <div data-diff-viewer-target="fullscreenModal"
                   class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4"
                   data-action="keydown.esc->diff-viewer#collapse">
                <div class="absolute inset-0 bg-black/70" data-action="click->diff-viewer#collapse"></div>
                <div class="relative w-[95vw] max-w-6xl h-[95vh] bg-bg-surface border border-border rounded-xl shadow-2xl flex flex-col overflow-hidden">
                  <div class="flex items-center justify-between px-6 py-4 border-b border-border flex-shrink-0">
                    <div class="flex items-center gap-2 min-w-0">
                      <span class="text-sm">üìä</span>
                      <span data-diff-viewer-target="fullscreenFileName" class="text-sm font-medium text-content truncate"></span>
                    </div>
                    <button type="button" data-action="click->diff-viewer#collapse" class="cursor-pointer p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors flex-shrink-0" title="Close expanded view">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                  <div data-diff-viewer-target="fullscreenContent" class="flex-1 overflow-y-auto p-6"></div>
                </div>
              </div>
            </div>

            <%# === Events panel === %>
            <div data-evidence-tabs-target="panel" data-key="events" class="hidden h-full overflow-y-auto px-5 py-4">
              <% if task.runner_lease_active? %>
                <div class="mb-3 rounded-lg border border-border bg-bg-elevated/40 p-3 text-xs">
                  <div class="flex items-center justify-between">
                    <span class="text-content-muted">Lease started</span>
                    <span class="text-content"><%= task.runner_started_at&.strftime('%b %d, %H:%M:%S') %></span>
                  </div>
                  <div class="flex items-center justify-between mt-1">
                    <span class="text-content-muted">Last heartbeat</span>
                    <span class="text-content"><%= task.runner_last_heartbeat_at&.strftime('%b %d, %H:%M:%S') %></span>
                  </div>
                </div>
              <% end %>

              <h3 class="text-sm font-semibold text-content mb-3 font-display">Events</h3>
              <%= render "shared/task_activities", task: task %>
            </div>
          </div>
        </div>

        <!-- Mobile: Agent Activity + Output Files (shown below left column on mobile) -->
        <div class="lg:hidden px-5 py-4 pb-24 border-t border-border min-w-0 overflow-x-hidden">

          <%# Mobile Output Files %>
          <% if has_output_files %>
            <div class="mb-4">
              <h3 class="text-sm font-semibold text-content mb-3 font-display">üìÅ Output Files</h3>
              <div class="space-y-1.5">
                <% task.output_files.each do |file_path| %>
                  <div class="group flex items-center gap-2">
                    <span class="text-xs">üìÑ</span>
                    <%= link_to view_file_board_task_path(@board, task, path: file_path),
                        data: { turbo_frame: "mobile_file_viewer" },
                        class: "text-xs text-accent hover:underline truncate" do %>
                      <%= File.basename(file_path.to_s) %>
                    <% end %>
                    <%= link_to diff_file_board_task_path(@board, task, path: file_path),
                        data: { turbo_frame: "mobile_file_viewer" },
                        class: "hidden group-hover:inline-flex items-center text-[10px] text-yellow-500 hover:text-yellow-400 gap-0.5" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                      </svg>
                      Git
                    <% end %>
                  </div>
                <% end %>
              </div>
              <%# Mobile file viewer - uses same template with different frame ID %>
              <div class="mt-3 max-h-96 overflow-y-auto bg-bg-elevated rounded-lg">
                <turbo-frame id="mobile_file_viewer">
                </turbo-frame>
              </div>
            </div>
          <% end %>

          <%# Mobile Agent Activity - Enhanced %>
          <% if has_agent_activity %>
            <div data-controller="agent-activity"
                 data-agent-activity-task-id-value="<%= task.id %>"
                 data-agent-activity-session-id-value="<%= task.agent_session_id %>"
                 data-agent-activity-task-status-value="<%= task.status %>"
                 data-agent-activity-compact-mode-value="true">
              
              <%# Header %>
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <h3 class="text-sm font-semibold text-content font-display">Agent Activity</h3>
                  <span data-agent-activity-target="statusBadge"
                        class="text-[10px] font-medium px-1.5 py-0.5 rounded <%= task.status == 'in_progress' ? 'bg-accent/20 text-accent' : 'bg-bg-elevated text-content-muted' %>">
                    <%= task.status == 'in_progress' ? 'Live' : task.status.humanize %>
                  </span>
                </div>
                <div class="flex items-center gap-1">
                  <button type="button"
                          data-agent-activity-target="filterToggle"
                          data-action="click->agent-activity#toggleCompactMode"
                          class="cursor-pointer px-2 py-1 rounded text-[10px] font-medium text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                          title="Toggle view">
                    üìã Compact
                  </button>
                  <button type="button"
                          data-action="click->agent-activity#toggleSearch"
                          class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                          title="Search">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                  </button>
                  <button type="button"
                          data-action="click->agent-activity#refresh"
                          class="cursor-pointer p-1.5 rounded text-content-muted hover:text-content hover:bg-bg-elevated transition-colors"
                          title="Refresh">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  </button>
                </div>
              </div>

              <%# Activity timeline summary %>
              <div class="mb-3 rounded-lg border border-border bg-bg-elevated/40 p-3">
                <ol class="space-y-1.5 text-xs text-content-secondary">
                  <% if task.assigned_at.present? %>
                    <li>üß∑ Assigned to agent <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.assigned_at) %> ago</span></li>
                  <% end %>
                  <% if task.agent_claimed_at.present? %>
                    <li>ü§ù Agent claimed task <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.agent_claimed_at) %> ago</span></li>
                  <% end %>
                  <% if task.agent_output_posted_at.present? %>
                    <li>üìù Output posted <span class="text-content-muted">‚Ä¢ <%= time_ago_in_words(task.agent_output_posted_at) %> ago</span></li>
                  <% end %>
                  <li>üìå Current status: <span class="font-medium text-content"><%= task.status.humanize %></span></li>
                </ol>

                <% if task.transcript_exists? %>
                  <div class="mt-2 pt-2 border-t border-border">
                    <%= link_to "View Transcript", agent_log_api_v1_task_path(task), target: "_blank", rel: "noopener", class: "text-xs text-accent hover:underline" %>
                  </div>
                <% end %>
              </div>

              <%# Search bar (hidden) %>
              <div data-agent-activity-target="searchContainer" class="hidden mb-2">
                <div class="flex items-center gap-2 bg-bg-elevated rounded-lg px-3 py-2">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-content-muted">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                  </svg>
                  <input type="text"
                         data-agent-activity-target="searchInput"
                         data-action="input->agent-activity#performSearch"
                         placeholder="Search..."
                         class="flex-1 bg-transparent text-sm text-content placeholder-content-muted focus:outline-none">
                  <span data-agent-activity-target="searchCount" class="text-[10px] text-content-muted"></span>
                  <button type="button" data-action="click->agent-activity#closeSearch" class="p-1 hover:bg-bg-surface rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 text-content-muted">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>

              <%# Mini Timeline %>
              <div data-agent-activity-target="timelineContainer" class="hidden mb-2">
                <div data-agent-activity-target="timeline" 
                     class="flex items-center gap-1 overflow-x-auto scrollbar-hide py-1 px-1 bg-bg-elevated/50 rounded-lg text-xs">
                </div>
              </div>

              <div data-agent-activity-target="loadingState" class="flex items-center justify-center py-8">
                <div class="flex items-center gap-2 text-content-muted">
                  <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  <span class="text-sm">Loading activity...</span>
                </div>
              </div>

              <div data-agent-activity-target="emptyState" class="hidden text-center py-8">
                <div class="text-content-muted">
                  <p class="text-sm empty-message">No agent activity</p>
                </div>
              </div>

              <div data-agent-activity-target="log"
                   class="hidden space-y-2 max-h-64 overflow-y-auto overflow-x-hidden break-words pr-1 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent overscroll-contain [-webkit-overflow-scrolling:touch]">
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
