<%# Agent Chat Panel â€” live chat with the running agent session %>
<%# Only rendered when task has an agent_session_id %>
<% if task.agent_session_id.present? %>
  <div class="h-full flex flex-col"
       data-controller="agent-chat"
       data-agent-chat-task-id-value="<%= task.id %>"
       data-agent-chat-board-id-value="<%= board.id %>"
       data-agent-chat-session-id-value="<%= task.agent_session_id %>">

    <%# Header %>
    <div class="flex items-center justify-between px-4 py-2 flex-shrink-0">
      <div class="flex items-center gap-2">
        <span class="text-sm">ğŸ’¬</span>
        <h3 class="text-sm font-semibold text-content font-display">Agent Chat</h3>
        <span data-agent-chat-target="status"
              class="text-[10px] font-medium px-1.5 py-0.5 rounded bg-bg-elevated text-content-muted">
          Connecting...
        </span>
      </div>
    </div>

    <%# Messages area %>
    <div data-agent-chat-target="messages"
         class="flex-1 overflow-y-auto px-4 py-3 space-y-0 scrollbar-thin scrollbar-thumb-border scrollbar-track-transparent">

      <%# Empty state %>
      <div data-agent-chat-target="empty"
           class="flex items-center justify-center h-full">
        <div class="text-center text-content-muted">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mx-auto mb-2 opacity-40">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
          </svg>
          <p class="text-sm">Send a message to the agent</p>
          <p class="text-xs mt-1 text-content-muted">Messages are relayed to the running session</p>
        </div>
      </div>
    </div>

    <%# Thinking indicator %>
    <div data-agent-chat-target="thinking" class="hidden px-4 pb-2">
      <div class="flex items-center gap-2 text-content-muted">
        <div class="flex gap-1">
          <span class="w-1.5 h-1.5 rounded-full bg-content-muted animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-content-muted animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-1.5 h-1.5 rounded-full bg-content-muted animate-bounce" style="animation-delay: 300ms"></span>
        </div>
        <span class="text-xs">Agent is thinking...</span>
      </div>
    </div>

    <%# Input area %>
    <div class="flex-shrink-0 border-t border-border px-4 py-3">
      <form data-action="submit->agent-chat#send" class="flex items-end gap-2">
        <div class="flex-1 relative">
          <input type="text"
                 data-agent-chat-target="input"
                 data-action="keydown->agent-chat#keydown"
                 placeholder="Message the agent..."
                 autocomplete="off"
                 class="w-full bg-bg-elevated border border-border rounded-xl px-4 py-2.5 text-sm text-content placeholder-content-muted focus:outline-none focus:ring-1 focus:ring-accent/50 focus:border-accent/50 transition-colors" />
        </div>
        <button type="submit"
                data-agent-chat-target="sendButton"
                class="cursor-pointer flex-shrink-0 p-2.5 rounded-xl bg-accent text-white hover:bg-accent/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                title="Send message">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
          </svg>
        </button>
      </form>
    </div>
  </div>
<% else %>
  <%# No session â€” show placeholder %>
  <div class="h-full flex items-center justify-center text-content-muted px-5">
    <div class="text-center">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 mx-auto mb-3 opacity-30">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
      </svg>
      <p class="text-sm">No active agent session</p>
      <p class="text-xs mt-1">Chat will be available when an agent session is running</p>
    </div>
  </div>
<% end %>
