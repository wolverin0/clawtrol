<% auto_sorted_statuses = %w[in_review done] %>
<% if @task.saved_change_to_status? %>
  <%# Status changed - move card to new column %>
  <% old_status = @task.status_before_last_save %>
  <% new_status = @task.status %>

  <%# Remove from old column %>
  <%= turbo_stream.remove "task_#{@task.id}" %>

  <%# Keep canonical ordering for auto-sorted columns %>
  <% if auto_sorted_statuses.include?(new_status) %>
    <%= turbo_stream.replace "column-#{new_status}" do %>
      <%= render "boards/column_tasks",
        status: new_status,
        board: @board,
        tasks: @board.tasks.not_archived.where(status: new_status).includes(:board, :user, :agent_persona).ordered_for_column(new_status) %>
    <% end %>
  <% else %>
    <%= turbo_stream.prepend "column-#{new_status}" do %>
      <%= render "boards/task_card", task: @task %>
    <% end %>
  <% end %>

  <% if auto_sorted_statuses.include?(old_status) %>
    <%= turbo_stream.replace "column-#{old_status}" do %>
      <%= render "boards/column_tasks",
        status: old_status,
        board: @board,
        tasks: @board.tasks.not_archived.where(status: old_status).includes(:board, :user, :agent_persona).ordered_for_column(old_status) %>
    <% end %>
  <% end %>

  <%# Update old column count %>
  <% old_count = @board.tasks.where(status: old_status).count %>
  <%= turbo_stream.replace "column-#{old_status}-count" do %>
    <span id="column-<%= old_status %>-count" class="ml-auto text-xs text-content-secondary bg-bg-elevated px-1.5 py-0.5 rounded"><%= old_count %></span>
  <% end %>

  <%# Update new column count %>
  <% new_count = @board.tasks.where(status: new_status).count %>
  <%= turbo_stream.replace "column-#{new_status}-count" do %>
    <span id="column-<%= new_status %>-count" class="ml-auto text-xs text-content-secondary bg-bg-elevated px-1.5 py-0.5 rounded"><%= new_count %></span>
  <% end %>

  <%# Update header counts if applicable %>
  <% if %w[inbox in_progress].include?(old_status) %>
    <%= turbo_stream.update "header-#{old_status}-count", old_count.to_s %>
  <% end %>
  <% if %w[inbox in_progress].include?(new_status) %>
    <%= turbo_stream.update "header-#{new_status}-count", new_count.to_s %>
  <% end %>
<% else %>
  <%# Status didn't change - preserve deterministic ordering in auto-sorted columns %>
  <% if auto_sorted_statuses.include?(@task.status) %>
    <%= turbo_stream.replace "column-#{@task.status}" do %>
      <%= render "boards/column_tasks",
        status: @task.status,
        board: @board,
        tasks: @board.tasks.not_archived.where(status: @task.status).includes(:board, :user, :agent_persona).ordered_for_column(@task.status) %>
    <% end %>
  <% else %>
    <%= turbo_stream.replace "task_#{@task.id}" do %>
      <%= render "boards/task_card", task: @task %>
    <% end %>
  <% end %>
<% end %>

<%# Update the activity section in the panel %>
<%= turbo_stream.replace "task-activities-#{@task.id}" do %>
  <%= render "shared/task_activities", task: @task %>
<% end %>
