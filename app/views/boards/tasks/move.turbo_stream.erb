<% auto_sorted_statuses = %w[in_review done] %>
<% new_status = @task.status %>

<%# Remove from old column %>
<%= turbo_stream.remove "task_#{@task.id}" %>

<%# Keep canonical ordering for auto-sorted columns %>
<% if auto_sorted_statuses.include?(new_status) %>
  <%= turbo_stream.replace "column-#{new_status}" do %>
    <%= render "boards/column_tasks",
      status: new_status,
      board: @board,
      tasks: @board.tasks.not_archived.where(status: new_status).includes(:board, :user, :agent_persona).ordered_for_column(new_status) %>
  <% end %>
<% else %>
  <%= turbo_stream.prepend "column-#{new_status}" do %>
    <%= render "boards/task_card", task: @task %>
  <% end %>
<% end %>

<% if auto_sorted_statuses.include?(@old_status) %>
  <%= turbo_stream.replace "column-#{@old_status}" do %>
    <%= render "boards/column_tasks",
      status: @old_status,
      board: @board,
      tasks: @board.tasks.not_archived.where(status: @old_status).includes(:board, :user, :agent_persona).ordered_for_column(@old_status) %>
  <% end %>
<% end %>

<%# Update old column count %>
<%= turbo_stream.replace "column-#{@old_status}-count" do %>
  <span id="column-<%= @old_status %>-count" class="ml-auto text-xs text-content-secondary bg-bg-elevated px-1.5 py-0.5 rounded"><%= @board.tasks.where(status: @old_status).count %></span>
<% end %>

<%# Update new column count %>
<%= turbo_stream.replace "column-#{@task.status}-count" do %>
  <span id="column-<%= @task.status %>-count" class="ml-auto text-xs text-content-secondary bg-bg-elevated px-1.5 py-0.5 rounded"><%= @board.tasks.where(status: @task.status).count %></span>
<% end %>
