<%= turbo_frame_tag "followup_modal" do %>
  <div class="fixed inset-0 z-50 flex items-center justify-center" data-controller="modal" data-action="keydown.esc->modal#close">
    <div class="absolute inset-0 bg-black/60" data-action="click->modal#close"></div>
    <div class="relative bg-bg-surface border border-border rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-hidden flex flex-col">

      <!-- Header -->
      <div class="px-5 py-4 border-b border-border flex items-center justify-between flex-shrink-0">
        <span class="text-sm font-semibold text-content font-display">Create Follow-up Task</span>
        <%= link_to board_path(@board), class: "p-2 rounded-lg text-content-muted hover:text-content hover:bg-bg-elevated transition-colors", data: { turbo_frame: "_top" } do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        <% end %>
      </div>

      <div class="overflow-y-auto flex-1">
        <%= form_with url: create_followup_board_task_path(@board, @task), method: :post, class: "px-5 py-5 space-y-4" do |form| %>
          <!-- Original Task Reference with Output -->
          <details class="group">
            <summary class="p-3 bg-bg-elevated rounded-lg cursor-pointer list-none">
              <div class="flex items-center justify-between">
                <div>
                  <span class="text-xs text-content-muted block mb-1">Following up on:</span>
                  <span class="text-sm font-medium text-content"><%= @task.name.truncate(50) %></span>
                  <% if @task.model.present? %>
                    <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-500/20 text-purple-400">
                      <%= @task.model.upcase %>
                    </span>
                  <% end %>
                </div>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-content-muted transition-transform group-open:rotate-180">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>
              </div>
            </summary>
            <% if @task.description.present? %>
              <div class="mt-2 p-3 bg-bg-base rounded-lg max-h-48 overflow-y-auto">
                <div class="text-xs text-content-secondary prose prose-sm prose-invert max-w-none">
                  <%= simple_format(@task.description.truncate(2000)) %>
                </div>
              </div>
            <% end %>
          </details>

          <!-- Follow-up Title -->
          <div>
            <label class="text-sm font-medium text-content-muted block mb-2">Follow-up Title</label>
            <%= form.text_field :followup_name,
                value: "Follow up: #{@task.name.truncate(40)}",
                required: true,
                autofocus: true,
                placeholder: "Follow-up task title",
                class: "w-full text-base bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/50 text-content placeholder-content-muted px-3 py-2" %>
          </div>

          <!-- Description with AI Generate and Enhance buttons -->
          <div data-controller="followup-suggestion enhance-followup" 
               data-followup-suggestion-url-value="<%= generate_followup_board_task_path(@board, @task, format: :json) %>"
               data-followup-suggestion-cached-value="<%= @task.suggested_followup.present? %>"
               data-enhance-followup-url-value="<%= enhance_followup_board_task_path(@board, @task, format: :json) %>">
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium text-content-muted">Description</label>
              <div class="flex items-center gap-2">
                <% if current_user.ai_api_key.present? %>
                  <!-- Generate AI Suggestion button (hidden if already has suggestion) -->
                  <button
                    type="button"
                    data-followup-suggestion-target="generateBtn"
                    data-action="click->followup-suggestion#generate"
                    class="<%= @task.suggested_followup.present? ? 'hidden' : '' %> flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-accent hover:text-accent-hover bg-accent/10 hover:bg-accent/20 rounded transition-colors"
                  >
                    <svg data-followup-suggestion-target="spinner" class="hidden animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span data-followup-suggestion-target="label">ü§ñ Generate AI Suggestion</span>
                  </button>
                  <!-- Enhance button -->
                  <button
                    type="button"
                    data-enhance-followup-target="button"
                    data-action="click->enhance-followup#enhance"
                    class="flex items-center gap-1.5 px-2 py-1 text-xs font-medium text-purple-400 hover:text-purple-300 bg-purple-500/10 hover:bg-purple-500/20 rounded transition-colors"
                  >
                    <svg data-enhance-followup-target="spinner" class="hidden animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span data-enhance-followup-target="label">‚ú® Enhance</span>
                  </button>
                <% end %>
              </div>
            </div>
            <%= form.text_area :followup_description,
                value: @task.suggested_followup || "",
                placeholder: "Describe what needs to be done next...",
                rows: 5,
                data: { followup_suggestion_target: "textarea", enhance_followup_target: "textarea" },
                class: "w-full text-sm leading-snug bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/50 text-content-secondary placeholder-content-muted resize-none px-3 py-3" %>
          </div>

          <!-- Session Continuation -->
          <% if @task.agent_session_key.present? %>
            <div data-controller="session-health" 
                 data-session-health-url-value="<%= session_health_api_v1_task_path(@task, format: :json) %>"
                 data-session-health-threshold-value="<%= current_user.context_threshold_percent %>">
              <label class="text-sm font-medium text-content-muted block mb-2">Session Continuation</label>
              
              <!-- Session Health Indicator -->
              <div class="p-3 bg-bg-elevated rounded-lg mb-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-content-muted">Session health:</span>
                    <span data-session-health-target="indicator" class="text-xs font-medium">
                      Loading...
                    </span>
                  </div>
                  <div data-session-health-target="badge" class="hidden">
                    <!-- Status badge injected here -->
                  </div>
                </div>
                <!-- Warning message -->
                <div data-session-health-target="warning" class="hidden mt-2 p-2 bg-yellow-500/10 border border-yellow-500/30 rounded text-xs text-yellow-400">
                  ‚ö†Ô∏è <span data-session-health-target="warningText">High context usage</span> ‚Äî recommend fresh start
                </div>
              </div>

              <!-- Continue Session Toggle -->
              <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-bg-elevated cursor-pointer border border-transparent has-[:checked]:border-accent/50 has-[:checked]:bg-accent/10 transition-colors">
                <%= form.check_box :continue_session,
                    checked: false,
                    data: { session_health_target: "checkbox", action: "change->session-health#toggleContinue" },
                    class: "rounded border-border bg-bg-elevated text-accent focus:ring-accent focus:ring-offset-bg-surface" %>
                <div class="flex-1">
                  <span class="text-sm text-content">Continue same session</span>
                  <p class="text-xs text-content-muted mt-0.5">Inherit context from parent task's agent session</p>
                </div>
              </label>

              <!-- Hidden field to pass session key if continuing -->
              <%= form.hidden_field :inherit_session_key, value: @task.agent_session_key, data: { session_health_target: "sessionKeyField" }, disabled: true %>
            </div>
          <% end %>

          <!-- Model Selection -->
          <div>
            <label class="text-sm font-medium text-content-muted block mb-2">Model</label>
            <%= form.select :model,
                options_for_select([
                  ["Inherit from parent (#{@task.model&.upcase || 'default'})", ""],
                  ["Opus", "opus"],
                  ["Codex", "codex"],
                  ["Gemini", "gemini"],
                  ["GLM", "glm"],
                  ["Sonnet", "sonnet"]
                ], ""),
                {},
                class: "w-full text-sm bg-bg-elevated border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent/50 text-content px-3 py-2" %>
          </div>

          <!-- Destination -->
          <div>
            <label class="text-sm font-medium text-content-muted block mb-2">Send to</label>
            <div class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-bg-elevated cursor-pointer border border-transparent has-[:checked]:border-accent/50 has-[:checked]:bg-accent/10">
                <%= form.radio_button :destination, "inbox", checked: true, class: "text-accent focus:ring-accent" %>
                <span class="text-sm text-content">üì• Inbox</span>
              </label>
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-bg-elevated cursor-pointer border border-transparent has-[:checked]:border-accent/50 has-[:checked]:bg-accent/10">
                <%= form.radio_button :destination, "up_next", class: "text-accent focus:ring-accent" %>
                <span class="text-sm text-content">‚è≥ Up Next</span>
              </label>
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-bg-elevated cursor-pointer border border-transparent has-[:checked]:border-accent/50 has-[:checked]:bg-accent/10">
                <%= form.radio_button :destination, "in_progress", class: "text-accent focus:ring-accent" %>
                <span class="text-sm text-content">üöÄ Execute</span>
              </label>
              <label class="flex items-center gap-2 p-2 rounded-lg hover:bg-bg-elevated cursor-pointer border border-transparent has-[:checked]:border-accent/50 has-[:checked]:bg-accent/10">
                <%= form.radio_button :destination, "nightly", class: "text-accent focus:ring-accent" %>
                <span class="text-sm text-content">üåô Nightly</span>
              </label>
            </div>
          </div>

          <!-- Footer -->
          <div class="flex items-center justify-end gap-3 pt-4 border-t border-border">
            <%= link_to "Cancel", board_path(@board), class: "px-4 py-2 text-sm font-medium text-content-secondary hover:text-content transition-colors", data: { turbo_frame: "_top" } %>
            <%= form.submit "Create Follow-up", class: "px-4 py-2 text-sm font-semibold rounded-md bg-accent text-content hover:bg-accent-hover transition-colors cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
