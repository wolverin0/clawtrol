<%# Diff viewer partial - GitHub-style diff rendering with diff2html.js %>
<%# Supports: unified/side-by-side toggle, collapsible files, syntax highlighting %>
<% 
  stats = task_diff.stats
  diff_type_label = case task_diff.diff_type
    when "added" then "New file"
    when "deleted" then "Deleted"
    else "Modified"
  end
  diff_type_color = case task_diff.diff_type
    when "added" then "text-green-400"
    when "deleted" then "text-red-400"
    else "text-yellow-400"
  end
  unified_diff = task_diff.unified_diff_string
  ext = File.extname(task_diff.file_path.to_s).delete(".")
%>

<div class="diff-viewer" 
     data-controller="diff-viewer"
     data-diff-viewer-output-type-value="line-by-line">

  <%# Header with file info, stats, and view toggle %>
  <div class="flex items-center justify-between px-3 py-2 bg-bg-elevated border-b border-border rounded-t-lg">
    <div class="flex items-center gap-2 min-w-0">
      <span class="<%= diff_type_color %> font-medium text-xs"><%= diff_type_label %></span>
      <span class="text-xs text-content font-mono truncate" title="<%= task_diff.file_path %>">
        <%= task_diff.file_path %>
      </span>
      <% if ext.present? %>
        <span class="text-[10px] text-content-muted font-mono px-1.5 py-0.5 bg-bg-surface rounded"><%= ext.upcase %></span>
      <% end %>
    </div>
    <div class="flex items-center gap-3 flex-shrink-0">
      <div class="flex items-center gap-2 text-[10px]">
        <% if stats[:additions] > 0 %>
          <span class="text-green-400 font-semibold">+<%= stats[:additions] %></span>
        <% end %>
        <% if stats[:deletions] > 0 %>
          <span class="text-red-400 font-semibold">-<%= stats[:deletions] %></span>
        <% end %>
      </div>
    </div>
  </div>

  <%# Diff content rendered by diff2html.js %>
  <div class="bg-bg-surface border border-t-0 border-border rounded-b-lg overflow-hidden">
    <% if unified_diff.present? %>
      <%# Container for diff2html output — JS will render into this %>
      <div data-diff-viewer-target="diffContent"
           data-diff-raw="<%= unified_diff.encode('UTF-8', invalid: :replace, undef: :replace) %>"
           class="diff2html-container">
        <%# Fallback: server-rendered diff (shown until JS initializes) %>
        <noscript>
          <% groups = task_diff.grouped_lines %>
          <% groups.each do |group| %>
            <% if group[:type] == :collapsed %>
              <div class="px-3 py-1.5 text-[10px] text-content-muted bg-bg-elevated/50 border-y border-border">
                ⋯ <%= group[:count] %> unchanged line<%= group[:count] == 1 ? '' : 's' %>
              </div>
            <% else %>
              <table class="w-full border-collapse font-mono text-xs">
                <% group[:lines].each do |line| %>
                  <%= render_diff_line(line) %>
                <% end %>
              </table>
            <% end %>
          <% end %>
        </noscript>
      </div>

      <%# Initialize diff2html rendering via inline script (runs after DOM ready) %>
      <script type="module">
        // Wait for both diff2html and Stimulus to be ready
        function renderDiff2Html() {
          const container = document.querySelector('[data-diff-raw]');
          if (!container || !window.Diff2Html) {
            // Retry after a short delay if not ready
            setTimeout(renderDiff2Html, 100);
            return;
          }
          
          const rawDiff = container.getAttribute('data-diff-raw');
          if (!rawDiff) return;

          try {
            const html = window.Diff2Html.html(rawDiff, {
              drawFileList: false,
              matching: 'lines',
              outputFormat: 'line-by-line',
              renderNothingWhenEmpty: false,
              colorScheme: 'dark'
            });
            container.innerHTML = html;

            // Add collapse icons to file headers
            container.querySelectorAll('.d2h-file-header').forEach(header => {
              const nameWrapper = header.querySelector('.d2h-file-name-wrapper');
              if (nameWrapper && !nameWrapper.querySelector('.collapse-icon')) {
                const icon = document.createElement('span');
                icon.className = 'collapse-icon';
                icon.textContent = '▼';
                nameWrapper.insertBefore(icon, nameWrapper.firstChild);
              }
              header.style.cursor = 'pointer';
              header.addEventListener('click', (e) => {
                if (e.target.closest('a, button')) return;
                const wrapper = header.closest('.d2h-file-wrapper');
                if (wrapper) {
                  wrapper.classList.toggle('collapsed');
                  const collapseIcon = header.querySelector('.collapse-icon');
                  if (collapseIcon) {
                    collapseIcon.textContent = wrapper.classList.contains('collapsed') ? '▶' : '▼';
                  }
                }
              });
            });
          } catch (e) {
            console.error('diff2html render error:', e);
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', renderDiff2Html);
        } else {
          renderDiff2Html();
        }
      </script>
    <% else %>
      <div class="px-4 py-8 text-center text-content-muted">
        <p class="text-sm">No diff content available</p>
      </div>
    <% end %>
  </div>
</div>
