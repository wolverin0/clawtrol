<%# Diff viewer partial - renders a unified diff with line numbers and syntax coloring %>
<% 
  groups = task_diff.grouped_lines
  stats = task_diff.stats
  diff_type_label = case task_diff.diff_type
    when "added" then "New file"
    when "deleted" then "Deleted"
    else "Modified"
  end
  diff_type_color = case task_diff.diff_type
    when "added" then "text-green-400"
    when "deleted" then "text-red-400"
    else "text-yellow-400"
  end
%>

<div class="diff-viewer font-mono text-xs">
  <%# Header with file info and stats %>
  <div class="flex items-center justify-between px-3 py-2 bg-bg-elevated border-b border-border rounded-t-lg">
    <div class="flex items-center gap-2 min-w-0">
      <span class="<%= diff_type_color %> font-medium"><%= diff_type_label %></span>
      <span class="text-content truncate" title="<%= task_diff.file_path %>">
        <%= File.basename(task_diff.file_path) %>
      </span>
    </div>
    <div class="flex items-center gap-3 text-[10px] flex-shrink-0">
      <% if stats[:additions] > 0 %>
        <span class="text-green-400">+<%= stats[:additions] %></span>
      <% end %>
      <% if stats[:deletions] > 0 %>
        <span class="text-red-400">-<%= stats[:deletions] %></span>
      <% end %>
    </div>
  </div>

  <%# Diff content %>
  <div class="bg-bg-surface border border-t-0 border-border rounded-b-lg overflow-hidden">
    <% groups.each_with_index do |group, group_idx| %>
      <% if group[:type] == :collapsed %>
        <%# Collapsible section for unchanged code %>
        <div data-collapsed-section class="border-t border-border first:border-t-0">
          <button type="button"
                  data-action="click->diff-viewer#toggleCollapsed"
                  aria-expanded="false"
                  class="w-full px-3 py-1.5 text-left text-content-muted hover:bg-bg-elevated/50 transition-colors flex items-center gap-2">
            <span data-collapse-icon class="text-[10px]">â–¶</span>
            <span class="text-[10px]">Show <%= group[:count] %> unchanged line<%= group[:count] == 1 ? '' : 's' %></span>
          </button>
          <div data-collapsed-content class="hidden">
            <table class="w-full border-collapse">
              <% group[:lines].each do |line| %>
                <%= render_diff_line(line) %>
              <% end %>
            </table>
          </div>
        </div>
      <% else %>
        <%# Regular diff lines %>
        <table class="w-full border-collapse">
          <% group[:lines].each do |line| %>
            <%= render_diff_line(line) %>
          <% end %>
        </table>
      <% end %>
    <% end %>

    <% if groups.empty? %>
      <div class="px-4 py-8 text-center text-content-muted">
        <p>No diff content available</p>
      </div>
    <% end %>
  </div>
</div>
