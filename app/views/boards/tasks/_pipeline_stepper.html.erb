<%# Pipeline progress stepper - shows current pipeline stage and progress %>
<%
  return unless task.pipeline_enabled? && task.pipeline_stage.present? && Task::PIPELINE_STAGES.include?(task.pipeline_stage)

  stages = Task::PIPELINE_STAGES
  current_stage = task.pipeline_stage
  current_idx = stages.index(current_stage) || -1
  progress = stages.length > 0 ? ((current_idx + 1).to_f / stages.length * 100).round : 0

  stage_labels = {
    "triaged" => "Triaged",
    "context_ready" => "Context",
    "routed" => "Routed",
    "executing" => "Executing",
    "verifying" => "Verifying",
    "completed" => "Done",
    "failed" => "Failed"
  }

  stage_colors = {
    "completed" => "bg-emerald-500/20 text-emerald-400 border border-emerald-400/30",
    "current" => "bg-sky-500/20 text-sky-400 border border-sky-400 ring-2 ring-sky-400/30",
    "pending" => "bg-bg-elevated text-content-muted border border-border",
    "failed" => "bg-red-500/20 text-red-400 border border-red-400/30"
  }
%>

<div class="mb-4 rounded-lg border border-border bg-bg-elevated/50 px-4 py-3">
  <div class="flex items-center justify-between mb-2">
    <span class="text-xs font-medium text-content-secondary uppercase tracking-wide">
      Pipeline<%= " (#{task.pipeline_type})" if task.pipeline_type.present? %>
    </span>
    <span class="text-xs text-content-muted"><%= progress %>%</span>
  </div>

  <!-- Progress bar -->
  <div class="w-full h-1.5 bg-bg-elevated rounded-full mb-3 overflow-hidden">
    <div class="h-full rounded-full transition-all duration-500 <%= current_stage == 'failed' ? 'bg-red-500' : 'bg-emerald-500' %>"
         style="width: <%= progress %>%"></div>
  </div>

  <!-- Stage steps (mobile: allow horizontal touch scroll) -->
  <div class="relative pipeline-stepper-fade">
    <div data-testid="pipeline-strip"
         class="pipeline-stepper-scroll flex items-center gap-1 w-full min-w-0 overflow-x-auto overscroll-x-contain touch-pan-x [-webkit-overflow-scrolling:touch] pr-6">
    <% stages.each_with_index do |stage, idx| %>
      <%
        state = if current_stage == "failed" && idx == current_idx
                  "failed"
                elsif idx < current_idx
                  "completed"
                elsif idx == current_idx
                  "current"
                else
                  "pending"
                end
        color_class = stage_colors[state]
        label = stage_labels[stage] || stage.humanize
      %>
      <div class="flex items-center flex-shrink-0">
        <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium <%= color_class %>"
              title="<%= stage.humanize %><%= ' (current)' if state == 'current' %>">
          <%= label %>
        </span>
        <% if idx < stages.length - 1 %>
          <span class="mx-0.5 text-content-muted text-[10px]">&rarr;</span>
        <% end %>
      </div>
    <% end %>
    </div>
  </div>

  <% if task.routed_model.present? %>
    <div class="mt-2 text-[10px] text-content-muted">
      Model: <span class="text-sky-400"><%= task.routed_model %></span>
    </div>
  <% end %>
</div>
