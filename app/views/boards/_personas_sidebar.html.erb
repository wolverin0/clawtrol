<%# Agent Personas Bar with Category Groupings %>
<%# Required: @agent_personas %>
<% if @agent_personas.present? %>
  <%
    # Group personas by category (using tier when available, or inferring from name)
    def categorize_persona(persona)
      # First check explicit tier
      case persona.tier
      when 'strategic-reasoning' then 'review'
      when 'fast-coding' then 'dev'
      when 'research' then 'research'
      when 'operations' then 'ops'
      end || 
      # Then infer from name
      case persona.name.downcase
      when /dev|frontend|backend|architect|dashboard|whatsapp/ then 'dev'
      when /review|verifier|security|checker|tdd/ then 'review'
      when /research|roadmap|synthesizer|mapper/ then 'research'
      when /executor|runner|ops|updater|build|error|refactor|doc|clean/ then 'ops'
      when /plan|debug|summar/ then 'ops'
      else 'ops' # Default
      end
    end

    categories = {
      'dev' => { icon: 'ðŸ’»', label: 'Dev', color: 'blue', personas: [] },
      'ops' => { icon: 'ðŸ”§', label: 'Ops', color: 'orange', personas: [] },
      'research' => { icon: 'ðŸ”', label: 'Research', color: 'emerald', personas: [] },
      'review' => { icon: 'âœ…', label: 'Review', color: 'purple', personas: [] }
    }

    @agent_personas.each do |persona|
      cat = categorize_persona(persona)
      categories[cat][:personas] << persona if categories[cat]
    end

    # Remove empty categories
    categories.reject! { |_, v| v[:personas].empty? }
  %>

  <div class="flex items-center gap-2 px-4 md:px-6 py-2 bg-bg-surface border-b border-border"
       data-controller="agent-categories drag-assign"
       data-drag-assign-api-base-value="/api/v1">

    <%# Mobile: Single dropdown for all agents %>
    <div class="md:hidden relative flex-1">
      <button type="button"
              data-agent-categories-target="toggle"
              data-action="click->agent-categories#toggleMobileMenu"
              class="w-full flex items-center justify-between gap-2 px-3 py-2 rounded-md text-xs bg-bg-elevated hover:bg-bg-hover text-content-secondary transition-colors cursor-pointer"
              aria-expanded="false">
        <span class="flex items-center gap-2">
          <span>ðŸ¤–</span>
          <span>Agents</span>
          <span class="text-content-muted">(<%= @agent_personas.count %>)</span>
        </span>
        <svg data-chevron xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform">
          <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
        </svg>
      </button>

      <%# Mobile dropdown menu %>
      <div data-agent-categories-target="mobileMenu"
           class="hidden absolute left-0 right-0 top-full mt-1 bg-bg-surface border border-border rounded-lg shadow-xl z-50 max-h-80 overflow-y-auto">
        <% categories.each do |cat_key, cat_data| %>
          <div class="border-b border-border last:border-0">
            <div class="px-3 py-2 text-xs font-semibold text-content-muted bg-bg-elevated flex items-center gap-2">
              <span><%= cat_data[:icon] %></span>
              <span><%= cat_data[:label] %></span>
              <span class="text-content-muted">(<%= cat_data[:personas].count %>)</span>
            </div>
            <div class="p-2 flex flex-wrap gap-1.5">
              <% cat_data[:personas].each do |persona| %>
                <div draggable="true"
                     data-drag-assign-target="badge"
                     data-persona-id="<%= persona.id %>"
                     data-persona-name="<%= persona.name %>"
                     data-persona-emoji="<%= persona.emoji || 'ðŸ¤–' %>"
                     data-action="dragstart->drag-assign#dragStart dragend->drag-assign#dragEnd"
                     class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-medium whitespace-nowrap
                            bg-<%= persona.model_color %>-500/15 text-<%= persona.model_color %>-400 
                            border border-<%= persona.model_color %>-500/25
                            cursor-grab active:cursor-grabbing hover:scale-105 transition-transform select-none"
                     title="<%= persona.name %> (<%= persona.model_chain %>) â€” Drag onto a task to assign">
                  <span><%= persona.emoji || 'ðŸ¤–' %></span>
                  <span class="max-w-[100px] truncate"><%= persona.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%# Desktop: Category dropdowns %>
    <div class="hidden md:flex items-center gap-2 flex-1 min-w-0">
      <span class="text-xs text-content-muted font-medium flex-shrink-0">ðŸ¤– Agents:</span>
      
      <% categories.each do |cat_key, cat_data| %>
        <div class="relative">
          <button type="button"
                  data-agent-categories-target="category"
                  data-category="<%= cat_key %>"
                  data-action="click->agent-categories#toggleCategory"
                  class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs bg-bg-elevated hover:bg-bg-hover text-content-secondary transition-colors cursor-pointer"
                  aria-expanded="false">
            <span><%= cat_data[:icon] %></span>
            <span><%= cat_data[:label] %></span>
            <span class="text-content-muted text-[10px]">(<%= cat_data[:personas].count %>)</span>
            <svg data-chevron xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3 transition-transform">
              <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
            </svg>
          </button>

          <%# Category dropdown %>
          <div data-agent-categories-target="dropdown"
               data-category="<%= cat_key %>"
               class="hidden absolute left-0 top-full mt-1 bg-bg-surface border border-border rounded-lg shadow-xl z-50 min-w-[200px] max-w-[320px]">
            <div class="p-2 flex flex-wrap gap-1.5">
              <% cat_data[:personas].each do |persona| %>
                <div draggable="true"
                     data-drag-assign-target="badge"
                     data-persona-id="<%= persona.id %>"
                     data-persona-name="<%= persona.name %>"
                     data-persona-emoji="<%= persona.emoji || 'ðŸ¤–' %>"
                     data-action="dragstart->drag-assign#dragStart dragend->drag-assign#dragEnd"
                     class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] font-medium whitespace-nowrap
                            bg-<%= persona.model_color %>-500/15 text-<%= persona.model_color %>-400 
                            border border-<%= persona.model_color %>-500/25
                            cursor-grab active:cursor-grabbing hover:scale-105 transition-transform select-none"
                     title="<%= persona.name %> (<%= persona.model_chain %>) â€” Drag onto a task to assign">
                  <span><%= persona.emoji || 'ðŸ¤–' %></span>
                  <span class="max-w-[100px] truncate"><%= persona.name %></span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <%# "All" link to agents page %>
      <%= link_to agent_personas_path, 
          class: "inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs text-content-muted hover:text-content hover:bg-bg-elevated transition-colors",
          title: "Manage all agents" do %>
        <span>ðŸ“Š</span>
        <span>All (<%= @agent_personas.count %>)</span>
      <% end %>
    </div>
  </div>
<% end %>
