<% content_for :breadcrumb_standalone do %>
  Self-Audit Dashboard
<% end %>

<% content_for :head do %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<% end %>

<div class="py-6 space-y-4 text-content">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-display font-semibold">Self-Audit Dashboard</h1>
  </div>

  <div class="flex items-center gap-2 border-b border-border">
    <%= link_to audits_path(tab: "trends"), class: "px-3 py-2 text-sm border-b-2 #{@tab == 'trends' ? 'border-accent text-accent' : 'border-transparent text-content-muted hover:text-content'}" do %>
      Score Trends
    <% end %>
    <%= link_to audits_path(tab: "interventions"), class: "px-3 py-2 text-sm border-b-2 #{@tab == 'interventions' ? 'border-accent text-accent' : 'border-transparent text-content-muted hover:text-content'}" do %>
      Intervention Tracker
    <% end %>
  </div>

  <% if @tab == "trends" %>
    <% if @daily_reports.blank? %>
      <div class="bg-bg-surface rounded-xl border border-border p-8 text-center">
        <p class="text-content-secondary">No audit reports yet. Run your first self-audit to see trends here.</p>
      </div>
    <% else %>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-bg-surface rounded-xl border border-border p-4 lg:col-span-2" data-controller="audit-chart" data-audit-chart-data-value="<%= json_escape(@chart_data.to_json) %>">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-content">Overall Score Trend</h2>
            <% if @week_delta.present? %>
              <% positive = @week_delta >= 0 %>
              <span class="text-xs font-medium <%= positive ? 'text-green-400' : 'text-red-400' %>">
                <%= positive ? 'â†‘' : 'â†“' %> <%= @week_delta.abs %> WoW
              </span>
            <% end %>
          </div>
          <canvas data-audit-chart-target="line" class="w-full h-56"></canvas>
        </div>

        <div class="bg-bg-surface rounded-xl border border-border p-4">
          <h2 class="text-sm font-semibold mb-3 text-content">Category Sparklines</h2>
          <div class="space-y-3">
            <% @chart_data[:categories].each do |category, values| %>
              <% points = values.each_with_index.map { |v, i| "#{(i * 100.0 / [values.length - 1, 1].max).round(2)},#{(30 - (v.to_f / 10.0 * 30)).round(2)}" }.join(' ') %>
              <div>
                <div class="flex justify-between text-xs mb-1">
                  <span class="text-content-secondary"><%= category.to_s.humanize %></span>
                  <span class="text-content-muted"><%= values.last || 0 %></span>
                </div>
                <svg viewBox="0 0 100 30" class="w-full h-8 bg-bg-elevated rounded">
                  <polyline fill="none" stroke="currentColor" stroke-width="1.5" class="text-accent" points="<%= points %>" />
                </svg>
              </div>
            <% end %>
          </div>
        </div>

        <div class="bg-bg-surface rounded-xl border border-border p-4 lg:col-span-2" data-controller="audit-chart" data-audit-chart-data-value="<%= json_escape(@chart_data.to_json) %>">
          <h2 class="text-sm font-semibold mb-3 text-content">Anti-pattern Counts</h2>
          <canvas data-audit-chart-target="bar" class="w-full h-48"></canvas>
        </div>

        <div class="bg-bg-surface rounded-xl border border-border p-4">
          <h2 class="text-sm font-semibold mb-3 text-content">Worst Moments</h2>
          <% if @latest&.worst_moments.present? %>
            <ul class="list-disc list-inside space-y-1 text-sm text-content-secondary">
              <% @latest.worst_moments.each do |moment| %>
                <li><%= moment %></li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-sm text-content-muted">No worst moments recorded.</p>
          <% end %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="flex items-center justify-between">
      <div class="flex flex-wrap gap-2 text-xs">
        <span class="px-2 py-0.5 rounded-full bg-yellow-500/20 text-yellow-300 font-medium">ðŸŸ¡ Active: <%= @active_count %></span>
        <span class="px-2 py-0.5 rounded-full bg-green-500/20 text-green-300 font-medium">ðŸŸ¢ Resolved: <%= @resolved_count %></span>
        <span class="px-2 py-0.5 rounded-full bg-red-500/20 text-red-300 font-medium">ðŸ”´ Regressed: <%= @regressed_count %></span>
      </div>
      <button type="button" class="bg-accent hover:bg-accent/80 text-white rounded-lg px-3 py-1.5 text-xs font-medium" onclick="document.getElementById('add-intervention-modal').showModal()">Add Intervention</button>
    </div>

    <div class="bg-bg-surface rounded-xl border border-border p-0 overflow-hidden">
      <table class="min-w-full text-sm">
        <thead class="bg-bg-elevated text-content-secondary">
          <tr>
            <th class="text-left px-3 py-2">Rule</th>
            <th class="text-left px-3 py-2">Category</th>
            <th class="text-left px-3 py-2">Baseline</th>
            <th class="text-left px-3 py-2">Current</th>
            <th class="text-left px-3 py-2">Status</th>
            <th class="text-left px-3 py-2">Created</th>
            <th class="text-right px-3 py-2">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <% @interventions.each do |intervention| %>
            <% badge = case intervention.status
                      when 'resolved' then 'bg-green-500/20 text-green-300'
                      when 'regressed' then 'bg-red-500/20 text-red-300'
                      else 'bg-yellow-500/20 text-yellow-300'
                      end %>
            <tr data-controller="intervention-row">
              <td class="px-3 py-2 text-content"><%= intervention.rule %></td>
              <td class="px-3 py-2 text-content-secondary"><%= intervention.category %></td>
              <td class="px-3 py-2 text-content-secondary"><%= intervention.baseline_score || 'â€”' %></td>
              <td class="px-3 py-2 text-content-secondary"><%= intervention.current_score || 'â€”' %></td>
              <td class="px-3 py-2"><span class="px-2 py-0.5 rounded-full text-xs font-medium <%= badge %>"><%= intervention.status %></span></td>
              <td class="px-3 py-2 text-content-muted text-xs"><%= intervention.created_at.strftime('%Y-%m-%d') %></td>
              <td class="px-3 py-2 text-right space-x-2">
                <button type="button" class="text-xs text-content-secondary hover:text-content" data-action="intervention-row#toggle">Notes</button>
                <button type="button" class="text-xs text-accent hover:text-accent/80" onclick="document.getElementById('edit-intervention-<%= intervention.id %>').showModal()">Edit</button>
                <%= button_to "Delete", behavioral_intervention_path(intervention), method: :delete, class: "text-xs text-red-400 hover:text-red-300", form: { data: { turbo_confirm: 'Delete this intervention?' }, class: 'inline' } %>
              </td>
            </tr>
            <tr data-intervention-row-target="details" class="hidden bg-bg-elevated">
              <td colspan="7" class="px-3 py-2 text-xs text-content-secondary">
                <%= intervention.notes.presence || "No notes yet." %>
              </td>
            </tr>

            <dialog id="edit-intervention-<%= intervention.id %>" class="bg-bg-surface border border-border rounded-xl p-0 text-content w-full max-w-xl">
              <%= form_with model: intervention, url: behavioral_intervention_path(intervention), method: :patch, class: "p-4 space-y-3" do |f| %>
                <div class="flex items-center justify-between">
                  <h3 class="text-sm font-semibold">Edit Intervention</h3>
                  <button type="button" class="text-content-muted" onclick="this.closest('dialog').close()">âœ•</button>
                </div>
                <%= f.text_area :rule, rows: 2, class: "w-full bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                <div class="grid grid-cols-2 gap-2">
                  <%= f.text_field :category, class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                  <%= f.select :status, BehavioralIntervention::STATUSES, {}, class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                  <%= f.number_field :baseline_score, step: 0.1, min: 0, max: 10, placeholder: "Baseline", class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                  <%= f.number_field :current_score, step: 0.1, min: 0, max: 10, placeholder: "Current", class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                </div>
                <%= f.text_area :notes, rows: 3, placeholder: "Notes", class: "w-full bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
                <div class="flex justify-end gap-2">
                  <button type="button" onclick="this.closest('dialog').close()" class="px-3 py-1.5 text-xs rounded-lg border border-border text-content-secondary">Cancel</button>
                  <%= f.submit "Save", class: "bg-accent hover:bg-accent/80 text-white rounded-lg px-3 py-1.5 text-xs font-medium" %>
                </div>
              <% end %>
            </dialog>
          <% end %>

          <% if @interventions.blank? %>
            <tr>
              <td colspan="7" class="px-3 py-8 text-center text-content-muted">No interventions yet.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <dialog id="add-intervention-modal" class="bg-bg-surface border border-border rounded-xl p-0 text-content w-full max-w-xl">
      <%= form_with model: BehavioralIntervention.new, url: behavioral_interventions_path, class: "p-4 space-y-3" do |f| %>
        <div class="flex items-center justify-between">
          <h3 class="text-sm font-semibold">Add Intervention</h3>
          <button type="button" class="text-content-muted" onclick="this.closest('dialog').close()">âœ•</button>
        </div>
        <%= f.text_area :rule, rows: 2, required: true, placeholder: "Rule", class: "w-full bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
        <div class="grid grid-cols-2 gap-2">
          <%= f.text_field :category, required: true, placeholder: "Category", class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
          <%= f.select :status, BehavioralIntervention::STATUSES, { selected: 'active' }, class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
          <%= f.number_field :baseline_score, step: 0.1, min: 0, max: 10, placeholder: "Baseline", class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
          <%= f.number_field :current_score, step: 0.1, min: 0, max: 10, placeholder: "Current", class: "bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
        </div>
        <%= f.text_area :notes, rows: 3, placeholder: "Notes", class: "w-full bg-bg-elevated border border-border rounded-lg px-3 py-2 text-sm" %>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="this.closest('dialog').close()" class="px-3 py-1.5 text-xs rounded-lg border border-border text-content-secondary">Cancel</button>
          <%= f.submit "Create", class: "bg-accent hover:bg-accent/80 text-white rounded-lg px-3 py-1.5 text-xs font-medium" %>
        </div>
      <% end %>
    </dialog>
  <% end %>
</div>
