<%# Remove the task from the DOM %>
<%= turbo_stream.remove "task_#{@task_id}" %>

<%# Update progress bar and completed section visibility %>
<%= turbo_stream.append "tasks" do %>
  <script>
    (() => {
      // Update project-level progress bar
      window.dispatchEvent(new CustomEvent('task:deleted', {
        detail: {
          totalTasks: <%= @project.tasks.count %>,
          completedTasks: <%= @project.tasks.where(completed: true).count %>
        }
      }));

      // Update task list-level progress bar
      <% if @task_list_id %>
        <% task_list = @project.task_list %>
        <% task_list_total = task_list.tasks.count %>
        <% task_list_completed = task_list.tasks.completed.count %>
        const taskListId = <%= @task_list_id %>;
        const totalTasks = <%= task_list_total %>;
        const completedTasks = <%= task_list_completed %>;
        
        const progressBar = document.querySelector(`#progress-bar-${taskListId}`);
        if (progressBar) {
          const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
          progressBar.style.width = `${percentage}%`;
        }

        // Hide completed section if no completed tasks
        const completedSection = document.getElementById(`completed-section-${taskListId}`);
        if (completedSection && completedTasks === 0) {
          completedSection.classList.add('hidden');
        }
      <% end %>

      // Hide completed section if no completed tasks (for project-level)
      const completedSection = document.getElementById('completed-section');
      const completedTasks = <%= @project.tasks.completed.count %>;
      if (completedSection && completedTasks === 0) {
        completedSection.classList.add('hidden');
      }
    })();
  </script>
<% end %>

<%# Flash message %>
<%= turbo_stream.append "task-lists" do %>
  <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] pointer-events-none">
    <div data-controller="flash" class="py-1.5 px-3 bg-lime-50 dark:bg-lime-900/30 text-lime-600 dark:text-lime-400 text-xs font-medium rounded-md transition-opacity duration-500 shadow-sm whitespace-nowrap" role="alert">
      Task deleted
    </div>
  </div>
<% end %>

<%# Update sidebar badges %>
<%= render "application/sidebar_badges" %>
