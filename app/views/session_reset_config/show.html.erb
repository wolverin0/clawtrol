<% content_for :title, "Session Reset - clawdeck" %>
<% content_for :breadcrumb_standalone, "ğŸ”„ Session Reset Policy" %>

<div class="py-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-content">Session Reset Policy</h1>
      <p class="text-sm text-content-muted mt-1">
        Configure when and how agent sessions are reset â€” by time, idle duration, channel, or chat type.
      </p>
    </div>
  </div>

  <% if @error.present? %>
    <%= render "shared/error_alert", message: @error %>
  <% end %>

  <%= form_with url: session_reset_config_path, method: :patch, class: "space-y-6" do |f| %>

    <%# Reset Mode %>
    <div class="bg-bg-elevated border border-border rounded-xl p-5">
      <h3 class="text-base font-semibold text-content mb-4">â° Reset Mode</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <% [
          ["daily", "ğŸ“… Daily", "Reset at a specific hour each day. Gives a fresh context every morning."],
          ["idle", "ğŸ’¤ Idle", "Reset after N minutes of inactivity. Good for support bots."],
          ["never", "â™¾ï¸ Never", "Sessions persist until manually reset or compaction. Maximum context retention."]
        ].each do |value, label, desc| %>
          <label class="flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-colors
            <%= @reset_config[:mode] == value ? 'border-accent bg-accent/5' : 'border-border hover:border-accent/30' %>">
            <input type="radio" name="mode" value="<%= value %>"
                   class="mt-0.5 text-accent focus:ring-accent/40"
                   <%= "checked" if @reset_config[:mode] == value %>>
            <div>
              <div class="text-sm font-medium text-content"><%= label %></div>
              <div class="text-xs text-content-muted mt-1"><%= desc %></div>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <%# Timing Options %>
    <div class="bg-bg-elevated border border-border rounded-xl p-5">
      <h3 class="text-base font-semibold text-content mb-4">â±ï¸ Timing</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-content-muted mb-1">Reset Hour (0-23, for daily mode)</label>
          <div class="flex items-center gap-3">
            <input type="number" name="at_hour"
                   value="<%= @reset_config[:at_hour] %>"
                   min="0" max="23"
                   class="w-24 px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content focus:ring-2 focus:ring-accent/40">
            <span class="text-sm text-content-muted">
              = <%= "%02d:00" % @reset_config[:at_hour] %> local time
            </span>
          </div>

          <%# Visual timeline %>
          <div class="mt-3 relative h-8 bg-bg-base rounded-full border border-border overflow-hidden">
            <% reset_pct = (@reset_config[:at_hour] / 24.0 * 100).round %>
            <div class="absolute top-0 h-full w-0.5 bg-red-500" style="left: <%= reset_pct %>%"></div>
            <div class="absolute top-0 h-full bg-green-500/10" style="left: <%= reset_pct %>%; width: <%= 100 - reset_pct %>%"></div>
            <div class="absolute inset-0 flex items-center justify-between px-3 text-[10px] text-content-muted">
              <span>00:00</span>
              <span>06:00</span>
              <span>12:00</span>
              <span>18:00</span>
              <span>23:59</span>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm text-content-muted mb-1">Idle Timeout (minutes, for idle mode)</label>
          <input type="number" name="idle_minutes"
                 value="<%= @reset_config[:idle_minutes] %>"
                 min="5" max="1440"
                 class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content focus:ring-2 focus:ring-accent/40">
          <p class="text-xs text-content-muted mt-2">
            Reset session after this many minutes without messages.
            Current: <strong><%= @reset_config[:idle_minutes] %> min</strong>
            (<%= (@reset_config[:idle_minutes] / 60.0).round(1) %> hours)
          </p>
        </div>
      </div>
    </div>

    <%# Scope Options %>
    <div class="bg-bg-elevated border border-border rounded-xl p-5">
      <h3 class="text-base font-semibold text-content mb-4">ğŸ¯ Reset Scope</h3>

      <div class="space-y-4">
        <div class="flex items-center gap-3">
          <input type="hidden" name="reset_by_channel" value="false">
          <input type="checkbox" name="reset_by_channel" value="true"
                 id="reset_by_channel"
                 class="rounded border-border text-accent focus:ring-accent/40"
                 <%= "checked" if @reset_config[:reset_by_channel] %>>
          <label for="reset_by_channel" class="text-sm text-content">
            <strong>Reset by channel</strong> â€” separate reset timers per channel (Telegram, Discord, etc.)
          </label>
        </div>

        <div>
          <label class="block text-sm text-content-muted mb-2">Reset by chat type:</label>
          <div class="flex gap-4">
            <% [
              ["direct", "ğŸ“© Direct Messages"],
              ["group", "ğŸ‘¥ Group Chats"],
              ["thread", "ğŸ§µ Threads"]
            ].each do |value, label| %>
              <label class="flex items-center gap-2">
                <input type="checkbox" name="reset_by_type[]" value="<%= value %>"
                       class="rounded border-border text-accent focus:ring-accent/40"
                       <%= "checked" if @reset_config[:reset_by_type].include?(value) %>>
                <span class="text-sm text-content"><%= label %></span>
              </label>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# Per-channel overrides %>
    <% if @reset_config[:per_channel].any? %>
      <div class="bg-bg-elevated border border-border rounded-xl p-5">
        <h3 class="text-base font-semibold text-content mb-3">ğŸ“¡ Per-Channel Overrides</h3>
        <div class="space-y-2">
          <% @reset_config[:per_channel].each do |channel, cfg| %>
            <div class="flex items-center justify-between p-3 rounded-lg bg-bg-base border border-border text-sm">
              <span class="font-medium text-content capitalize"><%= channel %></span>
              <div class="flex gap-4 text-xs text-content-muted">
                <span>Mode: <strong class="text-content"><%= cfg[:mode] || "inherit" %></strong></span>
                <% if cfg[:at_hour] %><span>Hour: <strong class="text-content"><%= cfg[:at_hour] %></strong></span><% end %>
                <% if cfg[:idle_minutes] %><span>Idle: <strong class="text-content"><%= cfg[:idle_minutes] %>m</strong></span><% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="flex justify-end">
      <button type="submit"
              class="px-6 py-2 bg-accent text-white rounded-lg font-medium text-sm hover:bg-accent/80 transition-colors">
        ğŸ’¾ Save Policy
      </button>
    </div>
  <% end %>
</div>
