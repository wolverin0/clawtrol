<% content_for :title, "CLI Backends - clawdeck" %>
<% content_for :breadcrumb_standalone, "‚å®Ô∏è CLI Backends" %>

<div class="py-6 space-y-6">
  <div>
    <h1 class="text-xl font-bold text-content">CLI Backend Configuration</h1>
    <p class="text-sm text-content-muted mt-1">
      Configure text-only CLI backends for fallback processing ‚Äî command, args, model/session/image arg mappings.
    </p>
  </div>

  <% if @error.present? %>
    <%= render "shared/error_alert", message: @error %>
  <% end %>

  <% if @backends.empty? && @error.blank? %>
    <%= render "shared/empty_state",
      icon: "‚å®Ô∏è",
      title: "No CLI Backends Configured",
      description: "Add cliBackends in your OpenClaw config to use text-only CLI tools as fallback processors (e.g., claude-cli, custom CLIs)." %>
  <% else %>
    <%# Fallback chain visualization %>
    <div class="bg-bg-elevated border border-border rounded-xl p-4">
      <h3 class="text-sm font-semibold text-content mb-3">üîó Fallback Chain (priority order)</h3>
      <div class="flex items-center gap-2 flex-wrap">
        <% @backends.each_with_index do |backend, i| %>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1.5 rounded-lg text-sm font-mono
              <%= backend[:enabled] ? 'bg-green-500/10 text-green-400 border border-green-500/30' : 'bg-gray-500/10 text-gray-500 border border-gray-500/30 line-through' %>">
              <%= ERB::Util.html_escape(backend[:id]) %>
            </span>
            <% if i < @backends.size - 1 %>
              <span class="text-content-muted">‚Üí</span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="space-y-4">
      <% @backends.each do |backend| %>
        <div class="bg-bg-elevated border border-border rounded-xl p-5">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <span class="text-xl">‚å®Ô∏è</span>
              <div>
                <div class="text-sm font-medium text-content"><%= ERB::Util.html_escape(backend[:id]) %></div>
                <div class="text-xs text-content-muted">
                  <code class="bg-bg-base px-1 rounded"><%= ERB::Util.html_escape(backend[:command]) %></code>
                  <% if backend[:description].present? %>
                    ‚Äî <%= ERB::Util.html_escape(backend[:description]) %>
                  <% end %>
                </div>
              </div>
            </div>
            <span class="text-xs px-2 py-0.5 rounded-full
              <%= backend[:enabled] ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400' %>">
              <%= backend[:enabled] ? "Enabled" : "Disabled" %>
            </span>
          </div>

          <%= form_with url: cli_backends_path, method: :patch, class: "space-y-4" do |f| %>
            <input type="hidden" name="backend_id" value="<%= backend[:id] %>">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-content-muted mb-1">Command</label>
                <input type="text" name="command" value="<%= backend[:command] %>"
                       class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content font-mono focus:ring-2 focus:ring-accent/40"
                       placeholder="claude">
              </div>
              <div>
                <label class="block text-xs text-content-muted mb-1">Model Arg</label>
                <input type="text" name="model_arg" value="<%= backend[:model_arg] %>"
                       class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content font-mono focus:ring-2 focus:ring-accent/40"
                       placeholder="--model">
              </div>
              <div>
                <label class="block text-xs text-content-muted mb-1">Session Arg</label>
                <input type="text" name="session_arg" value="<%= backend[:session_arg] %>"
                       class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content font-mono focus:ring-2 focus:ring-accent/40"
                       placeholder="--session">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-xs text-content-muted mb-1">Image Arg</label>
                <input type="text" name="image_arg" value="<%= backend[:image_arg] %>"
                       class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content font-mono focus:ring-2 focus:ring-accent/40"
                       placeholder="--image">
              </div>
              <div>
                <label class="block text-xs text-content-muted mb-1">Fallback Priority</label>
                <input type="number" name="fallback_priority" value="<%= backend[:fallback_priority] %>"
                       min="0" max="100"
                       class="w-full px-3 py-2 bg-bg-base border border-border rounded-lg text-sm text-content focus:ring-2 focus:ring-accent/40">
              </div>
              <div class="flex items-center gap-2 self-end pb-2">
                <input type="hidden" name="enabled" value="false">
                <input type="checkbox" name="enabled" value="true"
                       id="enabled-<%= backend[:id] %>"
                       class="rounded border-border text-accent focus:ring-accent/40"
                       <%= "checked" if backend[:enabled] %>>
                <label for="enabled-<%= backend[:id] %>" class="text-sm text-content">Enabled</label>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="submit"
                      class="px-4 py-1.5 bg-accent text-white rounded-lg text-sm font-medium hover:bg-accent/80 transition-colors">
                üíæ Save
              </button>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
