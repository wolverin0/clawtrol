<% content_for :title, "#{@agent[:name]} · ZeroBitch" %>

<div class="py-6"
     data-controller="zerobitch-agent"
     data-zerobitch-agent-id-value="<%= @agent[:id] %>"
     data-zerobitch-agent-task-url-value="<%= zerobitch_agent_task_path(@agent[:id]) %>"
     data-zerobitch-agent-logs-url-value="<%= zerobitch_agent_logs_path(@agent[:id]) %>"
     data-zerobitch-agent-tasks-url-value="<%= zerobitch_agent_tasks_path(@agent[:id]) %>"
     data-zerobitch-agent-soul-url-value="<%= zerobitch_agent_soul_path(@agent[:id]) %>"
     data-zerobitch-agent-agents-url-value="<%= zerobitch_agent_agents_file_path(@agent[:id]) %>">

  <div class="flex items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold text-content"><%= @agent[:emoji] %> <%= @agent[:name] %></h1>
      <p class="text-sm text-content-muted mt-1 font-mono">ID: <%= @agent[:id] %> · <%= @agent[:container_name] %></p>
    </div>

    <div class="flex flex-wrap gap-2">
      <%= button_to "Start", start_zerobitch_agent_path(@agent[:id]), method: :post, class: "rounded-md bg-emerald-600 px-3 py-2 text-xs font-medium text-white hover:bg-emerald-500" %>
      <%= button_to "Stop", stop_zerobitch_agent_path(@agent[:id]), method: :post, class: "rounded-md bg-yellow-600 px-3 py-2 text-xs font-medium text-white hover:bg-yellow-500" %>
      <%= button_to "Restart", restart_zerobitch_agent_path(@agent[:id]), method: :post, class: "rounded-md bg-orange-600 px-3 py-2 text-xs font-medium text-white hover:bg-orange-500" %>
      <%= link_to "Memory", zerobitch_agent_memory_path(@agent[:id]), class: "rounded-md bg-indigo-600 px-3 py-2 text-xs font-medium text-white hover:bg-indigo-500" %>
      <%= button_to "Delete", zerobitch_agent_path(@agent[:id]), method: :delete, class: "rounded-md bg-red-700 px-3 py-2 text-xs font-medium text-white hover:bg-red-600", data: { turbo_confirm: "Delete agent #{@agent[:name]}?" } %>
    </div>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
    <div class="rounded-xl border border-border bg-bg-elevated p-3">
      <div class="text-[11px] text-content-muted">Provider</div>
      <div class="text-sm text-content mt-1"><%= @agent[:provider] %></div>
    </div>
    <div class="rounded-xl border border-border bg-bg-elevated p-3">
      <div class="text-[11px] text-content-muted">Model</div>
      <div class="text-sm text-content mt-1 break-all"><%= @agent[:model] %></div>
    </div>
    <div class="rounded-xl border border-border bg-bg-elevated p-3">
      <div class="text-[11px] text-content-muted">Memory</div>
      <div class="text-sm text-content mt-1"><%= @stats[:mem_usage].presence || "-" %></div>
    </div>
    <div class="rounded-xl border border-border bg-bg-elevated p-3">
      <div class="text-[11px] text-content-muted">CPU</div>
      <div class="text-sm text-content mt-1"><%= @stats[:cpu_percent].presence || "-" %></div>
    </div>
  </div>

  <div class="bg-bg-elevated border border-border rounded-xl overflow-hidden">
    <div class="border-b border-border px-4 py-2 flex gap-2 flex-wrap">
      <% [["overview", "Overview"], ["soul", "SOUL editor"], ["agents", "AGENTS editor"], ["task", "Send Task"], ["logs", "Logs"]].each do |tab_key, tab_label| %>
        <button type="button"
                data-zerobitch-agent-target="tab"
                data-tab="<%= tab_key %>"
                data-action="click->zerobitch-agent#switchTab"
                class="px-3 py-1.5 text-xs rounded-md border border-transparent text-content-muted hover:text-content hover:bg-bg-base transition-colors">
          <%= tab_label %>
        </button>
      <% end %>
    </div>

    <div class="p-4 space-y-4">
      <section data-zerobitch-agent-target="panel" data-panel="overview" class="space-y-4">
        <div>
          <h2 class="text-sm font-semibold text-content mb-2">Agent Metadata</h2>
          <pre class="rounded-lg border border-border bg-[#141424] p-3 text-xs text-content overflow-x-auto"><%= JSON.pretty_generate(@agent) %></pre>
        </div>
        <div>
          <h2 class="text-sm font-semibold text-content mb-2">config.toml</h2>
          <pre class="rounded-lg border border-border bg-[#141424] p-3 text-xs text-content overflow-x-auto min-h-48"><%= @config_content.presence || "# Config not generated yet" %></pre>
        </div>
      </section>

      <section data-zerobitch-agent-target="panel" data-panel="soul" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-content">SOUL.md</h2>
          <button type="button" data-action="click->zerobitch-agent#saveSoul" class="px-3 py-1.5 rounded-md text-xs bg-emerald-600 hover:bg-emerald-500 text-white">Save SOUL</button>
        </div>
        <textarea data-zerobitch-agent-target="soulTextarea" class="w-full min-h-[52vh] px-4 py-3 rounded-xl bg-[#1a1a2e] border border-border text-content text-sm font-mono leading-relaxed focus:outline-none focus:ring-2 focus:ring-accent/50 resize-y"><%= @soul_content %></textarea>
      </section>

      <section data-zerobitch-agent-target="panel" data-panel="agents" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm font-semibold text-content">AGENTS.md</h2>
          <button type="button" data-action="click->zerobitch-agent#saveAgents" class="px-3 py-1.5 rounded-md text-xs bg-emerald-600 hover:bg-emerald-500 text-white">Save AGENTS</button>
        </div>
        <textarea data-zerobitch-agent-target="agentsTextarea" class="w-full min-h-[52vh] px-4 py-3 rounded-xl bg-[#1a1a2e] border border-border text-content text-sm font-mono leading-relaxed focus:outline-none focus:ring-2 focus:ring-accent/50 resize-y"><%= @agents_content %></textarea>
      </section>

      <section data-zerobitch-agent-target="panel" data-panel="task" class="hidden space-y-3">
        <div class="grid md:grid-cols-[1fr_auto] gap-3 items-end">
          <div>
            <label class="block text-xs text-content-muted mb-1">Task prompt</label>
            <textarea data-zerobitch-agent-target="taskPrompt" class="w-full min-h-24 rounded-lg border border-border bg-bg-base px-3 py-2 text-sm text-content" placeholder="Ask this agent to do something..."></textarea>
          </div>
          <div>
            <label class="block text-xs text-content-muted mb-1">Timeout</label>
            <select data-zerobitch-agent-target="taskTimeout" class="rounded-lg border border-border bg-bg-base px-3 py-2 text-sm text-content">
              <% [30, 60, 120, 300].each do |seconds| %>
                <option value="<%= seconds %>" <%= "selected" if seconds == 60 %>><%= seconds %>s</option>
              <% end %>
            </select>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button type="button" data-action="click->zerobitch-agent#dispatchTask" data-zerobitch-agent-target="sendTaskButton" class="px-3 py-2 rounded-md text-xs bg-accent text-black font-semibold hover:opacity-90">Send Task</button>
          <span data-zerobitch-agent-target="taskStatus" class="text-xs text-content-muted"></span>
        </div>

        <div>
          <h3 class="text-xs font-semibold text-content-muted mb-1">Result</h3>
          <pre data-zerobitch-agent-target="taskResult" class="rounded-lg border border-border bg-[#141424] p-3 text-xs text-content min-h-40 whitespace-pre-wrap">Run a task to see output.</pre>
        </div>
      </section>

      <section data-zerobitch-agent-target="panel" data-panel="logs" class="hidden space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-xs text-content-muted">Container logs (tail 200)</div>
          <div class="flex items-center gap-2">
            <button type="button" data-action="click->zerobitch-agent#toggleLogs" data-zerobitch-agent-target="logsToggleButton" class="px-2 py-1 rounded-md border border-border text-xs text-content-muted hover:text-content">Auto-refresh: off</button>
            <button type="button" data-action="click->zerobitch-agent#refreshLogs" class="px-2 py-1 rounded-md bg-bg-base border border-border text-xs text-content">Refresh</button>
          </div>
        </div>
        <pre data-zerobitch-agent-target="logsOutput" class="rounded-lg border border-border bg-[#141424] p-3 text-xs text-content min-h-64 max-h-[60vh] overflow-auto whitespace-pre-wrap">Loading logs…</pre>
      </section>
    </div>

    <div class="border-t border-border px-4 py-2 text-xs text-content-muted" data-zerobitch-agent-target="globalStatus">Ready.</div>
  </div>
</div>
