<%
  agent_id = agent[:id].to_s
  agent_name = agent[:name].presence || "Agent"
  status = agent[:status].to_s
  status_label = agent[:status_label].presence || status.capitalize.presence || "Stopped"

  badge_classes = case status
  when "running" then "bg-emerald-500/15 text-emerald-400 border-emerald-500/30"
  when "stopped" then "bg-red-500/15 text-red-400 border-red-500/30"
  when "paused" then "bg-amber-500/15 text-amber-300 border-amber-500/30"
  when "restarting" then "bg-yellow-500/15 text-yellow-300 border-yellow-500/30"
  when "dead" then "bg-rose-500/15 text-rose-300 border-rose-500/30"
  else "bg-slate-500/15 text-slate-300 border-slate-500/30"
  end

  cron_entries = Array(agent[:cron_display]).compact
  cron_label = agent[:cron_source] == "native" ? "native" : "registry"

  ram_percent = agent[:ram_percent]
  ram_percent = ram_percent.to_s.gsub("%", "").to_f if ram_percent.is_a?(String)
  ram_percent = nil unless ram_percent.is_a?(Numeric)
  ram_percent = ram_percent&.round(1)
  ram_percent_label = ram_percent ? "#{ram_percent}%" : "â€”"
  ram_width = [[ram_percent.to_f, 0.0].max, 100.0].min

  restart_count = agent[:restart_count].nil? ? "â€”" : agent[:restart_count]
  template_value = agent[:template].to_s

  obs = agent[:observability].is_a?(Hash) ? agent[:observability] : {}
  obs_backend = obs[:backend].presence || obs["backend"].presence || "â€”"
  obs_details = obs.each_with_object([]) do |(key, value), arr|
    k = key.to_s
    next if k == "backend"
    next if value.blank?
    arr << "#{k}=#{value}"
  end

  sparkline = Array(agent[:sparkline_mem]).map { |v| v.to_f }
  sparkline_points = if sparkline.length > 1
    max = [sparkline.max.to_f, 1.0].max
    sparkline.each_with_index.map do |value, idx|
      x = ((idx.to_f / (sparkline.length - 1)) * 120).round(1)
      y = (24 - (value / max) * 22).round(1)
      "#{x},#{y}"
    end.join(" ")
  end

  detail_path = agent[:detail_path].presence || zerobitch_agent_path(agent_id)
%>

<div class="group bg-bg-elevated border border-border rounded-xl p-4 hover:border-accent/40 transition-colors cursor-pointer"
     data-agent-id="<%= agent_id %>"
     data-agent-name="<%= agent_name %>"
     data-action="click->zerobitch-fleet#openAgent">
  <div class="flex items-start justify-between gap-3">
    <div class="flex items-start gap-2 min-w-0">
      <input type="checkbox"
             class="mt-1 rounded border-border bg-bg-base"
             data-zerobitch-fleet-target="agentCheckbox"
             data-agent-id="<%= agent_id %>"
             data-action="click->zerobitch-fleet#consumeClick change->zerobitch-fleet#toggleSelection">

      <div class="min-w-0">
        <div class="flex items-center gap-2">
          <span class="text-xl"><%= agent[:emoji].presence || "ğŸ¤–" %></span>
          <h3 class="text-sm font-semibold text-content truncate"><%= agent_name %></h3>
          <% if agent[:skillforge] %>
            <span class="text-[10px] px-1.5 py-0.5 rounded-full border border-indigo-500/40 bg-indigo-500/10 text-indigo-200">Skillforge</span>
          <% end %>
        </div>

        <p class="text-xs text-content-muted mt-1 truncate"><%= agent[:role].presence || "â€”" %></p>

        <% if agent[:description].present? %>
          <p class="text-[11px] text-content-muted mt-1 line-clamp-2"><%= agent[:description] %></p>
        <% end %>

        <% if cron_entries.any? %>
          <div class="mt-1 text-[11px] text-emerald-300">
            <div>â± Cron (<%= cron_label %>):</div>
            <% cron_entries.each do |entry| %>
              <div class="truncate"><%= entry %></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <span class="px-2 py-0.5 rounded-full text-xs font-medium border <%= badge_classes %>"><%= status_label %></span>
  </div>

  <div class="mt-3 space-y-1 text-xs text-content-muted">
    <p><span class="text-content-secondary">Provider:</span> <%= agent[:provider].presence || "â€”" %></p>
    <p class="truncate"><span class="text-content-secondary">Model:</span> <%= agent[:model].presence || "â€”" %></p>
    <p><span class="text-content-secondary">Docker:</span> <%= status_label %> Â· Restarts: <%= restart_count %></p>
    <p><span class="text-content-secondary">RAM:</span> <%= agent[:ram_usage].presence || "â€”" %> / <%= agent[:ram_limit].presence || "â€”" %> (<%= ram_percent_label %>)</p>
    <div>
      <div class="w-full h-1.5 bg-bg-base rounded-full overflow-hidden border border-border/50">
        <div class="h-full bg-accent" style="width: <%= ram_width %>%"></div>
      </div>
      <p class="mt-1 text-[11px]">Usage: <%= ram_percent_label %> of <%= agent[:ram_limit].presence || "â€”" %></p>
    </div>
    <p><span class="text-content-secondary">Uptime:</span> <%= agent[:uptime].presence || "â€”" %></p>
    <p><span class="text-content-secondary">Last Activity:</span> <%= agent[:last_activity].presence || "No tasks yet" %></p>
    <p><span class="text-content-secondary">Observability:</span> <%= obs_backend %></p>
    <% if obs_details.any? %>
      <p class="text-[11px] text-content-muted">Obs: <%= obs_details.join(" Â· ") %></p>
    <% end %>
  </div>

  <div class="mt-4 grid grid-cols-2 gap-2" data-action="click->zerobitch-fleet#consumeClick">
    <button type="button" class="px-2 py-1.5 rounded-md text-xs bg-green-600/80 hover:bg-green-500 text-white" data-command="start" data-agent-id="<%= agent_id %>" data-action="click->zerobitch-fleet#invokeAction click->zerobitch-fleet#consumeClick">â–¶ï¸ Start</button>
    <button type="button" class="px-2 py-1.5 rounded-md text-xs bg-yellow-600/80 hover:bg-yellow-500 text-white" data-command="stop" data-agent-id="<%= agent_id %>" data-action="click->zerobitch-fleet#invokeAction click->zerobitch-fleet#consumeClick">â¹ Stop</button>
    <button type="button" class="px-2 py-1.5 rounded-md text-xs bg-orange-600/80 hover:bg-orange-500 text-white" data-command="restart" data-agent-id="<%= agent_id %>" data-action="click->zerobitch-fleet#invokeAction click->zerobitch-fleet#consumeClick">ğŸ”„ Restart</button>
    <button type="button" class="px-2 py-1.5 rounded-md text-xs bg-red-700/80 hover:bg-red-600 text-white" data-command="delete" data-agent-id="<%= agent_id %>" data-action="click->zerobitch-fleet#invokeAction click->zerobitch-fleet#consumeClick">ğŸ—‘ Delete</button>
  </div>

  <% if sparkline_points.present? %>
    <div class="mt-3 space-y-1" data-action="click->zerobitch-fleet#consumeClick">
      <div class="text-[10px] text-content-muted">Memory (1h)</div>
      <svg viewBox="0 0 120 24" class="w-full h-6 text-accent" preserveAspectRatio="none">
        <polyline fill="none" stroke="currentColor" stroke-width="1.5" points="<%= sparkline_points %>" />
      </svg>
    </div>
  <% end %>

  <details class="mt-3 rounded-md border border-border p-2" data-action="click->zerobitch-fleet#consumeClick">
    <summary class="text-xs text-content-secondary cursor-pointer">ğŸ§  Prompt template</summary>
    <textarea class="mt-2 w-full rounded-md border border-border bg-bg-base px-2 py-1 text-[11px] text-content min-h-24 resize-y"
              data-template-editor
              placeholder="Add a default prompt template..."><%= template_value %></textarea>
    <div class="mt-2 flex items-center justify-between">
      <button type="button"
              class="px-2 py-1 rounded-md text-[11px] bg-emerald-600/80 hover:bg-emerald-500 text-white"
              data-agent-id="<%= agent_id %>"
              data-action="click->zerobitch-fleet#saveTemplate click->zerobitch-fleet#consumeClick">Save template</button>
      <span class="text-[10px] text-content-muted" data-template-status></span>
    </div>
  </details>

  <button type="button"
          class="mt-3 inline-flex w-full items-center justify-center rounded-md px-3 py-2 text-sm font-medium bg-bg-base border border-border text-content hover:border-accent/40"
          data-agent-id="<%= agent_id %>"
          data-agent-name="<%= agent_name %>"
          data-action="click->zerobitch-fleet#openLogs click->zerobitch-fleet#consumeClick">ğŸ“œ Logs</button>

  <%= link_to "Send Task", detail_path,
      class: "mt-2 inline-flex w-full items-center justify-center rounded-md px-3 py-2 text-sm font-medium bg-accent hover:opacity-90 text-white",
      data: { action: "click->zerobitch-fleet#consumeClick" } %>
</div>
