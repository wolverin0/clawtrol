<% content_for(:breadcrumb_standalone) { "ğŸ“¦ Block Streaming" } %>

<div class="max-w-5xl mx-auto px-4 py-6 space-y-6" data-controller="block-streaming">

  <%# Header %>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-content font-display">Block Streaming Config</h1>
      <p class="text-sm text-content-muted mt-1">
        Configure how agent responses are chunked for messaging channels.
      </p>
    </div>
    <button type="button" data-action="click->block-streaming#save"
            class="px-3 py-1.5 text-xs font-medium bg-accent text-white rounded-md hover:bg-accent/80 transition-colors">
      ğŸ’¾ Save
    </button>
  </div>

  <div data-block-streaming-target="status" class="hidden text-xs px-3 py-2 rounded-md"></div>

  <%# Global Settings %>
  <section class="bg-bg-surface rounded-lg border border-border overflow-hidden">
    <div class="px-4 py-3 bg-bg-elevated border-b border-border flex items-center gap-2">
      <span class="text-lg">âš™ï¸</span>
      <h2 class="text-sm font-semibold text-content">Global Settings</h2>
    </div>
    <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-xs font-medium text-content-muted mb-1">Enabled</label>
        <select data-block-streaming-target="enabled"
                class="w-full text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none">
          <option value="true" <%= "selected" if @streaming_config[:enabled] %>>Yes</option>
          <option value="false" <%= "selected" unless @streaming_config[:enabled] %>>No</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-content-muted mb-1">Chunk Size (chars)</label>
        <input type="number" data-block-streaming-target="chunkSize"
               value="<%= @streaming_config[:chunk_size] %>"
               min="100" max="10000" step="100"
               class="w-full text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none" />
      </div>
      <div>
        <label class="block text-xs font-medium text-content-muted mb-1">Coalesce Delay (ms)</label>
        <input type="number" data-block-streaming-target="coalesceMs"
               value="<%= @streaming_config[:coalesce_ms] %>"
               min="0" max="5000" step="100"
               class="w-full text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none" />
      </div>
      <div>
        <label class="block text-xs font-medium text-content-muted mb-1">Split Strategy</label>
        <select data-block-streaming-target="splitOn"
                class="w-full text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none">
          <option value="paragraph" <%= "selected" if @streaming_config[:split_on] == "paragraph" %>>Paragraph</option>
          <option value="sentence" <%= "selected" if @streaming_config[:split_on] == "sentence" %>>Sentence</option>
          <option value="chars" <%= "selected" if @streaming_config[:split_on] == "chars" %>>Characters</option>
        </select>
      </div>
    </div>
  </section>

  <%# Per-Channel Overrides %>
  <section class="bg-bg-surface rounded-lg border border-border overflow-hidden">
    <div class="px-4 py-3 bg-bg-elevated border-b border-border flex items-center gap-2">
      <span class="text-lg">ğŸ“¡</span>
      <h2 class="text-sm font-semibold text-content">Per-Channel Overrides</h2>
    </div>
    <div class="p-4">
      <p class="text-xs text-content-muted mb-3">
        Override chunk size and coalesce delay per channel. Leave empty to use global defaults.
      </p>

      <% channels = @channels.any? ? @channels : %w[telegram discord whatsapp signal] %>
      <div class="space-y-2">
        <% channels.each do |channel| %>
          <% override = @streaming_config[:per_channel][channel] || {} %>
          <div class="flex items-center gap-3 bg-bg-base rounded px-3 py-2 border border-border">
            <span class="text-xs font-medium text-content w-24"><%= channel %></span>
            <div class="flex items-center gap-2 flex-1">
              <label class="text-xs text-content-muted whitespace-nowrap">Chunk:</label>
              <input type="number" placeholder="default"
                     data-channel="<%= channel %>" data-field="chunkSize"
                     value="<%= override["chunkSize"] || override["maxChunkChars"] %>"
                     class="w-20 text-xs text-content bg-bg-elevated rounded px-2 py-1 border border-border focus:border-accent focus:outline-none" />
            </div>
            <div class="flex items-center gap-2 flex-1">
              <label class="text-xs text-content-muted whitespace-nowrap">Delay:</label>
              <input type="number" placeholder="default"
                     data-channel="<%= channel %>" data-field="coalesceMs"
                     value="<%= override["coalesceMs"] || override["coalesceDelayMs"] %>"
                     class="w-20 text-xs text-content bg-bg-elevated rounded px-2 py-1 border border-border focus:border-accent focus:outline-none" />
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# Preview %>
  <section class="bg-bg-surface rounded-lg border border-border overflow-hidden">
    <div class="px-4 py-3 bg-bg-elevated border-b border-border flex items-center gap-2">
      <span class="text-lg">ğŸ‘ï¸</span>
      <h2 class="text-sm font-semibold text-content">Delivery Preview</h2>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-3 gap-3 mb-4">
        <div class="text-center">
          <div class="text-lg font-bold text-content"><%= @preview[:chunk_count] %></div>
          <div class="text-xs text-content-muted">chunks</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-bold text-content"><%= @preview[:estimated_delivery_ms] %>ms</div>
          <div class="text-xs text-content-muted">est. delivery</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-bold text-content"><%= @streaming_config[:chunk_size] %></div>
          <div class="text-xs text-content-muted">chars/chunk</div>
        </div>
      </div>

      <div class="space-y-2">
        <% @preview[:chunks]&.each_with_index do |chunk, i| %>
          <div class="bg-bg-base rounded px-3 py-2 border border-border">
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs font-medium text-content-muted">Chunk #<%= i + 1 %></span>
              <span class="text-xs text-content-muted"><%= chunk.length %> chars</span>
            </div>
            <p class="text-xs text-content truncate"><%= chunk.first(200) %><%= "..." if chunk.length > 200 %></p>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <%# JSON Preview %>
  <details class="bg-bg-surface rounded-lg border border-border overflow-hidden">
    <summary class="px-4 py-3 bg-bg-elevated border-b border-border cursor-pointer list-none flex items-center gap-2">
      <span class="text-lg">ğŸ“‹</span>
      <span class="text-sm font-semibold text-content">Raw Config JSON</span>
    </summary>
    <div class="p-4">
      <% streaming_raw_json = begin; JSON.pretty_generate(@streaming_config[:raw]); rescue; "{}"; end %>
      <pre data-block-streaming-target="jsonPreview"
           class="bg-bg-base rounded px-3 py-2 border border-border text-xs text-content font-mono overflow-x-auto max-h-40"><%= streaming_raw_json %></pre>
    </div>
  </details>
</div>
