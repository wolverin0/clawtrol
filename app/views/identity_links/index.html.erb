<% content_for(:breadcrumb_standalone) { "ğŸ”— Identity Links" } %>

<div class="max-w-5xl mx-auto px-4 py-6 space-y-6" data-controller="identity-links">

  <%# Header %>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-content font-display">Session Identity Links</h1>
      <p class="text-sm text-content-muted mt-1">
        Map the same person across channels so OpenClaw treats them as one user.
      </p>
    </div>
    <div class="flex items-center gap-2">
      <button type="button" data-action="click->identity-links#addGroup"
              class="px-3 py-1.5 text-xs font-medium bg-accent text-white rounded-md hover:bg-accent/80 transition-colors">
        + Add Link Group
      </button>
      <button type="button" data-action="click->identity-links#saveAll"
              class="px-3 py-1.5 text-xs font-medium bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
        ğŸ’¾ Save
      </button>
    </div>
  </div>

  <div data-identity-links-target="status" class="hidden text-xs px-3 py-2 rounded-md"></div>

  <%# Explanation %>
  <div class="bg-bg-surface rounded-lg border border-border p-4 text-xs text-content-muted">
    <p><strong>How it works:</strong> Each link group connects identities across channels. For example:</p>
    <p class="font-mono mt-1 text-content">["telegram:123456", "discord:789012", "signal:+5491155551234"]</p>
    <p class="mt-1">Messages from any of these IDs will be treated as the same person.</p>
  </div>

  <%# Link Groups %>
  <section>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-sm font-semibold text-content">Link Groups</h2>
      <span class="text-xs text-content-muted" data-identity-links-target="count">
        <%= @links.size %> group<%= @links.size == 1 ? "" : "s" %>
      </span>
    </div>

    <div data-identity-links-target="groupsList" class="space-y-3">
      <% if @links.any? %>
        <% @links.each_with_index do |group, i| %>
          <div class="bg-bg-surface rounded-lg border border-border p-4" data-group-index="<%= i %>">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs font-medium text-content-muted">Group #<%= i + 1 %></span>
              <button type="button" data-action="click->identity-links#removeGroup" data-index="<%= i %>"
                      class="text-xs text-content-muted hover:text-red-400 transition-colors">ğŸ—‘ï¸ Remove</button>
            </div>
            <div class="flex flex-wrap gap-2">
              <% group[:identities].each do |identity| %>
                <div class="flex items-center gap-1 bg-bg-base rounded-md px-3 py-1.5 border border-border">
                  <span class="text-sm"><%= channel_icon_for(identity[:channel]) %></span>
                  <span class="text-xs font-mono text-content"><%= identity[:channel] %>:</span>
                  <span class="text-xs font-mono text-accent"><%= identity[:id] %></span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="bg-bg-surface rounded-lg border border-border p-8 text-center" data-identity-links-target="emptyState">
          <span class="text-3xl">ğŸ”—</span>
          <p class="text-sm text-content-muted mt-2">No identity links configured.</p>
          <p class="text-xs text-content-muted mt-1">Click "Add Link Group" to connect identities across channels.</p>
        </div>
      <% end %>
    </div>
  </section>

  <%# Add/Edit Modal %>
  <div data-identity-links-target="editModal"
       class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/50"
       aria-modal="true" role="dialog">
    <div class="bg-bg-surface rounded-lg border border-border w-full max-w-lg shadow-xl mx-4">
      <div class="px-4 py-3 bg-bg-elevated border-b border-border flex items-center justify-between">
        <h3 class="text-sm font-semibold text-content">Add Identity Link Group</h3>
        <button type="button" data-action="click->identity-links#closeModal"
                class="text-content-muted hover:text-content">âœ•</button>
      </div>
      <div class="p-4 space-y-3">
        <p class="text-xs text-content-muted">Add 2+ identities in the format <code class="font-mono">channel:id</code></p>

        <div data-identity-links-target="identityInputs" class="space-y-2">
          <div class="flex gap-2">
            <select class="text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border" data-identity-channel>
              <% @available_channels.each do |ch| %>
                <option value="<%= ch %>"><%= ch %></option>
              <% end %>
            </select>
            <input type="text" placeholder="User ID (e.g., 123456)" data-identity-id
                   class="flex-1 text-sm text-content font-mono bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none" />
          </div>
          <div class="flex gap-2">
            <select class="text-sm text-content bg-bg-base rounded px-2 py-1.5 border border-border" data-identity-channel>
              <% @available_channels.each do |ch| %>
                <option value="<%= ch %>" <%= ch == @available_channels[1] ? "selected" : "" %>><%= ch %></option>
              <% end %>
            </select>
            <input type="text" placeholder="User ID" data-identity-id
                   class="flex-1 text-sm text-content font-mono bg-bg-base rounded px-2 py-1.5 border border-border focus:border-accent focus:outline-none" />
          </div>
        </div>

        <button type="button" data-action="click->identity-links#addIdentityRow"
                class="text-xs text-accent hover:text-accent/80 transition-colors">
          + Add another identity
        </button>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" data-action="click->identity-links#closeModal"
                  class="px-3 py-1.5 text-xs font-medium text-content-secondary border border-border rounded-md hover:bg-bg-elevated transition-colors">
            Cancel
          </button>
          <button type="button" data-action="click->identity-links#applyGroup"
                  class="px-3 py-1.5 text-xs font-medium bg-accent text-white rounded-md hover:bg-accent/80 transition-colors">
            Add Group
          </button>
        </div>
      </div>
    </div>
  </div>

  <%# JSON Preview %>
  <details class="bg-bg-surface rounded-lg border border-border overflow-hidden">
    <summary class="px-4 py-3 bg-bg-elevated border-b border-border cursor-pointer list-none flex items-center gap-2">
      <span class="text-lg">ğŸ“‹</span>
      <span class="text-sm font-semibold text-content">JSON Preview</span>
    </summary>
    <div class="p-4">
      <% identity_links_json = begin; JSON.pretty_generate(@links.map { |g| g[:identities].map { |i| i[:raw] } }); rescue; "[]"; end %>
      <pre data-identity-links-target="jsonPreview"
           class="bg-bg-base rounded px-3 py-2 border border-border text-xs text-content font-mono overflow-x-auto max-h-40"><%= identity_links_json %></pre>
    </div>
  </details>
</div>
