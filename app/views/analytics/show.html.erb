<% content_for :breadcrumb_standalone do %>
  Analytics
<% end %>

<div class="min-h-screen bg-background text-text p-6 space-y-6">
  <div class="flex items-center justify-between pb-4 border-b border-white/5">
    <h1 class="text-2xl font-bold tracking-tight flex items-center gap-3 text-white">ðŸ“Š COST ANALYTICS</h1>
    <div class="text-xs text-muted font-mono">
      Updated: <%= @generated_at&.strftime("%Y-%m-%d %H:%M") || "â€”" %>
    </div>
  </div>

  <%# Tab navigation %>
  <div class="flex items-center gap-4 border-b border-white/10">
    <%= link_to analytics_path(tab: "overview", period: @period),
        class: "px-4 py-2 text-sm font-medium border-b-2 transition-colors #{@tab == 'overview' ? 'border-accent text-accent' : 'border-transparent text-muted hover:text-content'}" do %>
      ðŸ“ˆ Overview
    <% end %>
    <%= link_to analytics_path(tab: "budget", period: @period),
        class: "px-4 py-2 text-sm font-medium border-b-2 transition-colors #{@tab == 'budget' ? 'border-accent text-accent' : 'border-transparent text-muted hover:text-content'}" do %>
      ðŸ’° Budget & Trends
      <% if defined?(@budget_alerts) && @budget_alerts&.any? %>
        <span class="ml-1 px-1.5 py-0.5 text-[10px] bg-red-500/20 text-red-300 rounded-full"><%= @budget_alerts.count %></span>
      <% end %>
    <% end %>
  </div>

  <% if @tab == "budget" %>
    <%= render "analytics/budget_tab" %>
  <% else %>

  <div class="flex items-center justify-between flex-wrap gap-3">
    <div class="flex gap-2">
      <% %w[24h 7d 30d all].each do |p| %>
        <%= link_to p, analytics_path(period: p),
          class: "px-3 py-1 rounded-lg text-sm transition-colors #{@period == p ? 'bg-accent text-white' : 'bg-bg-elevated text-content-muted hover:text-content'}" %>
      <% end %>
    </div>
    <div class="text-xs text-muted">Since <span class="font-mono text-text"><%= @start_time.strftime("%Y-%m-%d") %></span></div>
  </div>

  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-card border border-border rounded-xl p-4">
      <div class="text-2xl font-bold text-green-300"><%= number_to_currency(@total_cost || 0, unit: "$", precision: 4) %></div>
      <div class="text-sm text-muted">Total cost</div>
      <% if @projected_monthly %>
        <div class="text-[10px] text-muted mt-1">~<%= number_to_currency(@projected_monthly, unit: "$", precision: 2) %>/mo projected</div>
      <% end %>
    </div>
    <div class="bg-card border border-border rounded-xl p-4">
      <div class="text-2xl font-bold text-text"><%= number_with_delimiter(@total_tokens || 0) %></div>
      <div class="text-sm text-muted">Total tokens</div>
      <div class="text-[10px] text-muted mt-1"><%= @api_calls %> API calls</div>
    </div>
    <div class="bg-card border border-border rounded-xl p-4">
      <div class="text-2xl font-bold text-cyan-300"><%= number_with_delimiter(@total_input || 0) %></div>
      <div class="text-sm text-muted">Input tokens</div>
      <div class="text-[10px] text-muted mt-1"><%= @cache_hit_rate %>% cache hit</div>
    </div>
    <div class="bg-card border border-border rounded-xl p-4">
      <div class="text-2xl font-bold text-purple-300"><%= number_with_delimiter(@total_output || 0) %></div>
      <div class="text-sm text-muted">Output tokens</div>
      <% if @total_cache_read.to_i > 0 %>
        <div class="text-[10px] text-muted mt-1"><%= number_with_delimiter(@total_cache_read) %> cached</div>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-card border border-border rounded-lg p-4">
      <div class="flex items-center justify-between pb-2 border-b border-white/5">
        <h2 class="text-sm font-semibold text-text">Cost by model</h2>
        <span class="text-[10px] text-muted">CSS bar chart</span>
      </div>

      <% if @cost_by_model.present? %>
        <div class="mt-4 space-y-3">
          <% @cost_by_model.each do |model, cost| %>
            <% pct = @max_model_cost.to_f > 0 ? ((cost.to_f / @max_model_cost.to_f) * 100.0) : 0 %>
            <div class="flex items-center gap-3">
              <div class="w-28 text-xs text-muted font-mono truncate" title="<%= model %>"><%= model %></div>
              <div class="flex-1 h-6 bg-black/30 rounded overflow-hidden">
                <div class="h-full bg-accent/70" style="width:<%= pct.round(2) %>%"></div>
              </div>
              <div class="w-20 text-right text-xs font-mono text-text"><%= number_to_currency(cost.to_f, unit: "$", precision: 4) %></div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mt-4 text-xs text-muted italic">No usage found for this period.</div>
      <% end %>
    </div>

    <div class="bg-card border border-border rounded-lg p-4">
      <div class="flex items-center justify-between pb-2 border-b border-white/5">
        <h2 class="text-sm font-semibold text-text">Cost over time</h2>
        <span class="text-[10px] text-muted">Last <%= @period %></span>
      </div>

      <% if @daily_cost.present? %>
        <div class="mt-4 space-y-2">
          <% @daily_cost.each do |day, cost| %>
            <% pct = @max_daily_cost.to_f > 0 ? ((cost.to_f / @max_daily_cost.to_f) * 100.0) : 0 %>
            <div class="flex items-center gap-3">
              <div class="w-20 text-[11px] text-muted font-mono"><%= day.strftime("%m-%d") %></div>
              <div class="flex-1 h-5 bg-black/30 rounded overflow-hidden">
                <div class="h-full bg-green-500/60" style="width:<%= pct.round(2) %>%"></div>
              </div>
              <div class="w-20 text-right text-[11px] font-mono text-text"><%= number_to_currency(cost.to_f, unit: "$", precision: 4) %></div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="mt-4 text-xs text-muted italic">No daily usage.</div>
      <% end %>
    </div>
  </div>

  <div class="bg-card border border-border rounded-lg overflow-hidden">
    <div class="px-4 py-3 bg-white/5 border-b border-white/5 flex items-center justify-between">
      <h2 class="text-sm font-semibold text-text">Top expensive sessions</h2>
      <span class="text-[10px] text-muted">Tap to copy session id</span>
    </div>
    <div class="divide-y divide-white/5">
      <% Array(@top_sessions).each do |s| %>
        <div class="px-4 py-3 hover:bg-white/5 transition-colors" data-controller="clipboard">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div data-clipboard-target="source" class="text-xs font-mono text-text truncate"><%= s[:sessionId] %></div>
              <div class="text-[10px] text-muted">Tap copy</div>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-xs font-mono text-green-300"><%= number_to_currency(s[:cost].to_f, unit: "$", precision: 4) %></div>
              <button type="button" data-action="click->clipboard#copy" class="text-xs px-2 py-1 rounded border border-border bg-white/5 hover:bg-white/10">Copy</button>
            </div>
          </div>
        </div>
      <% end %>
      <% if Array(@top_sessions).empty? %>
        <div class="px-4 py-6 text-xs text-muted italic">No sessions with usage found.</div>
      <% end %>
    </div>
  </div>

  <% end %><%# end overview tab %>
</div>
