<% content_for :title, "Nodes - clawdeck" %>
<% content_for :breadcrumb_standalone, "üì± Paired Nodes" %>

<div class="py-6 space-y-6"
     data-controller="nodes-dashboard"
     data-nodes-dashboard-url-value="<%= api_v1_gateway_nodes_status_path %>">

  <%# Header %>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold text-content">Paired Nodes</h1>
      <p class="text-sm text-content-muted mt-1">
        Connected devices with camera, screen, location, and notification capabilities.
      </p>
    </div>
    <button data-action="nodes-dashboard#refresh"
            class="px-3 py-1.5 text-sm bg-accent/10 text-accent rounded-lg hover:bg-accent/20 transition-colors">
      ‚Üª Refresh
    </button>
  </div>

  <% if @error.present? %>
    <%= render "shared/error_alert", message: @error %>
  <% end %>

  <% if @nodes.empty? && @error.blank? %>
    <%= render "shared/empty_state",
      icon: "üì±",
      title: "No Nodes Paired",
      description: "Pair an iOS, Android, macOS, or headless device with OpenClaw to see it here. Nodes support camera, screen recording, location, and notifications." %>
  <% else %>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" data-nodes-dashboard-target="grid">
      <% @nodes.each do |node| %>
        <% node_id = node["id"] || node["nodeId"] || node["name"] || "unknown" %>
        <% is_online = if node.key?("connected")
             !!node["connected"]
           else
             node["status"].to_s.match?(/online|connected|active/)
           end %>
        <% platform = node["platform"] || node["os"] || "unknown" %>
        <% device_name = node["displayName"] || node["name"] || node["deviceName"] || node_id %>
        <% last_seen = node["lastSeen"] || node["lastHeartbeat"] || node["connectedAtMs"] %>

        <div class="bg-bg-elevated border border-border rounded-xl p-4 hover:border-accent/50 transition-colors">
          <%# Header %>
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2 min-w-0">
              <%
                platform_icon = case platform.to_s.downcase
                when /ios|iphone|ipad/ then "üçé"
                when /android/ then "ü§ñ"
                when /mac|darwin/ then "üíª"
                when /linux/ then "üêß"
                when /windows/ then "ü™ü"
                else "üì±"
                end
              %>
              <span class="text-lg"><%= platform_icon %></span>
              <span class="text-sm font-semibold text-content truncate"><%= device_name %></span>
            </div>
            <div class="flex items-center gap-1.5">
              <div class="w-2.5 h-2.5 rounded-full <%= is_online ? 'bg-emerald-400 animate-pulse' : 'bg-gray-500' %>"></div>
              <span class="text-xs <%= is_online ? 'text-emerald-400' : 'text-content-muted' %>">
                <%= is_online ? "Online" : "Offline" %>
              </span>
            </div>
          </div>

          <%# Details %>
          <div class="space-y-1.5 text-xs text-content-muted mb-3">
            <div class="flex justify-between">
              <span>Platform</span>
              <span class="text-content"><%= platform %></span>
            </div>
            <% if node["version"] %>
              <div class="flex justify-between">
                <span>Version</span>
                <span class="text-content"><%= node["version"] %></span>
              </div>
            <% end %>
            <% if last_seen %>
              <% last_seen_label = begin
                   raw = last_seen.to_s
                   if raw.match?(/^\d{10,13}$/)
                     ms = raw.to_i
                     ts = ms > 9_999_999_999 ? ms / 1000.0 : ms.to_f
                     "#{time_ago_in_words(Time.at(ts))} ago"
                   else
                     "#{time_ago_in_words(Time.parse(raw))} ago"
                   end
                 rescue StandardError
                   raw
                 end %>
              <div class="flex justify-between">
                <span>Last seen</span>
                <span class="text-content"><%= last_seen_label %></span>
              </div>
            <% end %>
          </div>

          <%# Capabilities badges %>
          <% capabilities = Array(node["capabilities"] || node["caps"] || []) %>
          <% if capabilities.any? %>
            <div class="flex flex-wrap gap-1 mb-3">
              <% capabilities.each do |cap| %>
                <%
                  cap_icon = case cap.to_s.downcase
                  when /camera/ then "üì∑"
                  when /screen/ then "üñ•Ô∏è"
                  when /location/ then "üìç"
                  when /notify|notification/ then "üîî"
                  when /sms/ then "üí¨"
                  when /canvas/ then "üé®"
                  else "‚ö°"
                  end
                %>
                <span class="px-1.5 py-0.5 text-[10px] bg-accent/10 text-accent rounded-full">
                  <%= cap_icon %> <%= cap %>
                </span>
              <% end %>
            </div>
          <% end %>

          <%# Quick Actions %>
          <% if is_online %>
            <div class="flex gap-2 pt-2 border-t border-border">
              <button class="flex-1 px-2 py-1 text-xs bg-bg-hover text-content rounded hover:bg-accent/10 hover:text-accent transition-colors"
                      data-action="nodes-dashboard#notify"
                      data-node-id="<%= node_id %>"
                      title="Send notification">
                üîî Notify
              </button>
              <button class="flex-1 px-2 py-1 text-xs bg-bg-hover text-content rounded hover:bg-accent/10 hover:text-accent transition-colors"
                      data-action="nodes-dashboard#cameraSnap"
                      data-node-id="<%= node_id %>"
                      title="Take camera snapshot">
                üì∑ Snap
              </button>
              <button class="flex-1 px-2 py-1 text-xs bg-bg-hover text-content rounded hover:bg-accent/10 hover:text-accent transition-colors"
                      data-action="nodes-dashboard#locate"
                      data-node-id="<%= node_id %>"
                      title="Get location">
                üìç Locate
              </button>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
