<style>
  /* Nightshift Terminal Theme - Custom properties for theme-aware colors */
  :root {
    --terminal-green: theme(colors.emerald.400);
    --terminal-amber: theme(colors.amber.400);
    --terminal-red: theme(colors.red.400);
    --terminal-cyan: theme(colors.sky.400);
    --terminal-blue: theme(colors.blue.500);
    --terminal-purple: theme(colors.purple.400);
  }

  /* Keyframe animations - must stay in CSS */
  @keyframes ns-pulse {
    0%, 100% { opacity: 1; } 50% { opacity: 0.7; }
  }
  .ns-brand-icon { animation: ns-pulse 3s infinite; }

  /* Terminal-specific styles that need custom CSS */
  .ns-brand {
    text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
  }
  .ns-card.selected {
    box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
  }
  .ns-card.selected .ns-checkbox {
    border-color: #34d399 !important;
    background-color: #34d399 !important;
  }
  .ns-card.selected .ns-checkmark {
    opacity: 1 !important;
    color: #0d1117;
  }
  .ns-launch:hover {
    box-shadow: 0 0 25px rgba(0, 255, 65, 0.6);
  }
  .ns-panel {
    box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5);
  }

  /* Badge color variants using CSS custom properties */
  .ns-badge-codex { color: var(--terminal-cyan); border-color: color-mix(in srgb, var(--terminal-cyan) 30%, transparent); background: color-mix(in srgb, var(--terminal-cyan) 10%, transparent); }
  .ns-badge-gemini, .ns-badge-gemini-flash { color: var(--terminal-green); border-color: color-mix(in srgb, var(--terminal-green) 30%, transparent); background: color-mix(in srgb, var(--terminal-green) 10%, transparent); }
  .ns-badge-opus { color: var(--terminal-purple); border-color: color-mix(in srgb, var(--terminal-purple) 30%, transparent); background: color-mix(in srgb, var(--terminal-purple) 10%, transparent); }
  .ns-badge-glm, .ns-badge-deepseek, .ns-badge-groq, .ns-badge-cerebras { color: var(--terminal-amber); border-color: color-mix(in srgb, var(--terminal-amber) 30%, transparent); background: color-mix(in srgb, var(--terminal-amber) 10%, transparent); }
  .ns-badge-freq { color: var(--terminal-cyan); border-color: color-mix(in srgb, var(--terminal-cyan) 20%, transparent); background: color-mix(in srgb, var(--terminal-cyan) 5%, transparent); }
  .ns-badge-freq.always { color: var(--terminal-amber); border-color: color-mix(in srgb, var(--terminal-amber) 30%, transparent); background: color-mix(in srgb, var(--terminal-amber) 10%, transparent); }
  .ns-badge-freq.weekly { color: var(--terminal-blue); border-color: color-mix(in srgb, var(--terminal-blue) 30%, transparent); background: color-mix(in srgb, var(--terminal-blue) 10%, transparent); }
  .ns-badge-cat { color: var(--text-muted, #8B949E); border-color: color-mix(in srgb, var(--text-muted, #8B949E) 20%, transparent); background: color-mix(in srgb, var(--text-muted, #8B949E) 5%, transparent); }
  .ns-badge-pending { color: var(--terminal-amber); border-color: color-mix(in srgb, var(--terminal-amber) 30%, transparent); background: color-mix(in srgb, var(--terminal-amber) 10%, transparent); }
  .ns-badge-running { color: var(--terminal-blue); border-color: color-mix(in srgb, var(--terminal-blue) 30%, transparent); background: color-mix(in srgb, var(--terminal-blue) 10%, transparent); }
  .ns-badge-completed { color: var(--terminal-green); border-color: color-mix(in srgb, var(--terminal-green) 30%, transparent); background: color-mix(in srgb, var(--terminal-green) 10%, transparent); }

  /* Days grid - custom layout */
  .ns-days-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 0.25rem;
    margin-bottom: 1rem;
  }
  .ns-days-grid label {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    margin: 0;
    font-size: 0.75rem;
  }
  .ns-days-grid input { width: auto; margin: 0; }
</style>

<div data-controller="nightshift">
  <% model_options = %w[opus codex gemini gemini-flash glm deepseek groq cerebras] %>
  <% week_days = [[1, 'Mon'], [2, 'Tue'], [3, 'Wed'], [4, 'Thu'], [5, 'Fri'], [6, 'Sat'], [7, 'Sun']] %>

  <%# Header %>
  <div class="flex justify-between items-center px-4 md:px-8 pt-6 pb-4">
    <div class="ns-brand flex items-center gap-3 text-2xl font-bold font-mono text-emerald-400">
      <span class="ns-brand-icon">ðŸŒ‘</span>
      NIGHTSHIFT
      <span class="text-content-muted font-normal text-sm">// MISSION CONTROL v2</span>
    </div>
    <div class="text-right text-sm text-content-muted font-mono">
      <div class="text-sky-400 font-semibold"><%= Date.today.iso8601 %></div>
      <div>STATUS: <span data-nightshift-target="systemStatus">ONLINE</span></div>
      <div class="text-xs"><%= @due_tonight_ids.size %> due tonight</div>
    </div>
  </div>

  <%# Toolbar %>
  <div class="flex gap-2 px-4 md:px-8 pb-2 flex-wrap items-center">
    <button class="border border-border text-content-muted px-3 py-1 rounded font-mono text-xs cursor-pointer hover:border-sky-400 hover:text-sky-400 transition-all active" data-action="click->nightshift#filterAll">All</button>
    <% @categories.each do |cat| %>
      <button class="border border-border text-content-muted px-3 py-1 rounded font-mono text-xs cursor-pointer hover:border-sky-400 hover:text-sky-400 transition-all" data-action="click->nightshift#filterCategory" data-category="<%= cat %>"><%= cat %></button>
    <% end %>
    <button class="bg-emerald-400/10 border border-emerald-400/30 text-emerald-400 px-3 py-1 rounded font-mono text-xs cursor-pointer hover:bg-emerald-400/20 ml-auto" data-action="click->nightshift#openModal">+ Add Mission</button>
  </div>

  <%# Card Grid %>
  <div class="grid grid-cols-1 md:grid-cols-[repeat(auto-fill,minmax(300px,1fr))] gap-6 px-4 md:px-8 py-4 max-w-[1400px] mx-auto pb-[200px]" data-nightshift-target="grid">
    <% @missions.each do |mission| %>
      <% selection = @selections[mission.id] %>
      <% is_due = @due_tonight_ids.include?(mission.id) %>
      <% is_selected = selection&.enabled? || is_due %>
      <div class="ns-card bg-bg-surface border border-border rounded-lg p-5 cursor-pointer transition-all flex flex-col gap-3 font-mono hover:border-content-muted hover:-translate-y-0.5 <%= 'selected border-emerald-400 bg-emerald-400/[0.03]' if is_selected %> <%= 'due-tonight border-l-[3px] border-l-amber-400' if is_due %>"
           data-action="click->nightshift#toggle"
           data-mission-id="<%= mission.id %>"
           data-mission-name="<%= mission.name %>"
           data-mission-description="<%= mission.description %>"
           data-mission-icon="<%= mission.icon %>"
           data-mission-model="<%= mission.model %>"
           data-mission-time="<%= mission.estimated_minutes %>"
           data-mission-frequency="<%= mission.frequency %>"
           data-mission-days="<%= (mission.days_of_week || []).join(',') %>"
           data-mission-category="<%= mission.category %>"
           data-mission-enabled="<%= mission.enabled %>"
           data-nightshift-target="card">
        <div class="flex justify-between items-start gap-4">
          <div class="ns-checkbox w-6 h-6 border-2 border-border rounded flex items-center justify-center shrink-0 transition-all bg-bg-base">
            <span class="ns-checkmark font-bold transition-all opacity-0">&#10003;</span>
          </div>
          <div>
            <div class="text-base font-semibold text-content">
              <%= mission.icon %> <%= mission.name %>
              <% if selection %>
                <span class="ns-badge ns-badge-status ns-badge-<%= selection.status %> text-xs px-2 py-0.5 rounded font-semibold uppercase tracking-wide border ml-2"><%= selection.status %></span>
              <% end %>
            </div>
          </div>
        </div>

        <div class="flex gap-1 justify-end" data-action="click->nightshift#stopPropagation">
          <button type="button" class="border border-border bg-transparent text-content-muted rounded px-2 py-1 text-sm cursor-pointer hover:border-sky-400 hover:text-sky-400" title="Edit mission" data-action="click->nightshift#openEditModal">&#9999;&#65039;</button>
          <%= button_to raw("&#128465;&#65039;"), nightshift_mission_path(mission), method: :delete,
              class: "border border-border bg-transparent text-content-muted rounded px-2 py-1 text-sm cursor-pointer hover:border-red-400 hover:text-red-400",
              form: { data: { turbo_confirm: "Delete mission '#{mission.name}'?" } },
              data: { action: "click->nightshift#stopPropagation" } %>
        </div>

        <div class="text-sm text-content-muted leading-relaxed flex-grow"><%= mission.description %></div>
        <div class="flex justify-between items-center mt-2 pt-3 border-t border-border/50 flex-wrap gap-1">
          <span class="ns-badge ns-badge-<%= mission.model %> text-[0.7rem] px-2 py-0.5 rounded uppercase font-semibold tracking-wide border"><%= mission.model %></span>
          <span class="ns-badge ns-badge-freq <%= mission.frequency %> text-[0.65rem] px-1.5 py-0.5 rounded"><%= mission.frequency %><%= " (#{mission.days_of_week.map { |d| %w[_ Mon Tue Wed Thu Fri Sat Sun][d] }.join(',')})" if mission.frequency == 'weekly' && mission.days_of_week.present? %></span>
          <span class="ns-badge ns-badge-cat text-[0.6rem] px-1.5 py-0.5 rounded"><%= mission.category %></span>
          <span class="text-sm text-content-muted">&#9201; ~<%= mission.estimated_minutes %>min</span>
        </div>
      </div>
    <% end %>
  </div>

  <%# Bottom Panel %>
  <div class="ns-panel fixed bottom-0 left-0 right-0 bg-bg-elevated border-t border-border px-4 md:px-8 py-4 z-[200] flex justify-between items-center backdrop-blur-sm font-mono flex-col md:flex-row gap-4">
    <div class="flex gap-8 items-center w-full md:w-auto justify-between md:justify-start">
      <button type="button" class="border border-content-muted text-content-muted px-4 py-2 rounded font-mono text-sm cursor-pointer hover:border-content hover:text-content" data-action="click->nightshift#toggleAll">Select All</button>
      <div>
        <div class="text-[0.7rem] text-content-muted uppercase tracking-widest">Missions</div>
        <div class="text-xl font-bold"><span data-nightshift-target="count">0</span> / <%= @missions.size %></div>
      </div>
      <div>
        <div class="text-[0.7rem] text-content-muted uppercase tracking-widest">Est. Time</div>
        <div class="text-xl font-bold text-sky-400" data-nightshift-target="time">0m</div>
      </div>
    </div>
    <button type="button" class="ns-launch bg-emerald-400 text-bg-base border-none px-6 py-3 font-bold text-sm uppercase tracking-wide rounded cursor-pointer transition-all font-mono w-full md:w-auto disabled:bg-border disabled:text-content-muted disabled:cursor-not-allowed disabled:shadow-none" data-action="click->nightshift#launch" data-nightshift-target="launchButton" disabled>
      SELECT MISSIONS
    </button>
  </div>

  <%# Add Mission Modal %>
  <div class="fixed inset-0 bg-black/70 z-[300] hidden items-center justify-center" data-nightshift-target="modal" data-action="click->nightshift#overlayClose">
    <div class="bg-bg-surface border border-border rounded-lg p-8 w-full max-w-[500px] font-mono max-h-[90vh] overflow-y-auto" data-action="click->nightshift#stopPropagation">
      <h3 class="text-emerald-400 mb-6 text-lg font-bold">&#10133; Add Mission</h3>
      <%= form_with url: nightshift_missions_path, method: :post, local: true do %>
        <label class="block text-content-muted text-sm mb-1">Name</label>
        <input type="text" name="nightshift_mission[name]" required class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">

        <label class="block text-content-muted text-sm mb-1">Description</label>
        <textarea name="nightshift_mission[description]" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 min-h-[80px] resize-y box-border"></textarea>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-content-muted text-sm mb-1">Icon</label>
            <input type="text" name="nightshift_mission[icon]" value="&#128295;" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
          </div>
          <div>
            <label class="block text-content-muted text-sm mb-1">Model</label>
            <select name="nightshift_mission[model]" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <% model_options.each do |model| %>
                <option value="<%= model %>"><%= model %></option>
              <% end %>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-content-muted text-sm mb-1">Category</label>
            <select name="nightshift_mission[category]" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <% @categories.each do |cat| %>
                <option value="<%= cat %>"><%= cat %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-content-muted text-sm mb-1">Est. Minutes</label>
            <input type="number" name="nightshift_mission[estimated_minutes]" value="30" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-content-muted text-sm mb-1">Frequency</label>
            <select name="nightshift_mission[frequency]" data-nightshift-target="createFrequency" data-action="change->nightshift#toggleCreateDays" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <% @frequencies.each do |freq| %>
                <option value="<%= freq %>"><%= freq %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-content-muted text-sm mb-1">Created By</label>
            <select name="nightshift_mission[created_by]" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <option value="user">user</option>
              <option value="system">system</option>
              <option value="autonomy">autonomy</option>
              <option value="saved_links">saved_links</option>
            </select>
          </div>
        </div>

        <div data-nightshift-target="createDaysWrap" style="display:none;">
          <label class="block text-content-muted text-sm mb-1">Days of Week</label>
          <div class="ns-days-grid">
            <% week_days.each do |day_num, day_label| %>
              <label>
                <input type="checkbox" name="nightshift_mission[days_of_week][]" value="<%= day_num %>">
                <span><%= day_label %></span>
              </label>
            <% end %>
          </div>
        </div>

        <label class="block text-content-muted text-sm mb-4">
          <input type="checkbox" name="nightshift_mission[enabled]" value="1" checked class="w-auto mr-1.5">Enabled
        </label>

        <div class="flex gap-2 justify-end">
          <button type="button" class="px-4 py-2 rounded font-mono text-sm cursor-pointer border border-border bg-transparent text-content-muted" data-action="click->nightshift#closeModal">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded font-mono text-sm cursor-pointer bg-emerald-400 text-bg-base border-none font-semibold">Create Mission</button>
        </div>
      <% end %>
    </div>
  </div>

  <%# Edit Mission Modal %>
  <div class="fixed inset-0 bg-black/70 z-[300] hidden items-center justify-center" data-nightshift-target="editModal" data-action="click->nightshift#overlayCloseEdit">
    <div class="bg-bg-surface border border-border rounded-lg p-8 w-full max-w-[500px] font-mono max-h-[90vh] overflow-y-auto" data-action="click->nightshift#stopPropagation">
      <h3 class="text-emerald-400 mb-6 text-lg font-bold">&#9999;&#65039; Edit Mission</h3>
      <%= form_with url: nightshift_mission_path(0), method: :patch, local: true, data: { nightshift_target: "editForm" } do %>
        <label class="block text-content-muted text-sm mb-1">Name</label>
        <input type="text" name="nightshift_mission[name]" required data-nightshift-target="editName" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">

        <label class="block text-content-muted text-sm mb-1">Description</label>
        <textarea name="nightshift_mission[description]" data-nightshift-target="editDescription" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 min-h-[80px] resize-y box-border"></textarea>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-content-muted text-sm mb-1">Icon</label>
            <input type="text" name="nightshift_mission[icon]" data-nightshift-target="editIcon" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
          </div>
          <div>
            <label class="block text-content-muted text-sm mb-1">Model</label>
            <select name="nightshift_mission[model]" data-nightshift-target="editModel" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <% model_options.each do |model| %>
                <option value="<%= model %>"><%= model %></option>
              <% end %>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="block text-content-muted text-sm mb-1">Category</label>
            <select name="nightshift_mission[category]" data-nightshift-target="editCategory" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
              <% @categories.each do |cat| %>
                <option value="<%= cat %>"><%= cat %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-content-muted text-sm mb-1">Est. Minutes</label>
            <input type="number" name="nightshift_mission[estimated_minutes]" data-nightshift-target="editMinutes" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
          </div>
        </div>

        <label class="block text-content-muted text-sm mb-1">Frequency</label>
        <select name="nightshift_mission[frequency]" data-nightshift-target="editFrequency" data-action="change->nightshift#toggleEditDays" class="w-full bg-bg-base border border-border text-content p-2 rounded font-mono text-sm mb-4 box-border">
          <% @frequencies.each do |freq| %>
            <option value="<%= freq %>"><%= freq %></option>
          <% end %>
        </select>

        <div data-nightshift-target="editDaysWrap" style="display:none;">
          <label class="block text-content-muted text-sm mb-1">Days of Week</label>
          <div class="ns-days-grid">
            <% week_days.each do |day_num, day_label| %>
              <label>
                <input type="checkbox" name="nightshift_mission[days_of_week][]" value="<%= day_num %>" data-nightshift-target="editDayCheckbox">
                <span><%= day_label %></span>
              </label>
            <% end %>
          </div>
        </div>

        <label class="block text-content-muted text-sm mb-4">
          <input type="checkbox" name="nightshift_mission[enabled]" value="1" data-nightshift-target="editEnabled" class="w-auto mr-1.5">Enabled
        </label>

        <div class="flex gap-2 justify-end">
          <button type="button" class="px-4 py-2 rounded font-mono text-sm cursor-pointer border border-border bg-transparent text-content-muted" data-action="click->nightshift#closeEditModal">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded font-mono text-sm cursor-pointer bg-emerald-400 text-bg-base border-none font-semibold">Save Mission</button>
        </div>
      <% end %>
    </div>
  </div>
</div>
