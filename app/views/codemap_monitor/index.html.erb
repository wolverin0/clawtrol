<%
  tasks_payload = @tasks.map do |task|
    {
      id: task.id,
      name: task.name,
      status: task.status,
      board_id: task.board_id,
      board_name: task.board&.name,
      url: task.board ? board_task_path(task.board, task) : "#"
    }
  end
%>

<div class="min-h-screen bg-bg"
     data-controller="codemap-monitor"
     data-codemap-monitor-tasks-value="<%= json_escape(tasks_payload.to_json) %>">
  <div class="max-w-6xl mx-auto px-6 py-6">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <h1 class="text-xl font-semibold text-content font-display">Codemap Live Monitor</h1>
        <p class="text-xs text-content-muted mt-1">Hotel view groups tasks by status with live room moves from WebSocket updates.</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <% if @tasks.any? %>
          <div class="flex items-center gap-1 rounded-full border border-border bg-bg-surface/70 p-1 text-[10px]">
            <button type="button"
                    data-codemap-monitor-target="hotelToggle"
                    data-action="click->codemap-monitor#showHotel"
                    class="px-2 py-1 rounded-full border transition">
              Hotel
            </button>
            <button type="button"
                    data-codemap-monitor-target="techToggle"
                    data-action="click->codemap-monitor#showTech"
                    class="px-2 py-1 rounded-full border transition">
              Tech
            </button>
          </div>
        <% end %>
        <%= link_to "Back to Boards", boards_path, class: "text-xs text-content-muted hover:text-content underline-offset-2 hover:underline" %>
      </div>
    </div>

    <div class="mt-4 text-[10px] text-content-muted">
      Showing <%= @tasks.size %> task<%= "s" unless @tasks.size == 1 %> with active agent signals.
    </div>

    <% if @tasks.any? %>
      <div class="mt-6" data-codemap-monitor-target="hotelPanel">
        <div class="rounded-2xl border border-border bg-bg-surface/60 p-4 shadow-sm">
          <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold text-content">Codemap Hotel</div>
              <p class="text-[10px] text-content-muted mt-1">Click a room guest to open its task.</p>
            </div>
            <div class="text-[10px] text-content-muted">Live status updates enabled</div>
          </div>
          <div class="w-full h-[420px] rounded-xl border border-border bg-slate-950/70 overflow-hidden" data-codemap-monitor-target="hotelFrame">
            <canvas data-codemap-monitor-target="hotelCanvas" class="w-full h-full block"></canvas>
          </div>
          <div class="mt-3 flex flex-wrap gap-2 text-[10px] text-content-muted">
            <span class="inline-flex items-center gap-1">
              <span class="h-2 w-2 rounded-sm" style="background-color: #94a3b8"></span>
              Inbox
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="h-2 w-2 rounded-sm" style="background-color: #38bdf8"></span>
              Up Next
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="h-2 w-2 rounded-sm" style="background-color: #f59e0b"></span>
              In Progress
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="h-2 w-2 rounded-sm" style="background-color: #f472b6"></span>
              In Review
            </span>
            <span class="inline-flex items-center gap-1">
              <span class="h-2 w-2 rounded-sm" style="background-color: #34d399"></span>
              Done
            </span>
          </div>
        </div>
      </div>

      <div class="mt-6 hidden" data-codemap-monitor-target="techPanel">
        <div class="grid gap-4 lg:grid-cols-2">
          <% @tasks.each do |task| %>
            <%
              focused = @focus_task_id.present? && @focus_task_id == task.id
              card_classes = ["rounded-xl border border-border bg-bg-surface/60 p-4 shadow-sm"]
              card_classes << "ring-1 ring-accent/60" if focused
            %>
            <div id="codemap-task-<%= task.id %>" class="<%= card_classes.join(' ') %>">
              <div class="flex items-start justify-between gap-3 mb-3">
                <div class="min-w-0">
                  <div class="text-sm font-semibold text-content truncate"><%= task.name %></div>
                  <div class="text-[10px] text-content-muted mt-1">
                    Board: <%= task.board&.name || "Unknown" %>
                  </div>
                </div>
                <div class="text-[10px] text-content-muted whitespace-nowrap">
                  <%= task.status.humanize %>
                </div>
              </div>

              <%= render "shared/codemap_widget",
                  task: task,
                  title: "Codemap",
                  wrapper_class: "mb-0",
                  height_class: "h-48",
                  show_monitor_link: false,
                  show_assets_hint: false %>

              <div class="mt-3 flex items-center justify-between text-[10px] text-content-muted">
                <%= link_to "Open Task", board_task_path(task.board, task), class: "text-accent hover:underline" %>
                <span>Updated <%= time_ago_in_words(task.updated_at) %> ago</span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="mt-10 rounded-xl border border-dashed border-border bg-bg-surface/40 p-10 text-center text-content-muted">
        <p class="text-sm">No active agent tasks yet.</p>
        <p class="text-xs mt-2">Start an agent run to populate live codemap panels.</p>
      </div>
    <% end %>
  </div>
</div>
