<% content_for :title, "#{@task.name} - Showcase" %>

<div class="h-screen flex flex-col bg-bg-base">
  <%# Header Bar %>
  <div class="flex-shrink-0 bg-bg-elevated border-b border-border px-4 py-3">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <%# Left: Back + Title %>
      <div class="flex items-center gap-4 min-w-0">
        <%= link_to showcases_path, class: "flex-shrink-0 p-2 text-content-muted hover:text-content hover:bg-bg-surface rounded-lg transition-colors" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        <% end %>
        
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <span class="text-lg">üèÜ</span>
            <h1 class="text-lg font-semibold text-content truncate"><%= @task.name %></h1>
          </div>
          <div class="flex items-center gap-2 text-xs text-content-muted">
            <span class="px-2 py-0.5 rounded-full <%= @task.in_review? ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400' %>">
              <%= @task.status.humanize %>
            </span>
            <% product = product_for_task(@task) %>
            <% if product %>
              <span class="px-2 py-0.5 rounded-full bg-accent/20 text-accent">
                <%= product %>
              </span>
            <% end %>
            <span>‚Ä¢</span>
            <span><%= @task.board&.name %></span>
            <span>‚Ä¢</span>
            <time datetime="<%= @task.updated_at.iso8601 %>">
              <%= @task.updated_at.strftime("%b %d, %Y %H:%M") %>
            </time>
          </div>
        </div>
      </div>
      
      <%# Right: Actions %>
      <div class="flex items-center gap-2">
        <% if @preview_content[:type] == :html %>
          <%= link_to raw_showcase_path(@task), 
              target: "_blank",
              class: "px-3 py-1.5 text-sm bg-bg-surface border border-border rounded-lg text-content-muted hover:text-content hover:border-accent transition-colors" do %>
            Open in New Tab ‚Üó
          <% end %>
        <% end %>
        
        <%= link_to board_task_path(@task.board, @task), 
            class: "px-3 py-1.5 text-sm bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors" do %>
          View Task
        <% end %>
      </div>
    </div>
  </div>

  <%# Preview Content %>
  <div class="flex-1 overflow-hidden">
    <% case @preview_type %>
    <% when :html %>
      <% if @preview_content[:multiple] %>
        <%# Multiple HTML files: Tabbed Gallery %>
        <div class="h-full flex flex-col" data-controller="showcase-tabs">
          <%# Tab Bar %>
          <div class="flex-shrink-0 bg-bg-surface border-b border-border px-4 py-2 overflow-x-auto">
            <div class="flex items-center gap-2">
              <span class="text-xs text-content-muted mr-2">Variants:</span>
              <% @preview_content[:all_files].each_with_index do |file, index| %>
                <button 
                  type="button"
                  class="px-3 py-1.5 text-sm rounded-lg transition-colors
                         <%= index == 0 ? 'bg-accent text-white' : 'bg-bg-elevated text-content-muted hover:text-content hover:bg-bg-elevated/80 border border-border' %>"
                  data-showcase-tabs-target="tab"
                  data-action="click->showcase-tabs#switchTab"
                  data-index="<%= index %>"
                  data-url="<%= raw_showcase_path(@task, file: file[:path]) %>">
                  <%= file[:label] %>
                </button>
              <% end %>
            </div>
          </div>
          
          <%# Single Iframe - src swapped by tabs controller %>
          <div class="flex-1 relative">
            <iframe 
              src="<%= raw_showcase_path(@task, file: @preview_content[:all_files].first[:path]) %>" 
              class="absolute inset-0 w-full h-full border-0 bg-white"
              sandbox="allow-scripts allow-same-origin"
              data-showcase-tabs-target="frame"
              title="Preview">
            </iframe>
          </div>
        </div>
      <% else %>
        <%# Single HTML file: Simple iframe %>
        <iframe 
          src="<%= raw_showcase_path(@task) %>" 
          class="w-full h-full border-0 bg-white"
          sandbox="allow-scripts allow-same-origin"
          title="HTML Preview">
        </iframe>
      <% end %>
      
    <% when :images %>
      <%# Image Gallery %>
      <div class="h-full overflow-auto p-6 bg-bg-surface">
        <div class="max-w-5xl mx-auto">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <% @preview_content[:files].each do |file| %>
              <div class="bg-bg-elevated border border-border rounded-lg overflow-hidden">
                <div class="aspect-video bg-black/50 flex items-center justify-center p-4">
                  <img 
                    src="<%= file[:url] %>" 
                    alt="<%= File.basename(file[:path]) %>"
                    class="max-w-full max-h-full object-contain"
                    loading="lazy">
                </div>
                <div class="p-3 border-t border-border">
                  <p class="text-sm text-content-muted truncate font-mono">
                    <%= file[:path] %>
                  </p>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
    <% when :markdown %>
      <%# Markdown Preview %>
      <div class="h-full overflow-auto">
        <div class="max-w-4xl mx-auto px-6 py-8">
          <%# Source indicator %>
          <% if @preview_content[:source] %>
            <div class="mb-4 text-xs text-content-muted flex items-center gap-2">
              <span class="px-2 py-1 bg-bg-elevated rounded">
                <%= @preview_content[:source] == :description ? "From task description" : "From agent output" %>
              </span>
              <% if @preview_content[:path] %>
                <span class="font-mono"><%= @preview_content[:path] %></span>
              <% end %>
            </div>
          <% end %>
          
          <%# Rendered Markdown %>
          <article class="prose prose-invert prose-lg max-w-none
                         prose-headings:font-display prose-headings:text-content
                         prose-p:text-content-secondary prose-p:leading-relaxed
                         prose-a:text-accent prose-a:no-underline hover:prose-a:underline
                         prose-code:text-pink-400 prose-code:bg-bg-elevated prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:before:content-none prose-code:after:content-none
                         prose-pre:bg-bg-elevated prose-pre:border prose-pre:border-border prose-pre:rounded-lg
                         prose-blockquote:border-accent prose-blockquote:text-content-muted
                         prose-li:text-content-secondary
                         prose-strong:text-content prose-strong:font-semibold
                         prose-table:border prose-table:border-border prose-thead:bg-bg-elevated prose-th:px-4 prose-th:py-2 prose-td:px-4 prose-td:py-2 prose-td:border prose-td:border-border">
            <%= render_markdown(@preview_content[:content]) %>
          </article>
        </div>
      </div>
      
    <% else %>
      <%# No Preview Available %>
      <div class="h-full flex items-center justify-center">
        <div class="text-center p-8">
          <span class="text-6xl mb-4 block">ü§∑</span>
          <h2 class="text-xl font-semibold text-content mb-2">No Preview Available</h2>
          <p class="text-content-muted max-w-md">
            This task doesn't have any previewable content. Check the task details for more information.
          </p>
          <%= link_to "View Task Details", board_task_path(@task.board, @task), 
              class: "inline-block mt-4 px-4 py-2 bg-accent text-white rounded-lg hover:bg-accent/90 transition-colors" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
