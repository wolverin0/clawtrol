<% content_for :title, "Settings" %>
<% content_for :breadcrumb_standalone, "Settings" %>

<div class="space-y-6 mt-12">
  <!-- Section 1: Profile -->
  <div class="bg-bg-surface border border-border rounded-lg p-5 space-y-4">
    <h3 class="text-xs font-medium text-content-muted uppercase tracking-wider font-display">Profile</h3>

    <%= form_with(model: @user, url: settings_path, method: :patch, class: "space-y-4") do |form| %>
      <!-- Avatar -->
      <div>
        <label class="block text-xs font-medium text-content-secondary mb-2">Avatar</label>
        <div class="flex items-center gap-4">
          <% if @user.has_avatar? %>
            <%= image_tag @user.avatar_source, class: "w-14 h-14 object-cover rounded-full" %>
          <% else %>
            <div class="w-14 h-14 rounded-full bg-bg-elevated flex items-center justify-center">
              <svg class="w-7 h-7 text-content-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>
            </div>
          <% end %>
          <div class="flex-1">
            <%= form.file_field :avatar, accept: "image/jpeg,image/jpg,image/png,image/webp", class: "block w-full text-xs text-content-secondary file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-medium file:bg-bg-elevated file:text-content-secondary hover:file:bg-bg-hover file:cursor-pointer file:transition-colors" %>
            <p class="text-xs text-content-muted mt-1">Max 512KB, 256x256px. JPEG, PNG, or WebP.</p>
          </div>
        </div>
        <% if @user.avatar.attached? || @user.avatar_url.present? %>
          <div class="mt-3">
            <label class="flex items-center text-xs text-content-secondary cursor-pointer">
              <%= form.check_box :remove_avatar, class: "mr-2 rounded border-border bg-bg-elevated text-accent focus:ring-accent focus:ring-offset-bg-surface" %>
              Remove avatar
            </label>
          </div>
        <% end %>
        <% if @user.errors[:avatar].any? %>
          <div class="mt-2">
            <% @user.errors[:avatar].each do |error| %>
              <p class="text-status-error text-xs">Avatar <%= error %></p>
            <% end %>
          </div>
        <% end %>
      </div>

      <!-- Email -->
      <div class="pt-4 border-t border-border">
        <label class="block text-xs font-medium text-content-secondary mb-1.5">Email Address</label>
        <%= form.email_field :email_address, placeholder: "your@email.com", class: "block w-full bg-bg-elevated border-0 rounded-md px-3 py-2 text-sm text-content placeholder:text-content-muted focus:ring-1 focus:ring-accent focus:outline-none" %>
        <% if @user.errors[:email_address].any? %>
          <div class="mt-1">
            <% @user.errors[:email_address].each do |error| %>
              <p class="text-status-error text-xs">Email <%= error %></p>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="pt-2">
        <%= form.submit "Save profile", class: "cursor-pointer px-4 py-2 bg-accent text-content hover:bg-accent-hover text-xs font-semibold rounded-md transition-colors duration-200" %>
      </div>
    <% end %>
  </div>

  <!-- Section 2: OpenClaw Integration -->
  <div class="bg-bg-surface border border-border rounded-lg p-5 space-y-4">
    <div class="flex items-center gap-2">
      <span class="text-lg">ðŸ¦ž</span>
      <h3 class="text-sm font-semibold text-content font-display">OpenClaw Integration</h3>
    </div>

    <p class="text-xs text-content-secondary">
      Connect your OpenClaw agent to ClawDeck. Copy the prompt below and add it to your agent's configuration.
    </p>

    <% api_url = "#{request.base_url}/api/v1" %>
    <% api_token = @api_token.token %>

    <!-- Comprehensive agent prompt -->
    <div data-controller="clipboard">
      <div class="bg-bg-elevated rounded-md max-h-96 overflow-y-auto">
        <pre
          data-clipboard-target="source"
          class="px-3 py-3 text-xs font-mono text-content-secondary whitespace-pre-wrap break-words leading-relaxed"
># ClawDeck â€” Your Task Dashboard

ClawDeck is where your human manages your work queue. Think of it as your shared kanban board with live agent activity tracking.

## How it works

1. Your human creates tasks and organizes them on the board
2. Your human explicitly assigns tasks to you when ready
3. You poll for assigned tasks and work on them
4. You update progress and mark things done
5. Your human sees everything in real-time, including live agent activity

## Connection

- **API URL:** <%= api_url %>
- **Token:** <%= api_token %>
- **Auth Header:** `Authorization: Bearer <%= api_token %>`

## Identify yourself

Include these headers with every request so your human knows who's connected:
- `X-Agent-Name`: Your name (e.g., "<%= @user.agent_name.presence || "OpenClaw" %>")
- `X-Agent-Emoji`: Your emoji (e.g., "<%= @user.agent_emoji.presence || "ðŸ¦ž" %>")

## Your workflow

### Polling for assigned tasks (every 30s or on heartbeat):
1. Call `GET /tasks?assigned=true` to get tasks assigned to you
2. Pick the first task (oldest assignment)
3. Move it to "in_progress" and start working
4. If spawning a sub-agent, save the `agent_session_id` to enable live view

### When working on a task:
- **Need help:** Set `blocked: true` â€” your human will unblock you
- **Finished:** Move to "in_review" (needs human review) or "done" (complete)
- **Sub-agents:** Update `agent_session_id` with the OpenClaw session ID for live activity tracking

### You can also:
- Create new tasks (ideas, follow-ups, things you noticed)
- Check task details and history
- Set model preferences for task routing

## API Reference

**Get assigned tasks (your work queue):**
`GET /tasks?assigned=true`
Returns tasks assigned to you, ordered by assignment time (oldest first).

**List all tasks:**
`GET /tasks` or `GET /tasks?status=in_progress`

**Get task:**
`GET /tasks/:id`

**Update task:**
`PATCH /tasks/:id`
Body: `{ "status": "in_progress" }` or `{ "blocked": true }` or `{ "agent_session_id": "..." }`

**Complete task:**
`PATCH /tasks/:id/complete`

**Create task:**
`POST /tasks`
Body: `{ "name": "Task title", "status": "inbox", "model": "opus" }`

**Get agent activity log (live view):**
`GET /tasks/:id/agent_log`
Returns transcript messages from the agent working on this task.
Supports `?since=N` for polling efficiency.

**Get recurring task templates:**
`GET /tasks/recurring`

## Task Fields
- `name` â€” Task title
- `description` â€” Task details/notes
- `status` â€” inbox, up_next, in_progress, in_review, done
- `priority` â€” none, low, medium, high
- `model` â€” Preferred model: opus, codex, gemini, glm, sonnet (or null for default)
- `agent_session_id` â€” OpenClaw session ID for live activity tracking
- `recurring` â€” Boolean, enables auto-recreation
- `recurrence_rule` â€” daily, weekly, monthly
- `recurrence_time` â€” HH:MM for scheduled tasks

## Model Routing
When a task has a `model` field, use that model for the work:
- `opus` â†’ Complex reasoning, orchestration
- `codex` â†’ Code generation, refactoring
- `gemini` â†’ Research, analysis
- `glm` â†’ Simple tasks, bulk operations
- `sonnet` â†’ General purpose

## Live Activity Tracking
To enable live view in the ClawDeck UI:
1. When spawning a sub-agent, get its session ID
2. Update the task: `PATCH /tasks/:id` with `{ "agent_session_id": "<session-id>" }`
3. Your human can watch the agent work in real-time from the task modal

## Tips
- Poll for assigned tasks frequently â€” your human assigns work explicitly
- When stuck, mark blocked â€” your human will unblock you
- Create tasks for things you notice but can't tackle now
- Always set agent_session_id when spawning sub-agents for visibility</pre>
      </div>
      <div class="flex items-center gap-3 mt-2">
        <button
          type="button"
          data-action="click->clipboard#copy"
          class="cursor-pointer px-3 py-1.5 bg-bg-elevated hover:bg-bg-hover text-content-secondary text-xs font-medium rounded-md transition-colors"
        >
          <span data-clipboard-target="label">Copy</span>
        </button>
        <%= button_to "Regenerate token", regenerate_api_token_settings_path,
            method: :post,
            data: { turbo_confirm: "This will invalidate your current token. Continue?" },
            class: "cursor-pointer text-xs text-content-muted hover:text-content-secondary transition-colors" %>
      </div>
    </div>

    <!-- Connected Agent (within same box) -->
    <div class="pt-4 border-t border-border">
      <p class="text-xs font-medium text-content-secondary mb-3">Connected Agent</p>

      <% if @user.agent_last_active_at.present? %>
        <div class="flex items-center gap-3">
          <span class="text-xl"><%= @user.agent_emoji || "ðŸ¦ž" %></span>
          <span class="text-sm text-content"><%= @user.agent_name || "Agent" %></span>
          <span class="text-xs text-content-muted">â€¢</span>
          <span class="text-xs text-content-muted">Last active: <%= time_ago_in_words(@user.agent_last_active_at) %> ago</span>
        </div>
      <% else %>
        <p class="text-xs text-content-muted">No agent connected yet</p>
      <% end %>
    </div>
  </div>
</div>
