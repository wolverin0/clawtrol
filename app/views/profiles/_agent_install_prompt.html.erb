<%# Always-available "agent self-awareness" prompts for OpenClaw orchestration. %>
<% api_url = "#{request.base_url}/api/v1" %>
<% api_token_value = api_token&.raw_token.presence || api_token&.masked_token %>
<% hooks_token_value = (current_user&.admin? ? Rails.application.config.hooks_token.to_s : "") %>
<% nightly_window = "23:00-08:00 America/Argentina/Buenos_Aires (UTC-3)" %>

<div class="bg-bg-surface border border-border rounded-lg p-5 space-y-4">
  <div class="flex items-center gap-2">
    <span class="text-lg">ðŸ“‹</span>
    <h3 class="text-sm font-semibold text-content font-display">OpenClaw Install Prompt</h3>
    <span class="text-[10px] text-content-muted bg-bg-elevated px-1.5 py-0.5 rounded-full uppercase tracking-wider">Copy</span>
  </div>

  <p class="text-xs text-content-secondary">
    Use these prompt blocks to keep OpenClaw aligned with ClawTrol's API, lifecycle rules, follow-up policy, and nightly window.
  </p>

  <div data-controller="clipboard" class="space-y-2">
    <div class="bg-bg-elevated rounded-md max-h-72 overflow-y-auto">
      <pre data-clipboard-target="source" class="px-3 py-3 text-[10px] font-mono text-content-secondary whitespace-pre-wrap break-words leading-relaxed"># ClawTrol OpenClaw Workflow Contract (paste into OpenClaw system prompt)
BASE_URL: <%= request.base_url %>
API_URL: <%= api_url %>
AUTH: "Authorization: Bearer <YOUR_API_TOKEN>"
YOUR_API_TOKEN: <%= api_token_value.to_s %>
NIGHTLY_WINDOW: "<%= nightly_window %>"

# Hooks auth (server-side callbacks)
<% if hooks_token_value.present? %>HOOKS_TOKEN: <%= hooks_token_value %>
HOOKS_AUTH: "X-Hook-Token: <HOOKS_TOKEN>"<% else %>HOOKS_TOKEN: (ask your ClawTrol admin or set HOOKS_TOKEN on the server)
HOOKS_AUTH: "X-Hook-Token: <HOOKS_TOKEN>"<% end %>

# Authority model:
# - OpenClaw is the orchestrator (claim/pick/execute/report).
# - ClawTrol is the source of task state and reporting UI.
# - Do not silently finish runs.

# Mandatory completion contract for EVERY run (always in this order):
# 1) POST /api/v1/hooks/task_outcome
#    - must include needs_follow_up true|false
#    - must include recommended_action
#    - if recommended_action=requeue_same_task, include next_prompt
# 2) POST /api/v1/hooks/agent_complete
#    - includes findings/session/output_files
#    - persists output and transitions task to in_review

# Follow-up policy:
# - No kanban bloat: reuse same task card when follow-up is needed.
# - Never auto-requeue without explicit human approval in Telegram.
# - Human-approved follow-up action: POST /api/v1/tasks/:id/requeue

# Nightly policy:
# - Nightly tasks are eligible only during NIGHTLY_WINDOW.
# - Respect nightly_delay_hours before execution.

# Useful endpoints:
# - GET  /api/v1/tasks?status=up_next&assigned=true&blocked=false
# - PATCH /api/v1/tasks/:id
# - POST /api/v1/tasks/:id/requeue
# - POST /api/v1/tasks/:id/link_session
# - GET  /api/v1/tasks/:id/agent_log</pre>
    </div>

    <div class="flex items-center gap-2">
      <button type="button"
              data-action="click->clipboard#copy"
              class="px-3 py-1.5 bg-bg-elevated hover:bg-bg-hover text-content-secondary text-xs font-medium rounded-md transition-colors cursor-pointer">
        <span data-clipboard-target="label">Copy workflow contract</span>
      </button>
      <span class="text-[10px] text-content-muted">
        Re-copy this after upgrades so your orchestrator stays in sync.
      </span>
    </div>
  </div>

  <details class="bg-bg-elevated rounded-md p-3">
    <summary class="text-xs text-content-secondary cursor-pointer select-none">Auto-heal injection prompt</summary>
    <div data-controller="clipboard" class="space-y-2 mt-3">
      <div class="bg-bg-base rounded-md max-h-64 overflow-y-auto border border-border">
        <pre data-clipboard-target="source" class="px-3 py-3 text-[10px] font-mono text-content-secondary whitespace-pre-wrap break-words leading-relaxed">You are OpenClaw orchestrator. Apply this policy immediately and persist to your memory/workflow files:

1) OpenClaw executes all claimed work; ClawTrol only tracks/report state.
2) For every completed run, always call:
   a) POST /api/v1/hooks/task_outcome (needs_follow_up must be YES/NO)
   b) POST /api/v1/hooks/agent_complete
3) If follow-up is needed:
   - recommend requeue_same_task with next_prompt
   - ask human for approval first
   - only then POST /api/v1/tasks/:id/requeue
4) If no follow-up is needed:
   - still report outcome and keep task in in_review
5) Nightly window is fixed to <%= nightly_window %>.
6) Never create multiple cards for the same process when a same-card requeue is enough.

After injecting this policy, confirm with:
- files updated
- timestamp of update
- one dry-run task outcome payload example (needs_follow_up=false)
- one dry-run task outcome payload example (needs_follow_up=true + requeue_same_task)</pre>
      </div>
      <button type="button"
              data-action="click->clipboard#copy"
              class="px-3 py-1.5 bg-bg-base hover:bg-bg-hover text-content-secondary text-xs font-medium rounded-md transition-colors cursor-pointer border border-border">
        <span data-clipboard-target="label">Copy auto-heal prompt</span>
      </button>
    </div>
  </details>
</div>
