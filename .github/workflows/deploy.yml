name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "==> Deploying ClawDeck..."

            # Navigate to app directory
            cd /var/www/clawdeck

            # Pull latest code
            echo "==> Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Load environment variables
            set -a
            source /var/www/clawdeck/.env.production
            set +a

            # Install dependencies
            echo "==> Installing dependencies..."
            bundle install --deployment --without development test

            # Precompile assets
            echo "==> Precompiling assets..."
            RAILS_ENV=production bundle exec rails assets:precompile

            # Create backup directory
            mkdir -p /var/backups/clawdeck

            # Backup main database before migrations
            echo "==> Creating database backup..."
            BACKUP_FILE="/var/backups/clawdeck/backup_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD="$DATABASE_PASSWORD" pg_dump -U clawdeck -h localhost clawdeck_production > "$BACKUP_FILE"

            # Verify backup was created successfully
            if [ ! -s "$BACKUP_FILE" ]; then
              echo "✗ Main database backup file is empty or doesn't exist!"
              exit 1
            fi

            # Check if backup contains SQL-like content (more lenient check)
            if ! head -n 10 "$BACKUP_FILE" | grep -qiE "(PostgreSQL|database|CREATE|INSERT|--)" ; then
              echo "✗ Main database backup file doesn't appear to be valid SQL!"
              echo "First 10 lines of backup file:"
              head -n 10 "$BACKUP_FILE"
              exit 1
            fi

            echo "✓ Main database backup created and verified: $BACKUP_FILE"

            # Backup solid_cache database
            echo "==> Creating cache database backup..."
            CACHE_BACKUP_FILE="/var/backups/clawdeck/backup_cache_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD="$DATABASE_PASSWORD" pg_dump -U clawdeck -h localhost clawdeck_cache_production > "$CACHE_BACKUP_FILE" 2>/dev/null || echo "⚠ Cache database backup skipped (database may not exist)"

            # Backup solid_queue database
            echo "==> Creating queue database backup..."
            QUEUE_BACKUP_FILE="/var/backups/clawdeck/backup_queue_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD="$DATABASE_PASSWORD" pg_dump -U clawdeck -h localhost clawdeck_queue_production > "$QUEUE_BACKUP_FILE" 2>/dev/null || echo "⚠ Queue database backup skipped (database may not exist)"

            # Backup solid_cable database
            echo "==> Creating cable database backup..."
            CABLE_BACKUP_FILE="/var/backups/clawdeck/backup_cable_$(date +%Y%m%d_%H%M%S).sql"
            PGPASSWORD="$DATABASE_PASSWORD" pg_dump -U clawdeck -h localhost clawdeck_cable_production > "$CABLE_BACKUP_FILE" 2>/dev/null || echo "⚠ Cable database backup skipped (database may not exist)"

            # Run migrations with error handling
            echo "==> Running database migrations..."
            if RAILS_ENV=production bundle exec rails db:migrate; then
              echo "✓ Migrations completed successfully"

              # Clean up old backups (keep last 7 days)
              echo "==> Cleaning up old backups..."
              find /var/backups/clawdeck -name "backup_*.sql" -type f -mtime +7 -delete
              REMAINING_BACKUPS=$(ls -1 /var/backups/clawdeck/backup_*.sql 2>/dev/null | wc -l)
              echo "✓ Backup cleanup complete ($REMAINING_BACKUPS backups retained)"
            else
              echo "✗ Migration failed! Rolling back database..."

              # Restore from backup - redirect errors to /dev/null since we expect some
              # objects to already exist (this is normal when restoring over existing schema)
              PGPASSWORD="$DATABASE_PASSWORD" psql -U clawdeck -h localhost -d clawdeck_production -q -f "$BACKUP_FILE" > /dev/null 2>&1 || true

              # Verify restore by checking if we can connect and query
              if PGPASSWORD="$DATABASE_PASSWORD" psql -U clawdeck -h localhost clawdeck_production -c "SELECT COUNT(*) FROM schema_migrations;" > /dev/null 2>&1; then
                echo "✓ Database restored from backup"
              else
                echo "✗ Database restore failed! Manual intervention required."
                echo "Backup file: $BACKUP_FILE"
              fi

              echo "✗ Deployment aborted due to migration failure"
              exit 1
            fi

            # Create log directory if it doesn't exist
            mkdir -p /var/log/clawdeck

            # Restart services
            echo "==> Restarting Puma..."
            systemctl restart puma

            echo "==> Restarting Solid Queue..."
            systemctl restart solid_queue

            # Check if services are running
            sleep 2
            if systemctl is-active --quiet puma; then
              echo "✓ Puma is running"
            else
              echo "✗ Puma failed to start"
              systemctl status puma --no-pager
              exit 1
            fi

            if systemctl is-active --quiet solid_queue; then
              echo "✓ Solid Queue is running"
            else
              echo "✗ Solid Queue failed to start"
              systemctl status solid_queue --no-pager
              exit 1
            fi

            echo "==> Deployment complete!"
